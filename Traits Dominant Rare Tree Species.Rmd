---
title: "Traits Dominant Rare species"
author: "Iris Hordijk"
date: "7/26/2021"
output: html_document
---

###Load packages
```{r Packages}
library(datasets)
library(data.table)
library(readxl)
library(feather)
library(plyr)
library(tidyverse)
library(ggplot2)
library(grid)
library(gridExtra)
library(FD)
library(vegan)
library(ggrepel)
library(Rmisc)
library(mgcv)
library(BIOMASS)
library(stringr)
library(gmodels)
library(relaimpo)
library(writexl)
library(xlsx)
library(dplyr)
```
###Load GFBI data
```{r GFBI Data}
setwd("/Volumes/usys_ibz_cr_lab/")
GFBI <- read_feather("/Volumes/usys_ibz_cr_lab/GFBI_Data/tree_data/GFBI_fixed_plots.feather") #plots: 1184025
```
###Filter Data for 1)plotsize 2)measurement year 3)Forest age 4)Forest biome 5)DBH treshold 
```{r Filter Data}
### 1)Filter plotsize
GFBI$Plotsize <- 1/GFBI$tph
GFBI_Filter_Ps <- GFBI[which(GFBI$Plotsize > 0.02 & GFBI$Plotsize < 2),]
GFBI_Filter_Ps <- as.data.frame(GFBI_Filter_Ps)

#table(is.na(GFBI_Filter_Ps$Plotsize)) #No na values
table(is.infinite(GFBI_Filter_Ps$Plotsize)) #Throw infinite numbers out, as their plotsize is close or equal to zero
GFBI_Filter_PsInf <-GFBI_Filter_Ps[!is.infinite(GFBI_Filter_Ps$Plotsize),]
table(is.infinite(GFBI_Filter_PsInf$Plotsize)) #Check

#unique(GFBI_Filter_PsInf$plot_id) #plots: 1085705
#100-((1085705/1184025)*100) #Percentage of plots filtered out: 8.3%

### 2)Filter measurement year
GFBI_Filter_Yr <- GFBI_Filter_PsInf[which(GFBI_Filter_PsInf$year > 1989),]
#unique(GFBI_Filter_Yr$plot_id) #plots: 857315
#100-((857315/1085705)*100) #Percentage of plots filtered out: 21%

###Select one measurement per plot
GFBI_Filter_YrCheck <- GFBI_Filter_Yr %>% group_by(plot_id) %>% filter(year == max(year))

###3) Filter forest age
#Create coordinates for extraction Biome and Forest age info GEE
GFBI_plot <- GFBI_Filter_YrCheck %>% group_by(plot_id) %>% slice(1)
# TraitsGFBI_coordinates <- subset(GFBI_plot, select=c(lat, lon, plot_id))
# setwd("~/Documents/PhD projects/Traits Dominant Species")
# fwrite(TraitsGFBI_coordinates, file="Trait_coordinates_05-2021.csv") #Create coordinates to export to GEE

rm(GFBI_Filter_Ps, GFBI_Filter_PsInf) #Clean-up workspace

###Import and add GEE information
setwd("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021")
GEE <- list.files("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021") %>% map_df(~fread(.))
GEE <- as.data.frame(GEE)
GFBI_GEE <- left_join(GFBI_plot, GEE, by="plot_id")

setnames(GFBI_GEE, old=c("system:index"), new=c("systemindex"))
GFBI_GEE <- subset(GFBI_GEE, select=-c(.geo, random, systemindex, old_plot_id, Pixel_Lat, Pixel_Long))

GFBI_filter_Age <- subset(GFBI_GEE, GFAD_regrowthForestAge_Mean_downsampled50km > 25 | is.na(GFAD_regrowthForestAge_Mean_downsampled50km)) #Filter Forest age <25 yr uit, while keeping "NA"
#100-((846246/857315)*100) #Percentage of plots filtered out: 1.3%
#(11670/846246)*100 #Percentage old growth forest: 1.4%

###4) Filter forest biomes
GFBI_filter_Biome <- GFBI_filter_Age[which(GFBI_filter_Age$Resolve_Biome < 7), ]

###5) Filter DBH
GFBI_filter_DBH <- GFBI_Filter_YrCheck[which(GFBI_Filter_YrCheck$dbh >= 5), ] #Filter DBH <5cm uit

###Merge filtered plots and tree-level data
GFBI_join_Age <- semi_join(GFBI_filter_DBH, GFBI_filter_Biome, by="plot_id")

###Add biome information
Biome <- subset(GFBI_filter_Biome, select=c(plot_id, Resolve_Biome))
GFBI_Age_Biome <- left_join(GFBI_join_Age, Biome, by="plot_id")

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(GFBI_Age_Biome, file="GFBI_Age_Biome.csv")

rm(GFBI_filter_Age, GFBI_filter_Biome, Biome, GFBI_filter_DBH, GFBI_Filter_Yr, GFBI_plot, GFBI, GEE, GFBI_Filter_Ps, GFBI_GEE, GFBI_join_Age) #remove datasets

###Fig 1 information om temp and AI
GFBI_Age_Biome <- fread("~/Documents/PhD projects/Traits Dominant Species/GFBI_Age_Biome.csv")
Coordinates13092021 <- subset(GFBI_Age_Biome, select=c(lat, lon, plot_id))

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Coordinates13092021, file = "Coordinates13092021.csv")

#Import and add GEE information
setwd("~/Documents/PhD projects/Traits Dominant Species/TraitsEnv_09-2021")
AI <- list.files("~/Documents/PhD projects/Traits Dominant Species/TraitsEnv_09-2021") %>% map_df(~fread(.)) %>% as.data.frame()
AI <- subset(AI, select=c(plot_id, Resolve_Biome, CGIAR_Aridity_Index, CHELSA_BIO_Annual_Mean_Temperature))
AI_Plot <- AI %>% group_by(plot_id) %>% slice(1)
AI_Plot <-  AI_Plot[complete.cases(AI_Plot), ]
AI_Plot$Resolve_Biome <- as.numeric(AI_Plot$Resolve_Biome)
Fig1_Env <- AI_Plot %>% group_by(Resolve_Biome) %>% dplyr::summarise(MeanTemp = (mean(CHELSA_BIO_Annual_Mean_Temperature))/10, MeanAI = (mean(CGIAR_Aridity_Index)*0.0001)) %>% as.data.frame()

```
###Standardise species names & select trees with available trait information
```{r Standardise species names}
###Standardize species names with tree plant list & GBIF
GFBI_Age_Biome <- fread("~/Documents/PhD projects/Traits Dominant Species/GFBI_Age_Biome.csv")
Species_names <- read_feather("/Volumes/usys_ibz_cr_lab/GFBI_Data/tree_data/BEST_MATCH_all_species_TPL.feather")

GFBI_Species <- left_join(GFBI_Age_Biome, Species_names, by="raw_name")
# GFBI_Species_Check <- GFBI_Species %>% group_by(accepted_bin) %>% slice(1)
# dim(GFBI_Species_Check)
# table(GFBI_Species_Check$match_source)
# (916/8264)*100
# 
# GFBI_Genera <- GFBI_Species %>% group_by(tax_genus) %>% slice(1)
# table(GFBI_Genera$match_source)
# dim(GFBI_Genera)
# (379/1863)*100

#Only keep species which are identified up to species level
GFBI_Species <- GFBI_Species[which(GFBI_Species$tax_level == "2"),] # 1.7% of trees is only identified up to genus level #100-(12907085/13133048)*100
setnames(GFBI_Species, old=c("accepted_bin", "Resolve_Biome"), new=c("species_name", "Biome"))
GFBI_Species <- subset(GFBI_Species, select=-c(raw_name, old_plot_id, match_source, tax_genus, tax_species, tax_level))

rm(GFBI_Age_Biome, PlotNr, Species_names)
#Only keep species with trait information available
setwd("~/Desktop")
Traits <- read_feather("~/Desktop/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

#Select complete cases 10 traits
setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44", "trait45",  
                         "trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll", "LeafK", "StomatalConductance",
                 "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN", "RootShootRatio"))

TraitsSelection <- subset(Traits, select=c(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, obs_id))
rm(Traits)

TraitsSelect <- TraitsSelection[complete.cases(TraitsSelection),] #dim(TraitsSelection) #31215811 dim(TraitsSelect) #29938442

ObsID <- as.data.frame(TraitsSelect$obs_id)
setnames(ObsID, old="TraitsSelect$obs_id", new="obs_id")

GFBI_SpeciesCheck <- inner_join(GFBI_Species, ObsID, by="obs_id") #dim(GFBI_SpeciesCheck) #12816859 dim(GFBI_Species) #12907085

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(GFBI_SpeciesCheck, file="GFBI_SpeciesCheck_7-2021.csv")

```

###Identify Dominant and Rare species on biome level
```{r Identify dominant rare species biome level}
GFBI_SpeciesCheck <- fread("~/Documents/PhD projects/Traits Dominant Species/GFBI_SpeciesCheck_7-2021.csv")
unique(GFBI_SpeciesCheck$plot_id) #count plot_id 660552
CountPlotsPerBiome <- GFBI_SpeciesCheck %>% group_by(plot_id) %>% slice(1)
table(CountPlotsPerBiome$Biome)

GFBI_SpeciesCheck$NrInd <- 1 #Add Nr of individuals
Biome_Nr_Sum <- GFBI_SpeciesCheck %>% group_by(Biome) %>% mutate(SumS=n_distinct(species_name), SumInd=sum(NrInd), PercInd=(NrInd/SumInd)*100) #Nr and sum of individuals per species per biome
Biome_Perc <- Biome_Nr_Sum %>% group_by(Biome, species_name) %>% dplyr::mutate(PercSp=sum(PercInd)) #Calculate sum % per species
Biome_Slice <- Biome_Perc %>% group_by(Biome, species_name) %>% slice(1) #Select one individual per species per biome
Biome_Filter <- as.data.frame(Biome_Slice %>% group_by(Biome) %>% filter(any(PercSp <= 10))) #Filter out Biomes percentage rare species higher than 10% (none)

Biome_20Dom <- Biome_Filter %>% group_by(Biome) %>% arrange(desc(PercSp)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
Biome_20Dom$DominanceCategory <- "dominant"
Biome_20Rare <- Biome_Filter %>% group_by(Biome) %>% arrange(desc(PercSp)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
Biome_20Rare$DominanceCategory <- "rare"

Biome_DR <- rbind(Biome_20Dom, Biome_20Rare)
Biome_DR <- as.data.frame(subset(Biome_DR, select = c("Biome", "species_name", "DominanceCategory", "PercSp")))

BiomeDominantRare <- merge(x = Biome_Perc, y = Biome_DR, by = c("Biome", "species_name"), all.x = TRUE)
BiomeDominantRare$DominanceCategory <- replace(BiomeDominantRare$DominanceCategory, is.na(BiomeDominantRare$DominanceCategory), "intermediate")
BiomeDominantRare <- as.data.frame(BiomeDominantRare)
setnames(BiomeDominantRare, old="PercSp.x", new="PercSp")
BiomeDominantRare <- subset(BiomeDominantRare, select = -PercSp.y)

dim(BiomeDominantRare)
table(BiomeDominantRare$DominanceCategory)
unique(BiomeDominantRare$plot_id)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(BiomeDominantRare, file="DominantRare_Biome_8-2021.csv")

rm(list=setdiff(ls(), "BiomeDominantRare"))
```
###Identify Dominant and Rare species on ecoregion level
```{r Identify dominant rare species ecoregion level}
#Load data ecoregions
Select_PlotsFinal <- fread("~/Documents/PhD projects/Traits Dominant Species/Subset_Traits_GFBI.csv")

setwd("~/Documents/PhD projects/Traits Dominant Species/TraitsPET_07-2021")
Ecoregion <- list.files("~/Documents/PhD projects/Traits Dominant Species/TraitsPET_07-2021") %>% map_df(~fread(.))
Ecoregion <- as.data.frame(select(Ecoregion, plot_id, Resolve_Ecoregion))
GFBI_Ecoregion <- left_join(Select_PlotsFinal, Ecoregion, by="plot_id")

setnames(GFBI_Ecoregion, old=c("Resolve_Ecoregion"), new=c("Ecoregion"))

###Select only ecoregions with ta least certain number of plots
GFBI_Ecoregion_Slice <- GFBI_Ecoregion %>% group_by(plot_id) %>% slice(1) #660552 plots
NrPlots <- GFBI_Ecoregion_Slice %>% group_by(Ecoregion) %>% summarise(N=n()) %>% filter(N >= 50) #arrange(N) #select ecoregions with more than 50 obs (78 from 148)
NrPlots <- as.data.frame(NrPlots)

EcoregionSelect <- inner_join(GFBI_Ecoregion, NrPlots, by="Ecoregion")
EcoregionSelectSlice <- EcoregionSelect %>% group_by(plot_id) %>% slice(1) #659763 plots 0.12%

###Identify dominant and rare species on ecoregion level
EcoregionSelect$NrInd <- 1 #Add Nr of individuals
GFBI_Nr_Sum <- EcoregionSelect %>% group_by(Ecoregion) %>% dplyr::mutate(SumS=n_distinct(species_name), SumInd=sum(NrInd), PercInd=(NrInd/SumInd)*100) #Nr & sum of individuals per species per Ecoregion
GFBI_Nr_SumCheck <- GFBI_Nr_Sum %>% group_by(Ecoregion) %>% filter(SumS>=6) #39 ecoregions
GFBI_Perc <- GFBI_Nr_SumCheck %>% group_by(Ecoregion, species_name) %>% dplyr::mutate(PercSp=sum(PercInd)) #Calculate sum % per species
GFBI_Slice <- GFBI_Perc %>% group_by(Ecoregion, species_name) %>% slice(1) #Select one species
GFBI_Filter <- GFBI_Slice %>% dplyr:::group_by(Ecoregion) %>% filter(any(PercSp <= 10)) #Filter out ecoregions percentage rare species higher than 10% (none)

Ecoregion_20 <- GFBI_Filter[which(GFBI_Filter$SumS >= 20),] #700 plots, 0.11%
Ecoregion_6 <- GFBI_Filter[which(GFBI_Filter$SumS < 20 & GFBI_Filter$SumS >= 6),] #144592 plots, 45%

Ecoregion_20Dom <- Ecoregion_20 %>% group_by(Ecoregion) %>% arrange(desc(PercSp)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
Ecoregion_20Dom$DominanceCategory <- "dominant"
Ecoregion_20Rare <- Ecoregion_20 %>% group_by(Ecoregion) %>% arrange(desc(PercSp)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
Ecoregion_20Rare$DominanceCategory <- "rare"

Ecoregion_6Dom <- Ecoregion_6 %>% group_by(Ecoregion) %>% arrange(desc(PercSp)) %>% slice_head(n = 2) #takes top 2 species
Ecoregion_6Dom$DominanceCategory <- "dominant"
Ecoregion_6Rare <- Ecoregion_6 %>% group_by(Ecoregion) %>% arrange(desc(PercSp)) %>% slice_tail(n = 2) #takes bottom 2 species
Ecoregion_6Rare$DominanceCategory <- "rare"

Ecoregion_DR <- rbind(Ecoregion_20Dom, Ecoregion_20Rare, Ecoregion_6Dom, Ecoregion_6Rare)
Ecoregion_DR <- subset(Ecoregion_DR, select = c("Ecoregion", "species_name", "DominanceCategory", "PercSp"))
Ecoregion_DR <- as.data.frame(Ecoregion_DR)

EcoregionDominantRare <- merge(x = GFBI_Perc, y = Ecoregion_DR, by = c("Ecoregion", "species_name"), all.x = TRUE)
EcoregionDominantRare$DominanceCategory <- replace(EcoregionDominantRare$DominanceCategory, is.na(EcoregionDominantRare$DominanceCategory), "intermediate")
EcoregionDominantRare <- as.data.frame(EcoregionDominantRare)
setnames(EcoregionDominantRare, old="PercSp.x", new="PercSp")
EcoregionDominantRare <- subset(EcoregionDominantRare, select = -PercSp.y)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(EcoregionDominantRare, file="DominantRare_Ecoregion_8-2021.csv")

```
###Identify Dominant and Rare species on plot level based on 6 species threshold
```{r Identify Dominant and Rare species on plot level}
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity")
GFBI_SpeciesCheck <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_SpeciesCheck_7-2021.csv") #plots: 1184025

library(stringr)
sum(str_detect(GFBI_SpeciesCheck$species_name, 'Cyathea')) #No tree ferns
sum(str_detect(GFBI_SpeciesCheck$species_name, 'Dicksonia')) #No tree ferns
sum(str_detect(GFBI_SpeciesCheck$species_name, 'Atalea')) #No palms

GFBI_SumS <- as.data.frame(GFBI_SpeciesCheck %>% group_by(plot_id) %>% mutate(SumS=as.numeric(n_distinct(species_name)))) #Sum of species per plot
GFBI_atleast6Sp <- GFBI_SumS[which(GFBI_SumS$SumS >= 6),]

# #Check number of plots per biome with 6 or more species
# GFBI_SumSCheck <- GFBI_SumS %>% group_by(plot_id) %>% slice(1)
# GFBI_SumSCount <- GFBI_SumSCheck %>% group_by(Biome) %>% summarise(Count=n())
# dim(GFBI_SumSCheck)
# 
# GFBI_atleast6SpCheck <- GFBI_atleast6Sp %>% group_by(plot_id) %>% slice(1)
# GFBI_atleast6SpCount <- GFBI_atleast6SpCheck %>% group_by(Biome) %>% summarise(Count=n())
# dim(GFBI_atleast6SpCheck) #22% plots has 6 or more species, especially temperate and boreal forests less plots

###Select subset biomes
Select_Plots <- GFBI_atleast6Sp[which(GFBI_atleast6Sp$Biome < 4 | GFBI_atleast6Sp$Biome == 5 | GFBI_atleast6Sp$Biome == 6),]

Select_PlotsBiome4 <- GFBI_atleast6Sp[which(GFBI_atleast6Sp$Biome == 4),] #Select 10.000 plots within biome 4
Select_PlotsBiome4Subset <- subset(Select_PlotsBiome4, plot_id %in% sample(unique(Select_PlotsBiome4$plot_id), 10000)) 
fwrite(Select_PlotsBiome4Subset, file="PlotsBiome4Subset.csv")

#Select_PlotsBiome4Subset <- fread("~/Documents/PhD projects/Traits Dominant Species/PlotsBiome4Subset.csv")

Select_PlotsFinal <- rbind(Select_Plots, Select_PlotsBiome4Subset)
fwrite(Select_PlotsFinal, file="Subset_Traits_GFBI.csv")

Select_PlotsFinal$NrInd <- 1 #Add Nr of individuals
GFBI_Plot <- Select_PlotsFinal %>% group_by(plot_id) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                                                                                PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) #Nr of Species, Nr Ind perc and sum per plot
GFBI_Plot <- as.data.frame(GFBI_Plot)

GFBI_MeanInd <- GFBI_Plot %>% group_by(plot_id, species_name) %>% summarise(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) 
GFBI_MeanInd <- as.data.frame(GFBI_MeanInd)

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots with percentage higher than 10%

# GFBI_PlotSlice <- GFBI_Plot %>% group_by(plot_id) %>% slice(1) #1:2503 #2:1720 #3:182 #4:509506 #5:90000 #6:57684
# GFBI_MeanIndFilterSlice <- GFBI_MeanIndFilter %>% group_by(plot_id) %>% slice(1) #1:2051 #2:1157 #3:92 #4:265125 #5:43242 #6:12934 ###49% of dataset

GFBI_Div20 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 20),] #700 plots, 0.11%
GFBI_Div6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS < 20 & GFBI_MeanIndFilter$SumS >= 6),] #144592 plots, 45%
GFBI_Div5 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS < 6),] #179309 plots, 55% plots less than 6 species #Erased plots by biome, 1:459 2:200 3:275 4:536070 5:120705 6:39393 
GFBI_DivMore6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 6),] #145292 plots, 45% plots 6 or more species. Nr of plots by biome 1:1930   2:1110 3:20 4:131737 5:8931 6:1564

GFBI_Div20Dom <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
GFBI_Div20Dom$DominanceCategory <- "dominant"

GFBI_Div20Rare <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
GFBI_Div20Rare$DominanceCategory <- "rare"

GFBI_Div6Dom <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(n = 2) #takes top 2 species
GFBI_Div6Dom$DominanceCategory <- "dominant"

GFBI_Div6Rare <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(n = 2) #takes bottom 2 species
GFBI_Div6Rare$DominanceCategory <- "rare"

GFBI_DivDR <- rbind(GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6Dom, GFBI_Div6Rare)
GFBI_DivDR <- subset(GFBI_DivDR, select = c("plot_id", "species_name", "DominanceCategory", "PercPerSpecies"))
GFBI_DivDR <- as.data.frame(GFBI_DivDR)

GFBI_PlotMore6 <- GFBI_Plot[which(GFBI_Plot$SumS >= 6),]
PlotDominantRare <- merge(x = GFBI_PlotMore6, y = GFBI_DivDR, by = c("plot_id", "species_name"), all.x = TRUE)
PlotDominantRare$DominanceCategory <- replace(PlotDominantRare$DominanceCategory, is.na(PlotDominantRare$DominanceCategory), "intermediate")
PlotDominantRare <- as.data.frame(PlotDominantRare)

fwrite(PlotDominantRare, file="DominantRare_Plot_8-2021.csv")
DominantRareSp_plotlevel <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")
GFBI_PlotSlice <- DominantRareSp_plotlevel %>% group_by(plot_id) %>% slice(1) #1:1826 #2:1174 #3:20 #4:10000 #5:9060 #6:1733

###Relationship between nr dominant species/nr rare species and plotsize
NrDomRare <- DominantRareSp_plotlevel %>% group_by(plot_id, DominanceCategory) %>% dplyr::mutate(Count=n_distinct(species_name))
NrDomRarePlot <- NrDomRare %>% group_by(plot_id, DominanceCategory) %>% slice(1)

NrDomPlot <- NrDomRarePlot[which(NrDomRarePlot$DominanceCategory=='dominant'),] 
NrRarePlot <- NrDomRarePlot[which(NrDomRarePlot$DominanceCategory=='rare'),] 

cor.test(NrDomPlot$Count, NrDomPlot$Plotsize, method = "spearman")
cor.test(NrRarePlot$Count, NrRarePlot$Plotsize, method = "spearman")

ggplot(NrDomPlot, aes(x=Plotsize, y=log(Sum))) + geom_point()
ggplot(NrRarePlot, aes(x=Plotsize, y=log(Sum))) + geom_point()

```
###Identify Dominant and Rare species on plot level based on percentage threshold
```{r Identify Dominant and Rare species on plot level}
rm()
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity")
GFBI_SpeciesCheck <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_SpeciesCheck_7-2021.csv") #plots: 1184025

# library(stringr)
# sum(str_detect(GFBI_SpeciesCheck$species_name, 'Cyathea')) #No tree ferns
# sum(str_detect(GFBI_SpeciesCheck$species_name, 'Dicksonia')) #No tree ferns
# sum(str_detect(GFBI_SpeciesCheck$species_name, 'Atalea')) #No palms

GFBI_SumS <- as.data.frame(GFBI_SpeciesCheck %>% group_by(plot_id) %>% mutate(SumS=as.numeric(n_distinct(species_name)))) #Sum of species per plot
GFBI_atleast2Sp <- GFBI_SumS[which(GFBI_SumS$SumS >= 2),] #Erase monocultures

###Select plots with distinct dominant and rare species 
GFBI_atleast2Sp$NrInd <- 1 #Add Nr of individuals
GFBI_Plot <- GFBI_atleast2Sp %>% group_by(Biome, plot_id) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                        PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>%
  slice(1) %>% as.data.frame()

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_MeanIndSum <- GFBI_MeanIndFilter %>% group_by(Biome, plot_id) %>% arrange(PercPerSpecies) %>% mutate(PercSpecies_cumsum = cumsum(PercPerSpecies)) %>% as.data.frame()

GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum <= 10, "rare", "intermediate")
GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum >= 90, "dominant", GFBI_MeanIndSum$DominanceCategory)                                                           
GFBI_DominanceCategory <- GFBI_MeanIndSum %>% group_by(Biome, plot_id) %>% filter(any(DominanceCategory == "dominant"))  

#Check <- GFBI_MeanIndSum %>% filter(plot_id == "p1184805")

###Select subset biomes 4, 5 and 6
Select_Plots <- GFBI_DominanceCategory[which(GFBI_DominanceCategory$Biome== 4 | GFBI_DominanceCategory$Biome == 5 | GFBI_DominanceCategory$Biome == 6),]
Select_Plots_filter <- Select_Plots %>% group_by(Biome) %>% slice_sample(n=10000)

fwrite(Select_Plots_filter, file="SubsetPlotsBiome4to6.csv")
#Select_PlotsBiome4Subset <- fread("~/Documents/PhD projects/Traits Dominant Species/PlotsBiome4Subset.csv")
  
Select_Plots_all <- GFBI_DominanceCategory[which(GFBI_DominanceCategory$Biome < 4),]
Select_PlotsFinal <- rbind(Select_Plots_all, Select_Plots_filter)
Select_PlotsFinal <- as.data.frame(Select_PlotsFinal)

fwrite(Select_PlotsFinal, file="DominantRare_Plot_5-2024.csv")
DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_5-2024.csv")

```
###Fig. 1
```{r Figure 1}
Biome_TraitsScaled <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Biome_TraitsScaledGlobally_8-2021.csv")
Biome_TraitsScaled <- subset(Biome_TraitsScaled, select=c(Biome, species_name, DominanceCategory, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))

Biome_TraitsDRScaled <- Biome_TraitsScaled[which(Biome_TraitsScaled$DominanceCategory == "rare" | Biome_TraitsScaled$DominanceCategory == "dominant"),]

Biome_TraitsDRCheck <- Biome_TraitsDRScaled %>% group_by(Biome, species_name) %>% count(DominanceCategory, sort = TRUE)

library(writexl)
write_xlsx(Biome_TraitsDRCheck, "Sp_Biomes.xlsx")
```

###Fig. 2 
```{r PCA traits}
###Match species with trait data
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))
rm(Traits)

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")

DominantRare_Plot$genus <- word(DominantRare_Plot$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(DominantRare_Plot$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

DominantRare_Plot$GymnoAngiosperm <- family$sperms

Plot_SpTraits <- left_join(DominantRare_Plot, Traits_Select, by="obs_id")
rm(DominantRare_Plot, Traits_Select)

###Log transform and scale traits 
Plot_SpTraitsCompl <- Plot_SpTraits[complete.cases(Plot_SpTraits),] #Only PercPerSpecies has NA values

Plot_SpTraitsLog <- Plot_SpTraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% dplyr::summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))

Plot_TraitsScaled <- Plot_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values by Biome or globally group_by(Biome) %>% 

rm(Plot_SpTraits, Plot_SpTraitsCompl, Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

#########Add Temperature and Aridity
#Import and add GEE information
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CGIAR_Aridity_Index"), new=c("Temperature", "Humidity"))

Plot_TraitsEnv <- left_join(Plot_TraitsScaled, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

###Scaling of variables
Plot_TraitsEnv <- as.data.frame(Plot_TraitsEnv)
Plot_TraitsEnv$Temperature <- Plot_TraitsEnv$Temperature/10
Plot_TraitsEnv$Humidity <- Plot_TraitsEnv$Humidity*0.0001
Plot_TraitsEnv <- Plot_TraitsEnv[which(Plot_TraitsEnv$Humidity <= 4),] #69 plots removed
Plot_TraitsEnv <- Plot_TraitsEnv %>% dplyr::rename(Gymnosperm=GymnoAngiosperm)
Plot_TraitsEnv$Gymnosperm <- ifelse(Plot_TraitsEnv$Gymnosperm == "gymnosperm", 1, 0)
Plot_TraitsEnv <- Plot_TraitsEnv[complete.cases(Plot_TraitsEnv$Gymnosperm),]    

#########Create PCA
names(Plot_TraitsEnv)
Plot_TraitsDomRare <- Plot_TraitsEnv[which(Plot_TraitsEnv$DominanceCategory=="dominant" | Plot_TraitsEnv$DominanceCategory=="rare"),]
Plot_Traits_PCA <- Plot_TraitsDomRare %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Temperature, Humidity, Gymnosperm) 

setnames(Plot_Traits_PCA, old = c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass", "Humidity"), 
         new = c("Height", "Crown diameter", "Bark thickness", "Wood density", "SLA", "Leaf N", "Leaf NP", "Stem conduit diameter", "Root depth", "Seed mass", "Water availability"))

pca_Traits <- prcomp(Plot_Traits_PCA, scale. = TRUE)

barplot(pca_Traits$rotation[,1], main="PC 1 Loadings Plot", las=2) #PCA statistics
barplot(pca_Traits$rotation[,2], main="PC 2 Loadings Plot", las=2)
barplot(pca_Traits$rotation[,3], main="PC 3 Loadings Plot", las=2)
barplot(pca_Traits$rotation[,4], main="PC 4 Loadings Plot", las=2)

pca.df_Traits <- data.frame(pca1 = pca_Traits$x[,1], pca2 = pca_Traits$x[,2]*-1, DominanceCategory = Plot_TraitsDomRare$DominanceCategory, Biome=Plot_TraitsDomRare$Biome)
pca.df_Traits2 <- data.frame(pca1 = pca_Traits$rotation[,1], pca2 = pca_Traits$rotation[,2]*-1,  labels = row.names(pca_Traits$rotation)) #, sig = pca_Traits$sig, #col=pca_Traits$col,
pca.df_Traits2$col <- c("#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#58038c", "#9e7306", "#1c6915")

fwrite(pca.df_Traits, file="pca.df_Traits.csv") #Write data file to reproduce figure
fwrite(pca.df_Traits2, file="pca.df_Traits2.csv") #Write data file to reproduce figure

#stat_ellipse(aes(group=factor(pca.df_Traits$DominanceCategory), color=factor(pca.df_Traits$DominanceCategory)), level = 0.68) + #, "deepskyblue", "blue1" #,"Dominant", "Rare"
Graph_pca_Traits <- ggplot(data=pca.df_Traits, aes(x=pca1, y=pca2)) + geom_point(aes(color = factor(pca.df_Traits$Biome), shape=factor(pca.df_Traits$DominanceCategory)), size = 4, alpha = 0.3) +  scale_color_manual(values = c("#ffdd03", "#8fd613", "#3f5220", "#0281a8", "#00549e", "#270169"), labels = c("Tropical moist", "Tropical dry", "Tropical conifer", "Temperate", "Temperate Conifer", "Boreal")) + 
  labs(x = "PCA 1 (41%)", y= "PCA 2 (25%)") + ggtitle("Traits dominant and rare tree species") + theme_bw() + labs(colour="Forest") + 
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
          legend.title=element_text(size=12, face="bold"),
          legend.text=element_text(size=12),
          axis.text.x = element_text(family="sans", size = 16, color = "black"),
          axis.text.y = element_text(family="sans", size = 16, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  geom_segment(data=pca.df_Traits2,aes(x=0, xend=pca1*8,y=0,yend=pca2*8), arrow = arrow(length = unit(0.5, "cm")), alpha = 1, colour=pca.df_Traits2$col, size=1.5) +    geom_text_repel(data=pca.df_Traits2,aes(x=8.5*pca1,y=9*pca2, label =labels), size=6, fontface="bold")

###Extract first and second axis PCA
Plot_TraitsDomRare$pca1 <- pca.df_Traits$pca1+abs(min(pca.df_Traits$pca1))
Plot_TraitsDomRare$pca2 <- pca.df_Traits$pca2+abs(min(pca.df_Traits$pca2))

###Relationships
Plot_Traits_PCA <- as.data.frame(Plot_Traits_PCA)

Plot_Traits_PCA$Temperature <- as.numeric(Plot_Traits_PCA$Temperature)
Plot_Traits_PCA$"Root depth" <- as.numeric(Plot_Traits_PCA$"Root depth")
cor.test(Plot_Traits_PCA$Temperature, Plot_Traits_PCA$"Root depth", method = "pearson")

cor.test(Plot_Traits_PCA$Humidity, Plot_Traits_PCA$Height, method = "spearman")
cor.test(Plot_Traits_PCA$"Water availability", Plot_Traits_PCA$"Bark thickness", method = "pearson")
cor.test(Plot_Traits_PCA$Temperature, Plot_Traits_PCA$"Bark thickness", method = "pearson")


```
###Fig. 2 Species level (for SI)
```{r PCA traits}
###Match species with trait data
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))
rm(Traits)

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")

DominantRare_Plot$genus <- word(DominantRare_Plot$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(DominantRare_Plot$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

DominantRare_Plot$GymnoAngiosperm <- family$sperms

Plot_SpTraits <- left_join(DominantRare_Plot, Traits_Select, by="obs_id")
rm(DominantRare_Plot, Traits_Select)

###Log transform and scale traits 
Plot_SpTraitsCompl <- Plot_SpTraits[complete.cases(Plot_SpTraits),] #Only PercPerSpecies has NA values

Plot_SpTraitsLog <- Plot_SpTraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% dplyr::summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))

Plot_TraitsScaled <- Plot_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values by Biome or globally group_by(Biome) %>% 

rm(Plot_SpTraits, Plot_SpTraitsCompl, Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

#########Add Temperature and Aridity
#Import and add GEE information
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CGIAR_Aridity_Index"), new=c("Temperature", "Humidity"))

Plot_TraitsEnv <- left_join(Plot_TraitsScaled, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

###Scaling of variables
Plot_TraitsEnv <- as.data.frame(Plot_TraitsEnv)
Plot_TraitsEnv$Temperature <- Plot_TraitsEnv$Temperature/10
Plot_TraitsEnv$Humidity <- Plot_TraitsEnv$Humidity*0.0001
Plot_TraitsEnv <- Plot_TraitsEnv[which(Plot_TraitsEnv$Humidity <= 4),] #69 plots removed
Plot_TraitsEnv <- Plot_TraitsEnv %>% dplyr::rename(Gymnosperm=GymnoAngiosperm)
Plot_TraitsEnv$Gymnosperm <- ifelse(Plot_TraitsEnv$Gymnosperm == "gymnosperm", 1, 0)
Plot_TraitsEnv <- Plot_TraitsEnv[complete.cases(Plot_TraitsEnv$Gymnosperm),]    

#########Create PCA
names(Plot_TraitsEnv)
Plot_TraitsDomRare <- Plot_TraitsEnv[which(Plot_TraitsEnv$DominanceCategory=="dominant" | Plot_TraitsEnv$DominanceCategory=="rare"),]
Plot_TraitsDomRareMean <- Plot_TraitsDomRare %>% group_by(Biome, Gymnosperm, DominanceCategory, species_name) %>% summarise(across(Height:Humidity, mean)) %>% ungroup()
Plot_Traits_PCA <- Plot_TraitsDomRareMean %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Temperature, Humidity, Gymnosperm) %>% as.data.frame()

setnames(Plot_Traits_PCA, old = c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass"), 
         new = c("Height", "Crown diameter", "Bark thickness", "Wood density", "SLA", "Leaf N", "Leaf NP", "Stem conduit diameter", "Root depth", "Seed mass"))

pca_Traits <- prcomp(Plot_Traits_PCA, scale. = TRUE)

barplot(pca_Traits$rotation[,1], main="PC 1 Loadings Plot", las=2) #PCA statistics
barplot(pca_Traits$rotation[,2], main="PC 2 Loadings Plot", las=2)

pca.df_Traits <- data.frame(pca1 = pca_Traits$x[,1], pca2 = pca_Traits$x[,2], DominanceCategory = Plot_TraitsDomRareMean$DominanceCategory, Biome=Plot_TraitsDomRareMean$Biome, DominanceBiome = paste(Plot_TraitsDomRareMean$DominanceCategory, Plot_TraitsDomRareMean$Biome))
pca.df_Traits2 <- data.frame(pca1 = pca_Traits$rotation[,1], pca2 = pca_Traits$rotation[,2],  labels = row.names(pca_Traits$rotation)) #, sig = pca_Traits$sig, #col=pca_Traits$col,
pca.df_Traits2$col <- c("#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#58038c", "#9e7306", "#1c6915")


Graph_FigS3A <- ggplot(data=pca.df_Traits, aes(x=pca1, y=pca2)) + geom_point(aes(color = factor(Biome), shape=factor(DominanceCategory)), size = 4, alpha = 0.2) +  scale_color_manual(values = c("#ffdd03", "#8fd613", "#3f5220", "#0281a8", "#00549e", "#270169"), labels = c("Tropical moist", "Tropical dry", "Tropical conifer", "Temperate", "Temperate Conifer", "Boreal")) + 
  labs(x = "PCA 1 (34%)", y= "PCA 2 (20%)") + ggtitle("Traits dominant and rare tree species on species level") + theme_bw() + labs(colour="Forest") + 
  stat_ellipse(aes(group=factor(DominanceBiome), linetype=DominanceCategory), level = 0.68) + #dominant=solid, rare=dashed
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
          legend.title=element_text(size=12, face="bold"),
          legend.text=element_text(size=12),
          axis.text.x = element_text(family="sans", size = 16, color = "black"),
          axis.text.y = element_text(family="sans", size = 16, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  geom_segment(data=pca.df_Traits2,aes(x=0, xend=pca1*8,y=0,yend=pca2*8), arrow = arrow(length = unit(0.5, "cm")), alpha = 1, colour=pca.df_Traits2$col, size=1.5) +    geom_text_repel(data=pca.df_Traits2,aes(x=8.5*pca1,y=9*pca2, label =labels), size=6, fontface="bold")

```
###Fig. 2 Perc (Fig in SI)
```{r PCA traits Perc}
###Match species with trait data
rm()
#mem.maxVSize()

Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))
rm(Traits)

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_5-2024.csv")

DominantRare_Plot$genus <- word(DominantRare_Plot$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(DominantRare_Plot$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

DominantRare_Plot$GymnoAngiosperm <- family$sperms

Plot_SpTraits <- left_join(DominantRare_Plot, Traits_Select, by="obs_id")
rm(DominantRare_Plot, Traits_Select)

###Log transform and scale traits 
Plot_SpTraitsCompl <- Plot_SpTraits[complete.cases(Plot_SpTraits),]#Only PercPerSpecies has NA values

Plot_SpTraitsLog <- Plot_SpTraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% dplyr::summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))

Plot_TraitsScaled <- Plot_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), ~ (. - mean(.)) / sd(.)) %>% as.data.frame() #Standardise trait values by Biome or globally group_by(Biome) %>% 

rm(Plot_SpTraits, Plot_SpTraitsCompl, Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

#########Add Temperature and Aridity
#Import and add GEE information
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CGIAR_Aridity_Index"), new=c("Temperature", "Humidity"))

Plot_TraitsScaled$plot_id <- as.character(Plot_TraitsScaled$plot_id)
Plot_TraitsEnv <- left_join(Plot_TraitsScaled, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

###Scaling of variables
Plot_TraitsEnv <- as.data.frame(Plot_TraitsEnv)
Plot_TraitsEnv$Temperature <- Plot_TraitsEnv$Temperature/10
Plot_TraitsEnv$Humidity <- Plot_TraitsEnv$Humidity*0.0001
Plot_TraitsEnv <- Plot_TraitsEnv[which(Plot_TraitsEnv$Humidity <= 4),] #69 plots removed
Plot_TraitsEnv <- Plot_TraitsEnv %>% dplyr::rename(Gymnosperm=GymnoAngiosperm)
Plot_TraitsEnv$Gymnosperm <- ifelse(Plot_TraitsEnv$Gymnosperm == "gymnosperm", 1, 0)
Plot_TraitsEnv <- Plot_TraitsEnv[complete.cases(Plot_TraitsEnv$Gymnosperm),]    

#########Create PCA
names(Plot_TraitsEnv)
Plot_TraitsDomRare <- Plot_TraitsEnv[which(Plot_TraitsEnv$DominanceCategory=="dominant" | Plot_TraitsEnv$DominanceCategory=="rare"),]
Plot_Traits_PCA <- Plot_TraitsDomRare %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Temperature, Humidity, Gymnosperm) 

setnames(Plot_Traits_PCA, old = c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass"), 
         new = c("Height", "Crown diameter", "Bark thickness", "Wood density", "SLA", "Leaf N", "Leaf NP", "Stem conduit diameter", "Root depth", "Seed mass"))

pca_Traits <- prcomp(Plot_Traits_PCA, scale. = TRUE)

barplot(pca_Traits$rotation[,1], main="PC 1 Loadings Plot", las=2) #PCA statistics
barplot(pca_Traits$rotation[,2], main="PC 2 Loadings Plot", las=2)

pca.df_Traits <- data.frame(pca1 = pca_Traits$x[,1], pca2 = pca_Traits$x[,2], DominanceCategory = Plot_TraitsDomRare$DominanceCategory, Biome=Plot_TraitsDomRare$Biome, DominanceBiome = paste(Plot_TraitsDomRare$DominanceCategory, Plot_TraitsDomRare$Biome))
pca.df_Traits2 <- data.frame(pca1 = pca_Traits$rotation[,1], pca2 = pca_Traits$rotation[,2],  labels = row.names(pca_Traits$rotation)) #, sig = pca_Traits$sig, #col=pca_Traits$col,
pca.df_Traits2$col <- c("#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#050505", "#58038c", "#9e7306", "#1c6915")

#stat_ellipse(aes(group=factor(pca.df_Traits$DominanceCategory), color=factor(pca.df_Traits$DominanceCategory)), level = 0.68) + #, "deepskyblue", "blue1" #,"Dominant", "Rare"
Graph_FigS3B <- ggplot(data=pca.df_Traits, aes(x=pca1, y=pca2)) + geom_point(aes(color = factor(pca.df_Traits$Biome), shape=factor(pca.df_Traits$DominanceCategory)), size = 4, alpha = 0.2) +  scale_color_manual(values = c("#ffdd03", "#8fd613", "#3f5220", "#0281a8", "#00549e", "#270169"), labels = c("Tropical moist", "Tropical dry", "Tropical conifer", "Temperate", "Temperate Conifer", "Boreal")) + 
  labs(x = "PCA 1 (43%)", y= "PCA 2 (18%)") + ggtitle("Traits dominant and rare tree species") + theme_bw() + labs(colour="Forest") + 
  stat_ellipse(aes(group=factor(DominanceBiome), linetype=DominanceCategory), level = 0.68) + #dominant=solid, rare=dashed
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
          legend.title=element_text(size=12, face="bold"),
          legend.text=element_text(size=12),
          axis.text.x = element_text(family="sans", size = 16, color = "black"),
          axis.text.y = element_text(family="sans", size = 16, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  geom_segment(data=pca.df_Traits2,aes(x=0, xend=pca1*8,y=0,yend=pca2*8), arrow = arrow(length = unit(0.5, "cm")), alpha = 1, colour=pca.df_Traits2$col, size=1.5) +    geom_text_repel(data=pca.df_Traits2,aes(x=8.5*pca1,y=9*pca2, label =labels), size=6, fontface="bold")

grid.arrange(Graph_FigS3A, Graph_FigS3B, nrow=1)

###Extract first and second axis PCA
Plot_TraitsDomRare$pca1 <- pca.df_Traits$pca1+4.317436 #min(pca.df_Traits$pca1)
Plot_TraitsDomRare$pca2 <- pca.df_Traits$pca2+4.592771 #min(pca.df_Traits$pca2)

###Relationships
Plot_Traits_PCA <- as.data.frame(Plot_Traits_PCA)

Plot_Traits_PCA$Temperature <- as.numeric(Plot_Traits_PCA$Temperature)
Plot_Traits_PCA$"Root depth" <- as.numeric(Plot_Traits_PCA$"Root depth")
cor.test(Plot_Traits_PCA$Temperature, Plot_Traits_PCA$"Root depth", method = "pearson")

cor.test(Plot_Traits_PCA$Humidity, Plot_Traits_PCA$Height, method = "spearman")
cor.test(Plot_Traits_PCA$Humidity, Plot_Traits_PCA$"Bark thickness", method = "pearson")


```
###Fig. 3 Perc
```{r Boxplots}

####Calculate percentage gymnosperm individuals per plot
DominantRare_Plot_select <- DominantRare_Plot[complete.cases(DominantRare_Plot$species_name),] #Select only identified trees
DominantRare_Plot_CountGymno <- as.data.frame(DominantRare_Plot_select %>% group_by(plot_id, DominanceCategory) %>% dplyr::count(GymnoAngiosperm)) #Sum of individuals per plot
DominantRare_CountGymno <- DominantRare_Plot_CountGymno[which(DominantRare_Plot_CountGymno$GymnoAngiosperm=="gymnosperm"),]
DominantRare_CountGymno <- DominantRare_CountGymno %>% dplyr::rename("Gymnosperm" = n) %>% dplyr::select(-GymnoAngiosperm)  %>% as.data.frame() 

Plots_DominantRare_PercInd <- DominantRare_Plot %>% group_by(plot_id, DominanceCategory) %>% dplyr::mutate(., NrIndCategory = sum(n())) %>% slice(1)
Plots_DominantRare_Plot <- Plots_DominantRare_PercInd %>% dplyr::select(plot_id, DominanceCategory, NrIndCategory)

DominantRare_Gymno <- left_join(Plots_DominantRare_Plot, DominantRare_CountGymno)
DominantRare_Gymno$Gymnosperm[is.na(DominantRare_Gymno$Gymnosperm)] <- 0
DominantRare_Gymno_perc <- as.data.frame(DominantRare_Gymno %>% group_by(plot_id, DominanceCategory) %>% mutate(PercInd_gymnosperm=(Gymnosperm/NrIndCategory)*100))
DominantRare_Gymno_perc <- DominantRare_Gymno_perc %>% dplyr::select(plot_id, DominanceCategory, PercInd_gymnosperm)

DominantRare_Gymno_DomRare <- DominantRare_Gymno_perc[which(DominantRare_Gymno_perc$DominanceCategory=="dominant" | DominantRare_Gymno_perc$DominanceCategory=="rare"), ]

###Difference between CWM dominant and rare species traits
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame()

Plot_TraitsDRScaled <- left_join(Plot_TraitsDRScaled, DominantRare_Gymno_DomRare)

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

TraitsDiffMean <- as.data.frame(DiffDomRare_CWM %>% group_by(Biome) %>% dplyr::summarise(n = n(), MeanHeight=mean(Height), seHeight=(sd(Height)/sqrt(n)),lowCIHeight = ci(Height)[2], hiCIHeight = ci(Height)[3], MeanCrownDiameter=mean(CrownDiameter), seCrownDiameter=(sd(CrownDiameter)/sqrt(n)), lowCICrownDiameter = ci(CrownDiameter)[2], hiCICrownDiameter = ci(CrownDiameter)[3], MeanBarkThickness=mean(BarkThickness), seBarkThickness=(sd(BarkThickness)/sqrt(n)), lowCIBarkThickness = ci(BarkThickness)[2], hiCIBarkThickness = ci(BarkThickness)[3], MeanWoodDensity=mean(WoodDensity), seWoodDensity=(sd(WoodDensity)/sqrt(n)), lowCIWoodDensity = ci(WoodDensity)[2], hiCIWoodDensity = ci(WoodDensity)[3], MeanSLA=mean(SLA), seSLA=(sd(SLA)/sqrt(n)), lowCISLA = ci(SLA)[2], hiCISLA = ci(SLA)[3], MeanLeafN=mean(LeafN), seLeafN=(sd(LeafN)/sqrt(n)), lowCILeafN = ci(LeafN)[2], hiCILeafN = ci(LeafN)[3], MeanLeafNP=mean(LeafNP), seLeafNP=(sd(LeafNP)/sqrt(n)), lowCILeafNP = ci(LeafNP)[2], hiCILeafNP = ci(LeafNP)[3], MeanStemConduitD=mean(StemConduitDiameter), seStemConduitD=(sd(StemConduitDiameter)/sqrt(n)), lowCIStemConduitD = ci(StemConduitDiameter)[2], hiCIStemConduitD = ci(StemConduitDiameter)[3], MeanRootDepth=mean(RootDepth), seRootDepth=(sd(RootDepth)/sqrt(n)), lowCIRootDepth = ci(RootDepth)[2], hiCIRootDepth = ci(RootDepth)[3], MeanSeedMass=mean(SeedMass), seSeedMass=(sd(SeedMass)/sqrt(n)), lowCISeedMass = ci(SeedMass)[2], hiCISeedMass = ci(SeedMass)[3], MeanPercInd_gymnosperm=mean(PercInd_gymnosperm), sePercInd_gymnosperm=(sd(PercInd_gymnosperm)/sqrt(n)), lowCIPercInd_gymnosperm = ci(PercInd_gymnosperm)[2], hiCIPercInd_gymnosperm = ci(PercInd_gymnosperm)[3], Meanpca1=mean(pca1), sepca1=(sd(pca1)/sqrt(n)), lowCIpca1 = ci(pca1)[2], hiCIpca1 = ci(pca1)[3], Meanpca2=mean(pca2), sepca2=(sd(pca2)/sqrt(n)), lowCIpca2 = ci(pca2)[2], hiCIpca2 = ci(pca2)[3]))

###Calculate mean differences per biome
TraitsDiffMean_select <- TraitsDiffMean %>% dplyr::select(Biome, starts_with("Mean")) %>% dplyr::select(-MeanPercInd_gymnosperm, -Meanpca1, -Meanpca2)
TraitsDifferencesBiome <- TraitsDiffMean_select %>% rowwise() %>% mutate(mean = mean(abs(c_across(starts_with("Mean")))), na.rm = TRUE) %>% ungroup()

###Statistics
Plot_TraitsDRScaled$DominanceCategory <- ifelse(Plot_TraitsDRScaled$DominanceCategory == "dominant", "2", "1") #2=dominant, 1=rare
Plot_TraitsDRScaled$DominanceCategory <- as.numeric(Plot_TraitsDRScaled$DominanceCategory)

Results_Wilcoxon <- as.data.frame(Plot_TraitsDRScaled %>% group_by(Biome) %>% dplyr::summarise(Pvalue_Height = wilcox.test(Height ~ DominanceCategory)$p.value,
                                                             Pvalue_CrownDiameter = wilcox.test(CrownDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_BarkThickness = wilcox.test(BarkThickness ~ DominanceCategory)$p.value,
                                                             Pvalue_WoodDensity = wilcox.test(WoodDensity ~ DominanceCategory)$p.value,
                                                             Pvalue_SLA = wilcox.test(SLA ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafN = wilcox.test(LeafN ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafNP = wilcox.test(LeafNP ~ DominanceCategory)$p.value,
                                                             Pvalue_StemConduitDiameter = wilcox.test(StemConduitDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_RootDepth = wilcox.test(RootDepth ~ DominanceCategory)$p.value,
                                                             Pvalue_SeedMass = wilcox.test(SeedMass ~ DominanceCategory)$p.value,
                                                             Pvalue_Gymnosperm = wilcox.test(PercInd_gymnosperm ~ DominanceCategory)$p.value,
                                                             Pvalue_pca1 = wilcox.test(pca1 ~ DominanceCategory)$p.value,
                                                             Pvalue_pca2 = wilcox.test(pca2 ~ DominanceCategory)$p.value))

Results_Wilcoxon_nr <- Results_Wilcoxon %>% dplyr::mutate(across(c(2:14), ~ifelse(. <= 0.05, 1, 0)))

# #Test assumptions t-test: all not normally distributed
# Biome1 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==1),]
# Biome2 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==2),]
# Biome4 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==4),]
# Biome4_subset <- Biome4 %>% sample_n(5000)
# Biome5 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==5),]
# Biome5_subset <- Biome5 %>% sample_n(5000)
# Biome6 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==6),]
# 
# DiffDomRare_Biome <- rbind(Biome1, Biome2, Biome4_subset, Biome5_subset, Biome6)
# 
# Test <- DiffDomRare_Biome %>% group_by(Biome) %>% dplyr::summarise(Pvalue_Height = shapiro.test(Height)$p.value, #p higher than 0.05 -> t-test is applicable
#                                                                    Pvalue_CrownDiameter = shapiro.test(CrownDiameter)$p.value,
#                                                                    Pvalue_BarkThickness = shapiro.test(BarkThickness)$p.value,
#                                                                    Pvalue_WoodDensity = shapiro.test(WoodDensity)$p.value,
#                                                                    Pvalue_SLA = shapiro.test(SLA)$p.value,
#                                                                    Pvalue_LeafN = shapiro.test(LeafN)$p.value,
#                                                                    Pvalue_LeafNP = shapiro.test(LeafNP)$p.value,
#                                                                    Pvalue_StemConduitDiameter = shapiro.test(StemConduitDiameter)$p.value,
#                                                                    Pvalue_RootDepth = shapiro.test(RootDepth)$p.value,
#                                                                    Pvalue_SeedMass = shapiro.test(SeedMass)$p.value,
#                                                                    Pvalue_PercInd_gymnosperm = shapiro.test(PercInd_gymnosperm)$p.value,
#                                                                    Pvalue_pca1 = shapiro.test(pca1)$p.value,
#                                                                    Pvalue_pca2 = shapiro.test(pca2)$p.value)
# 
# Results_Ttest <- as.data.frame(Plot_TraitsDRScaled %>% group_by(Biome) %>% summarise(Pvalue_Height = t.test(Height ~ DominanceCategory)$p.value,
#                                                              Pvalue_CrownDiameter = t.test(CrownDiameter ~ DominanceCategory)$p.value,
#                                                              Pvalue_BarkThickness = t.test(BarkThickness ~ DominanceCategory)$p.value,
#                                                              Pvalue_WoodDensity = t.test(WoodDensity ~ DominanceCategory)$p.value,
#                                                              Pvalue_SLA = t.test(SLA ~ DominanceCategory)$p.value,
#                                                              Pvalue_LeafN = t.test(LeafN ~ DominanceCategory)$p.value,
#                                                              Pvalue_LeafNP = t.test(LeafNP ~ DominanceCategory)$p.value,
#                                                              Pvalue_StemConduitDiameter = t.test(StemConduitDiameter ~ DominanceCategory)$p.value,
#                                                              Pvalue_RootDepth = t.test(RootDepth ~ DominanceCategory)$p.value,
#                                                              Pvalue_SeedMass = t.test(SeedMass ~ DominanceCategory)$p.value,
#                                                              Pvalue_Gymnosperm = wilcox.test(PercInd_gymnosperm ~ DominanceCategory)$p.value,
#                                                              Pvalue_pca1 = wilcox.test(pca1 ~ DominanceCategory)$p.value,
#                                                              Pvalue_pca2 = wilcox.test(pca2 ~ DominanceCategory)$p.value))
# a <- wilcox.test(Plot_TraitsDRScaled$DominanceCategory, Plot_TraitsDRScaled$Height)
# b <- t.test(Plot_TraitsDRScaled$DominanceCategory ~  Plot_TraitsDRScaled$Height)

#Join datasets
TraitsDiffMean <- left_join(TraitsDiffMean, Results_Wilcoxon_nr)

##Boxplots standard error 
TraitsDiffMean <- TraitsDiffMean[which(TraitsDiffMean$Biome!=3),]

#####Add significance level
BoxplotLeafN <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanLeafN, colour=factor(Biome), shape=factor(Pvalue_LeafN))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169"),
                     labels = c("Tropical moist", "Tropical dry", "Temperate", "Temperate conifer",  "Boreal")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCILeafN, ymax=hiCILeafN), color="black", width=.1) + #ymin=MeanLeafN-seLeafN, ymax=MeanLeafN+seLeafN
  labs(title="Leaf nitrogen") +
  labs(x=" ", y=" Leaf N") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") #bottom

BoxplotLeafNP <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanLeafNP, colour=factor(Biome), shape=factor(Pvalue_LeafNP))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCILeafNP, ymax=hiCILeafNP), color="black", width=.1) + #ymin=MeanLeafNP-seLeafNP, ymax=MeanLeafNP+seLeafNP
  labs(title="Leaf N/P ratio") +
  labs(x=" ", y=" Leaf NP") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotStemConduitD <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanStemConduitD, colour=factor(Biome), shape=factor(Pvalue_StemConduitDiameter))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIStemConduitD, ymax=hiCIStemConduitD), color="black", width=.1) + #ymin=MeanStemConduitD-seStemConduitD, ymax=MeanStemConduitD+seStemConduitD
  labs(title="Stem Conduit Diameter") +
  labs(x=" ", y=" Stem Conduit Diam.") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotSeedMass <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanSeedMass, colour=factor(Biome), shape=factor(Pvalue_SeedMass))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCISeedMass, ymax=hiCISeedMass), color="black", width=.1) + #ymin=MeanSeedMass-seSeedMass, ymax=MeanSeedMass+seSeedMass
  labs(title="Seed mass") +
  labs(x=" ", y=" Seed mass") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom", breaks = c("1", "2", "3", "4", "5", "6"), labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+ # labels=c("Tropical Moist", "Tropical dry", "Tropical conifer", "Temperate", "Temperate conifer",  "Boreal"))
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

# grid.arrange(BoxplotStemConduitD, BoxplotLeafN, BoxplotLeafNP, BoxplotSeedMass, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

BoxplotHeight <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanHeight, colour=factor(Biome), shape=factor(Pvalue_Height))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(19, 21)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIHeight, ymax=hiCIHeight), color="black", width=.1) + #ymin=MeanHeight-seHeight, ymax=MeanHeight+seHeight
  labs(title="Tree Height") + labs(x=" ", y=" Tree height") + geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotCrownDiameter <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanCrownDiameter, colour=factor(Biome), shape=factor(Pvalue_CrownDiameter))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCICrownDiameter, ymax=hiCICrownDiameter), color="black", width=.1) + #ymin=MeanCrownDiameter-seCrownDiameter, ymax=MeanCrownDiameter+seCrownDiameter
  labs(title="Crown diameter") +
  labs(x=" ", y=" Crown diameter") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotWoodDensity <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanWoodDensity, colour=factor(Biome), shape=factor(Pvalue_WoodDensity))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(19, 21)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIWoodDensity, ymax=hiCIWoodDensity), color="black", width=.1) + #ymin=MeanWoodDensity-seWoodDensity, ymax=MeanWoodDensity+seWoodDensity
  labs(title="Wood density") +
  labs(x=" ", y=" Wood density") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotBarkThickness <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanBarkThickness, colour=factor(Biome), shape=factor(Pvalue_BarkThickness))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIBarkThickness, ymax=hiCIBarkThickness), color="black", width=.1) + #ymin=MeanBarkThickness-seBarkThickness, ymax=MeanBarkThickness+seBarkThickness
  labs(title="Bark thickness") +
  labs(x=" ", y=" Bark thickness") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotSLA <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanSLA, colour=factor(Biome), shape=factor(Pvalue_SLA))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21, 19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCISLA, ymax=hiCISLA), color="black", width=.1) + #ymin=MeanSLA-seSLA, ymax=MeanSLA+seSLA
  labs(title="Specific leaf area") +
  labs(x=" ", y=" SLA") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotRootDepth <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanRootDepth, colour=factor(Biome), shape=factor(Pvalue_RootDepth))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIRootDepth, ymax=hiCIRootDepth), color="black", width=.1) + #ymin=MeanRootDepth-seRootDepth, ymax=MeanRootDepth+seRootDepth
  labs(title="Root depth") +
  labs(x=" ", y=" Root depth") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotGymnosperm <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanPercInd_gymnosperm, colour=factor(Biome), shape=factor(Pvalue_Gymnosperm))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIPercInd_gymnosperm, ymax=hiCIPercInd_gymnosperm), color="black", width=.1) + #ymin=MeanPercInd_gymnosperm-sePercInd_gymnosperm, ymax=MeanPercInd_gymnosperm+sePercInd_gymnosperm
  labs(title="Gymnosperm") +
  labs(x=" ", y=" gymnosperm %") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

Boxplotpca1 <- ggplot(TraitsDiffMean, aes(x=Biome, y=Meanpca1, colour=factor(Biome), shape=factor(Pvalue_pca1))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(19, 21)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIpca1, ymax=hiCIpca1), color="black", width=.1) + #ymin=Meanpca1-sepca1, ymax=Meanpca1+sepca1
  labs(title="pca 1") +
  labs(x=" ", y=" pca 1") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

Boxplotpca2 <- ggplot(TraitsDiffMean, aes(x=Biome, y=Meanpca2, colour=factor(Biome), shape=factor(Pvalue_pca2))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIpca2, ymax=hiCIpca2), color="black", width=.1) + #ymin=Meanpca2-sepca2, ymax=Meanpca2+sepca2
  labs(title="pca 2") +
  labs(x=" ", y=" pca 2") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

# BoxplotHeight <- BoxplotHeight + ylim(c(-0.5, 0.5))
# BoxplotCrownDiameter <- BoxplotCrownDiameter + ylim(c(-0.5, 0.5))
# BoxplotWoodDensity <- BoxplotWoodDensity + ylim(c(-0.5, 0.5))  # + scale_y_continuous(breaks=c(-0.5, 0.5))
# BoxplotSLA <- BoxplotSLA + ylim(c(-0.5, 0.5))
# BoxplotRootDepth <- BoxplotRootDepth + ylim(c(-0.5, 0.5))

# grid.arrange(BoxplotHeight, BoxplotCrownDiameter, BoxplotWoodDensity, BoxplotStemConduitD, BoxplotBarkThickness, BoxplotSLA, BoxplotLeafN, BoxplotLeafNP, BoxplotRootDepth, BoxplotSeedMass, nrow=2)

Fig3 <- grid.arrange(BoxplotHeight, BoxplotWoodDensity, BoxplotLeafN, BoxplotSeedMass, BoxplotRootDepth, Boxplotpca1, nrow=4, top=textGrob("Traits of dominant and rare species", gp=gpar(col="black", fontsize=20, fontface="bold")), padding = unit(3,"line"))

GraphsSI <- grid.arrange(BoxplotCrownDiameter, BoxplotBarkThickness, BoxplotStemConduitD, BoxplotSLA, BoxplotLeafNP,  BoxplotGymnosperm, Boxplotpca2,  nrow=4, top=textGrob("Traits of dominant and rare species", gp=gpar(col="black", fontsize=20, fontface="bold")), padding = unit(3,"line"))

```
###Fig. 3 
```{r Boxplots}

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")

DominantRare_Plot$genus <- word(DominantRare_Plot$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(DominantRare_Plot$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

DominantRare_Plot$GymnoAngiosperm <- family$sperms

####Calculate percentage gymnosperm species per plot
DominantRare_Plot_select <- DominantRare_Plot[complete.cases(DominantRare_Plot$species_name),] #Select only identified trees
# DominantRare_Plot_CountGymno <- as.data.frame(DominantRare_Plot_select %>% group_by(plot_id, species_name) %>% slice(1) %>% count(GymnoAngiosperm)) #Sum of species per plot
# DominantRare_CountGymno <- DominantRare_Plot_CountGymno[which(DominantRare_Plot_CountGymno$GymnoAngiosperm=="gymnosperm"),]
# DominantRare_CountGymno <- DominantRare_CountGymno %>% rename("Gymnosperm" = n) %>% select(-GymnoAngiosperm)  %>% as.data.frame() 
# 
# Plots_DominantRare_Plot <- DominantRare_Plot %>% group_by(plot_id) %>% slice(1)
# Plots_DominantRare_Plot <- Plots_DominantRare_Plot %>% dplyr::select(plot_id, SumS)
# DominantRare_Gymno <- left_join(Plots_DominantRare_Plot, DominantRare_CountGymno)
# DominantRare_Gymno$Gymnosperm[is.na(DominantRare_Gymno$Gymnosperm)] <- 0
# DominantRare_Gymno_perc <- as.data.frame(DominantRare_Gymno %>% group_by(plot_id) %>% mutate(PercSp_gymnosperm=(Gymnosperm/SumS)*100))
# DominantRare_Gymno_perc <- DominantRare_Gymno_perc %>% dplyr::select(plot_id, PercSp_gymnosperm)

####Calculate percentage gymnosperm individuals per plot
DominantRare_Plot_CountGymno <- as.data.frame(DominantRare_Plot_select %>% group_by(plot_id, DominanceCategory) %>% dplyr::count(GymnoAngiosperm)) #Sum of individuals per plot
DominantRare_CountGymno <- DominantRare_Plot_CountGymno[which(DominantRare_Plot_CountGymno$GymnoAngiosperm=="gymnosperm"),]
DominantRare_CountGymno <- DominantRare_CountGymno %>% dplyr::rename("Gymnosperm" = n) %>% dplyr::select(-GymnoAngiosperm)  %>% as.data.frame() 

Plots_DominantRare_PercInd <- DominantRare_Plot %>% group_by(plot_id, DominanceCategory) %>% dplyr::mutate(., NrIndCategory = sum(n())) %>% slice(1)
Plots_DominantRare_Plot <- Plots_DominantRare_PercInd %>% dplyr::select(plot_id, DominanceCategory, NrIndCategory)

DominantRare_Gymno <- left_join(Plots_DominantRare_Plot, DominantRare_CountGymno)
DominantRare_Gymno$Gymnosperm[is.na(DominantRare_Gymno$Gymnosperm)] <- 0
DominantRare_Gymno_perc <- as.data.frame(DominantRare_Gymno %>% group_by(plot_id, DominanceCategory) %>% mutate(PercInd_gymnosperm=(Gymnosperm/NrIndCategory)*100))
DominantRare_Gymno_perc <- DominantRare_Gymno_perc %>% dplyr::select(plot_id, DominanceCategory, PercInd_gymnosperm)

DominantRare_Gymno_DomRare <- DominantRare_Gymno_perc[which(DominantRare_Gymno_perc$DominanceCategory=="dominant" | DominantRare_Gymno_perc$DominanceCategory=="rare"), ]

###Difference between CWM dominant and rare species traits
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame()

Plot_TraitsDRScaled <- left_join(Plot_TraitsDRScaled, DominantRare_Gymno_DomRare)

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)


TraitsDiffMean <- as.data.frame(DiffDomRare_CWM %>% group_by(Biome) %>% dplyr::summarise(n = n(), MeanHeight=mean(Height), seHeight=(sd(Height)/sqrt(n)),lowCIHeight = ci(Height)[2], hiCIHeight = ci(Height)[3], MeanCrownDiameter=mean(CrownDiameter), seCrownDiameter=(sd(CrownDiameter)/sqrt(n)), lowCICrownDiameter = ci(CrownDiameter)[2], hiCICrownDiameter = ci(CrownDiameter)[3], MeanBarkThickness=mean(BarkThickness), seBarkThickness=(sd(BarkThickness)/sqrt(n)), lowCIBarkThickness = ci(BarkThickness)[2], hiCIBarkThickness = ci(BarkThickness)[3], MeanWoodDensity=mean(WoodDensity), seWoodDensity=(sd(WoodDensity)/sqrt(n)), lowCIWoodDensity = ci(WoodDensity)[2], hiCIWoodDensity = ci(WoodDensity)[3], MeanSLA=mean(SLA), seSLA=(sd(SLA)/sqrt(n)), lowCISLA = ci(SLA)[2], hiCISLA = ci(SLA)[3], MeanLeafN=mean(LeafN), seLeafN=(sd(LeafN)/sqrt(n)), lowCILeafN = ci(LeafN)[2], hiCILeafN = ci(LeafN)[3], MeanLeafNP=mean(LeafNP), seLeafNP=(sd(LeafNP)/sqrt(n)), lowCILeafNP = ci(LeafNP)[2], hiCILeafNP = ci(LeafNP)[3], MeanStemConduitD=mean(StemConduitDiameter), seStemConduitD=(sd(StemConduitDiameter)/sqrt(n)), lowCIStemConduitD = ci(StemConduitDiameter)[2], hiCIStemConduitD = ci(StemConduitDiameter)[3], MeanRootDepth=mean(RootDepth), seRootDepth=(sd(RootDepth)/sqrt(n)), lowCIRootDepth = ci(RootDepth)[2], hiCIRootDepth = ci(RootDepth)[3], MeanSeedMass=mean(SeedMass), seSeedMass=(sd(SeedMass)/sqrt(n)), lowCISeedMass = ci(SeedMass)[2], hiCISeedMass = ci(SeedMass)[3], #MeanPercInd_gymnosperm=mean(PercInd_gymnosperm), sePercInd_gymnosperm=(sd(PercInd_gymnosperm)/sqrt(n)), lowCIPercInd_gymnosperm = ci(PercInd_gymnosperm)[2], hiCIPercInd_gymnosperm = ci(PercInd_gymnosperm)[3],
Meanpca1=mean(pca1), sepca1=(sd(pca1)/sqrt(n)), lowCIpca1 = ci(pca1)[2], hiCIpca1 = ci(pca1)[3], Meanpca2=mean(pca2), sepca2=(sd(pca2)/sqrt(n)), lowCIpca2 = ci(pca2)[2], hiCIpca2 = ci(pca2)[3]))

###Calculate mean differences per biome
TraitsDiffMean_select <- TraitsDiffMean %>% dplyr::select(Biome, starts_with("Mean")) %>% dplyr::select(-Meanpca1, -Meanpca2) #-MeanPercInd_gymnosperm, 
TraitsDifferencesBiome <- TraitsDiffMean_select %>% rowwise() %>% mutate(mean = mean(abs(c_across(starts_with("Mean")))), na.rm = TRUE) %>% ungroup()

###Statistics
Plot_TraitsDRScaled$DominanceCategory <- ifelse(Plot_TraitsDRScaled$DominanceCategory == "dominant", "2", "1") #2=dominant, 1=rare
Plot_TraitsDRScaled$DominanceCategory <- as.numeric(Plot_TraitsDRScaled$DominanceCategory)

NBiomes <- Plot_TraitsDRScaled %>% group_by(Biome) %>% summarise(count=n()/2)

Results_Wilcoxon <- as.data.frame(Plot_TraitsDRScaled %>% group_by(Biome) %>% dplyr::summarise(Pvalue_Height = wilcox.test(Height ~ DominanceCategory)$p.value,
                                                             Pvalue_CrownDiameter = wilcox.test(CrownDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_BarkThickness = wilcox.test(BarkThickness ~ DominanceCategory)$p.value,
                                                             Pvalue_WoodDensity = wilcox.test(WoodDensity ~ DominanceCategory)$p.value,
                                                             Pvalue_SLA = wilcox.test(SLA ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafN = wilcox.test(LeafN ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafNP = wilcox.test(LeafNP ~ DominanceCategory)$p.value,
                                                             Pvalue_StemConduitDiameter = wilcox.test(StemConduitDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_RootDepth = wilcox.test(RootDepth ~ DominanceCategory)$p.value,
                                                             Pvalue_SeedMass = wilcox.test(SeedMass ~ DominanceCategory)$p.value,
                                                             Pvalue_Gymnosperm = wilcox.test(PercInd_gymnosperm ~ DominanceCategory)$p.value,
                                                             Pvalue_pca1 = wilcox.test(pca1 ~ DominanceCategory)$p.value,
                                                             Pvalue_pca2 = wilcox.test(pca2 ~ DominanceCategory)$p.value))

Results_Wilcoxon_W <- as.data.frame(Plot_TraitsDRScaled %>% group_by(Biome) %>% dplyr::summarise(Pvalue_Height = wilcox.test(Height ~ DominanceCategory)$statistic,
                                                             Pvalue_CrownDiameter = wilcox.test(CrownDiameter ~ DominanceCategory)$statistic,
                                                             Pvalue_BarkThickness = wilcox.test(BarkThickness ~ DominanceCategory)$statistic,
                                                             Pvalue_WoodDensity = wilcox.test(WoodDensity ~ DominanceCategory)$statistic,
                                                             Pvalue_SLA = wilcox.test(SLA ~ DominanceCategory)$statistic,
                                                             Pvalue_LeafN = wilcox.test(LeafN ~ DominanceCategory)$statistic,
                                                             Pvalue_LeafNP = wilcox.test(LeafNP ~ DominanceCategory)$statistic,
                                                             Pvalue_StemConduitDiameter = wilcox.test(StemConduitDiameter ~ DominanceCategory)$statistic,
                                                             Pvalue_RootDepth = wilcox.test(RootDepth ~ DominanceCategory)$statistic,
                                                             Pvalue_SeedMass = wilcox.test(SeedMass ~ DominanceCategory)$statistic,
                                                             Pvalue_Gymnosperm = wilcox.test(PercInd_gymnosperm ~ DominanceCategory)$statistic,
                                                             Pvalue_pca1 = wilcox.test(pca1 ~ DominanceCategory)$statistic,
                                                             Pvalue_pca2 = wilcox.test(pca2 ~ DominanceCategory)$statistic))

Results_Wilcoxon_nr <- Results_Wilcoxon %>% dplyr::mutate(across(c(2:14), ~ifelse(. <= 0.05, 1, 0)))

# #Test assumptions t-test: all not normally distributed
# Biome1 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==1),]
# Biome2 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==2),]
# Biome4 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==4),]
# Biome4_subset <- Biome4 %>% sample_n(5000)
# Biome5 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==5),]
# Biome5_subset <- Biome5 %>% sample_n(5000)
# Biome6 <- Plot_TraitsDRScaled[ which(Plot_TraitsDRScaled$Biome==6),]
# 
# DiffDomRare_Biome <- rbind(Biome1, Biome2, Biome4_subset, Biome5_subset, Biome6)
# 
# Test <- DiffDomRare_Biome %>% group_by(Biome) %>% dplyr::summarise(Pvalue_Height = shapiro.test(Height)$p.value, #p higher than 0.05 -> t-test is applicable
#                                                                    Pvalue_CrownDiameter = shapiro.test(CrownDiameter)$p.value,
#                                                                    Pvalue_BarkThickness = shapiro.test(BarkThickness)$p.value,
#                                                                    Pvalue_WoodDensity = shapiro.test(WoodDensity)$p.value,
#                                                                    Pvalue_SLA = shapiro.test(SLA)$p.value,
#                                                                    Pvalue_LeafN = shapiro.test(LeafN)$p.value,
#                                                                    Pvalue_LeafNP = shapiro.test(LeafNP)$p.value,
#                                                                    Pvalue_StemConduitDiameter = shapiro.test(StemConduitDiameter)$p.value,
#                                                                    Pvalue_RootDepth = shapiro.test(RootDepth)$p.value,
#                                                                    Pvalue_SeedMass = shapiro.test(SeedMass)$p.value,
#                                                                    Pvalue_PercInd_gymnosperm = shapiro.test(PercInd_gymnosperm)$p.value,
#                                                                    Pvalue_pca1 = shapiro.test(pca1)$p.value,
#                                                                    Pvalue_pca2 = shapiro.test(pca2)$p.value)
# 
# Results_Ttest <- as.data.frame(Plot_TraitsDRScaled %>% group_by(Biome) %>% summarise(Pvalue_Height = t.test(Height ~ DominanceCategory)$p.value,
#                                                              Pvalue_CrownDiameter = t.test(CrownDiameter ~ DominanceCategory)$p.value,
#                                                              Pvalue_BarkThickness = t.test(BarkThickness ~ DominanceCategory)$p.value,
#                                                              Pvalue_WoodDensity = t.test(WoodDensity ~ DominanceCategory)$p.value,
#                                                              Pvalue_SLA = t.test(SLA ~ DominanceCategory)$p.value,
#                                                              Pvalue_LeafN = t.test(LeafN ~ DominanceCategory)$p.value,
#                                                              Pvalue_LeafNP = t.test(LeafNP ~ DominanceCategory)$p.value,
#                                                              Pvalue_StemConduitDiameter = t.test(StemConduitDiameter ~ DominanceCategory)$p.value,
#                                                              Pvalue_RootDepth = t.test(RootDepth ~ DominanceCategory)$p.value,
#                                                              Pvalue_SeedMass = t.test(SeedMass ~ DominanceCategory)$p.value,
#                                                              Pvalue_Gymnosperm = wilcox.test(PercInd_gymnosperm ~ DominanceCategory)$p.value,
#                                                              Pvalue_pca1 = wilcox.test(pca1 ~ DominanceCategory)$p.value,
#                                                              Pvalue_pca2 = wilcox.test(pca2 ~ DominanceCategory)$p.value))
# a <- wilcox.test(Plot_TraitsDRScaled$DominanceCategory, Plot_TraitsDRScaled$Height)
# b <- t.test(Plot_TraitsDRScaled$DominanceCategory ~  Plot_TraitsDRScaled$Height)

#Join datasets
TraitsDiffMean <- left_join(TraitsDiffMean, Results_Wilcoxon_nr)

##Boxplots standard error 
TraitsDiffMean <- TraitsDiffMean[which(TraitsDiffMean$Biome!=3),]

fwrite(TraitsDiffMean, file="TraitsDiffMean.csv") #Write data file to reproduce figure

#####Add significance level
BoxplotLeafN <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanLeafN, colour=factor(Biome), shape=factor(Pvalue_LeafN))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169"),
                     labels = c("Tropical moist", "Tropical dry", "Temperate", "Temperate conifer",  "Boreal")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCILeafN, ymax=hiCILeafN), color="black", width=.1) + #ymin=MeanLeafN-seLeafN, ymax=MeanLeafN+seLeafN
  labs(title="Leaf nitrogen") +
  labs(x=" ", y=" Leaf N") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") #bottom

BoxplotLeafNP <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanLeafNP, colour=factor(Biome), shape=factor(Pvalue_LeafNP))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCILeafNP, ymax=hiCILeafNP), color="black", width=.1) + #ymin=MeanLeafNP-seLeafNP, ymax=MeanLeafNP+seLeafNP
  labs(title="Leaf N/P ratio") +
  labs(x=" ", y=" Leaf NP") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotStemConduitD <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanStemConduitD, colour=factor(Biome), shape=factor(Pvalue_StemConduitDiameter))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIStemConduitD, ymax=hiCIStemConduitD), color="black", width=.1) + #ymin=MeanStemConduitD-seStemConduitD, ymax=MeanStemConduitD+seStemConduitD
  labs(title="Stem Conduit Diameter") +
  labs(x=" ", y=" Stem Conduit Diam.") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotSeedMass <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanSeedMass, colour=factor(Biome), shape=factor(Pvalue_SeedMass))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCISeedMass, ymax=hiCISeedMass), color="black", width=.1) + #ymin=MeanSeedMass-seSeedMass, ymax=MeanSeedMass+seSeedMass
  labs(title="Seed mass") +
  labs(x=" ", y=" Seed mass") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom", breaks = c("1", "2", "3", "4", "5", "6"), labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+ # labels=c("Tropical Moist", "Tropical dry", "Tropical conifer", "Temperate", "Temperate conifer",  "Boreal"))
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

# grid.arrange(BoxplotStemConduitD, BoxplotLeafN, BoxplotLeafNP, BoxplotSeedMass, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

BoxplotHeight <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanHeight, colour=factor(Biome), shape=factor(Pvalue_Height))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(19, 21)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIHeight, ymax=hiCIHeight), color="black", width=.1) + #ymin=MeanHeight-seHeight, ymax=MeanHeight+seHeight
  labs(title="Tree Height") + labs(x=" ", y=" Tree height") + geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotCrownDiameter <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanCrownDiameter, colour=factor(Biome), shape=factor(Pvalue_CrownDiameter))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCICrownDiameter, ymax=hiCICrownDiameter), color="black", width=.1) + #ymin=MeanCrownDiameter-seCrownDiameter, ymax=MeanCrownDiameter+seCrownDiameter
  labs(title="Crown diameter") +
  labs(x=" ", y=" Crown diameter") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotWoodDensity <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanWoodDensity, colour=factor(Biome), shape=factor(Pvalue_WoodDensity))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(19, 21)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIWoodDensity, ymax=hiCIWoodDensity), color="black", width=.1) + #ymin=MeanWoodDensity-seWoodDensity, ymax=MeanWoodDensity+seWoodDensity
  labs(title="Wood density") +
  labs(x=" ", y=" Wood density") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotBarkThickness <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanBarkThickness, colour=factor(Biome), shape=factor(Pvalue_BarkThickness))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIBarkThickness, ymax=hiCIBarkThickness), color="black", width=.1) + #ymin=MeanBarkThickness-seBarkThickness, ymax=MeanBarkThickness+seBarkThickness
  labs(title="Bark thickness") +
  labs(x=" ", y=" Bark thickness") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotSLA <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanSLA, colour=factor(Biome), shape=factor(Pvalue_SLA))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21, 19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCISLA, ymax=hiCISLA), color="black", width=.1) + #ymin=MeanSLA-seSLA, ymax=MeanSLA+seSLA
  labs(title="Specific leaf area") +
  labs(x=" ", y=" SLA") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotRootDepth <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanRootDepth, colour=factor(Biome), shape=factor(Pvalue_RootDepth))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIRootDepth, ymax=hiCIRootDepth), color="black", width=.1) + #ymin=MeanRootDepth-seRootDepth, ymax=MeanRootDepth+seRootDepth
  labs(title="Root depth") +
  labs(x=" ", y=" Root depth") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

BoxplotGymnosperm <- ggplot(TraitsDiffMean, aes(x=Biome, y=MeanPercInd_gymnosperm, colour=factor(Biome), shape=factor(Pvalue_Gymnosperm))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIPercInd_gymnosperm, ymax=hiCIPercInd_gymnosperm), color="black", width=.1) + #ymin=MeanPercInd_gymnosperm-sePercInd_gymnosperm, ymax=MeanPercInd_gymnosperm+sePercInd_gymnosperm
  labs(title="Gymnosperm") +
  labs(x=" ", y=" gymnosperm %") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

Boxplotpca1 <- ggplot(TraitsDiffMean, aes(x=Biome, y=Meanpca1, colour=factor(Biome), shape=factor(Pvalue_pca1))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(19, 21)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIpca1, ymax=hiCIpca1), color="black", width=.1) + #ymin=Meanpca1-sepca1, ymax=Meanpca1+sepca1
  labs(title="pca 1") +
  labs(x=" ", y=" pca 1") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

Boxplotpca2 <- ggplot(TraitsDiffMean, aes(x=Biome, y=Meanpca2, colour=factor(Biome), shape=factor(Pvalue_pca2))) + geom_point(size=4, position = position_dodge(width=0.75)) +
  scale_color_manual(values = c("#ffdd03", "#8fd613", "#0281a8", "#00549e", "#270169")) +
  scale_shape_manual(values = c(21,19)) + #0=non sig, 1=sig
  geom_errorbar(aes(ymin=lowCIpca2, ymax=hiCIpca2), color="black", width=.1) + #ymin=Meanpca2-sepca2, ymax=Meanpca2+sepca2
  labs(title="pca 2") +
  labs(x=" ", y=" pca 2") +
  geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
  theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none")

# BoxplotHeight <- BoxplotHeight + ylim(c(-0.5, 0.5))
# BoxplotCrownDiameter <- BoxplotCrownDiameter + ylim(c(-0.5, 0.5))
# BoxplotWoodDensity <- BoxplotWoodDensity + ylim(c(-0.5, 0.5))  # + scale_y_continuous(breaks=c(-0.5, 0.5))
# BoxplotSLA <- BoxplotSLA + ylim(c(-0.5, 0.5))
# BoxplotRootDepth <- BoxplotRootDepth + ylim(c(-0.5, 0.5))

# grid.arrange(BoxplotHeight, BoxplotCrownDiameter, BoxplotWoodDensity, BoxplotStemConduitD, BoxplotBarkThickness, BoxplotSLA, BoxplotLeafN, BoxplotLeafNP, BoxplotRootDepth, BoxplotSeedMass, nrow=2)

Fig3 <- grid.arrange(BoxplotHeight, BoxplotWoodDensity, BoxplotLeafN, BoxplotSeedMass, BoxplotRootDepth, Boxplotpca1, nrow=4, top=textGrob("Traits of dominant and rare species", gp=gpar(col="black", fontsize=20, fontface="bold")), padding = unit(3,"line"))

GraphsSI <- grid.arrange(BoxplotCrownDiameter, BoxplotBarkThickness, BoxplotStemConduitD, BoxplotSLA, BoxplotLeafNP,  BoxplotGymnosperm, Boxplotpca2,  nrow=4, top=textGrob("Traits of dominant and rare species", gp=gpar(col="black", fontsize=20, fontface="bold")), padding = unit(3,"line"))

```
###Fig. 4
```{r Temperature & Aridity}
#Pair up with environmental variables
#Import and add GEE information
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature, CHELSA_BIO_Annual_Precipitation, CHELSA_BIO_Precipitation_Seasonality, CHELSA_BIO_Temperature_Seasonality, EarthEnvTopoMed_Elevation, GFAD_FractionOfRegrowthForest_downsampled50km, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index, CGIAR_PET))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CHELSA_BIO_Annual_Precipitation", "CHELSA_BIO_Precipitation_Seasonality",  "CHELSA_BIO_Temperature_Seasonality", "EarthEnvTopoMed_Elevation", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "CGIAR_Aridity_Index", "CGIAR_PET"), new=c("Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "Forest_Age", "Aridity", "PET"))

DifCWM_Envars <- left_join(DiffDomRare_CWM, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

#Relationship temperature-aridity
DifCWM_Envars$Temperature <- DifCWM_Envars$Temperature.y
cor.test(DifCWM_Envars$Aridity, DifCWM_Envars$Temperature, method = "pearson") #-0.09, p<0.001
cor.test(DifCWM_Envars$Aridity, DifCWM_Envars$Temperature, method = "spearman") #-0.16, p<0.001

###Aridity graphs
DifCWM_Envars <- as.data.frame(DifCWM_Envars)

DifCWM_Envars$Temperature <- DifCWM_Envars$Temperature/10
DifCWM_Envars$Aridity <- DifCWM_Envars$Aridity*0.0001
DifCWM_Envars <- DifCWM_Envars[which(DifCWM_Envars$Aridity <= 4),] #69 plots removed

DifCWM_EnvarsOutput <- DifCWM_Envars %>% dplyr::select(Aridity, Temperature, Height, WoodDensity, LeafN, SeedMass, RootDepth, pca1)
fwrite(DifCWM_EnvarsOutput, file="DifCWM_Envars.csv") #To reproduce figure 4

#############MAIN TEXT
Height_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, Height)) + #linear relationship (quadratic relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.03***", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + xlab(" ") + ylab(" Height") + #labs(title="Height") +
  geom_ribbon(aes(ymin = 0,ymax = predict(lm(Height  ~ Aridity), data=DifCWM_Envars)), alpha = 0.8,fill = "#9e7306")+
  geom_segment(aes(x = 3.5, y = 0, xend = 3.5, yend = -Inf), size=0.5, linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

RootDepth_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, RootDepth)) + #Quadratic relationship (linear relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + xlim(c(0, 4)) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.01***", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(RootDepth ~ Aridity), data=DifCWM_Envars)), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.6, y = 0, xend = 1.6, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Rooting Depth")+ #labs(title="Root Depth") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

StemConduitDiameter_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, StemConduitDiameter)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.03***", x = 3.5, y = -0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(StemConduitDiameter ~ Aridity), data=DifCWM_Envars)), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Stem Conduit Diam.")+ #labs(title="Stem Conduit Diam.") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SLA_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, SLA)) + #Quadratic relationship (linear relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.05***", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SLA ~ Aridity), data=DifCWM_Envars)), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.55, y = 0, xend = 1.55, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" SLA")+ #labs(title="SLA") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

pca1_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, pca1)) + #Quadratic relationship with log(y) (linear relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.1***", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(pca1 ~ Aridity), data=DifCWM_Envars)), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), size=0.5, linetype="dashed") +
  xlab("Water Availability Index") + ylab(" PC1")+ #labs(title="pca1") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#############SI
CrownDiameter_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, CrownDiameter)) + #linear with log(y) (quadratic relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "<0.01", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + xlab(" ") + ylab(" Crown Diam.")+ #labs(title="Crown Diameter") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(CrownDiameter ~ Aridity, data=DifCWM_Envars))), alpha = 0.8,fill = "#9e7306")+
  geom_segment(aes(x = 1.6, y = 0, xend = 1.6, yend = -Inf), size=0.5, linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

WoodDensity_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, WoodDensity)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.08***", x = 3.5, y = -0.8, size = 6, colour = "black") + 
  theme_classic()+ 
  geom_hline(yintercept=0, color = "grey", size=1) + xlab(" ") + ylab(" Wood Density")+ #labs(title="Wood density") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(WoodDensity ~ Aridity, data=DifCWM_Envars))), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), size=0.5, linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
BarkThickness_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, BarkThickness)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.02***", x = 3.5, y =0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(BarkThickness ~ Aridity, data=DifCWM_Envars))), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 2.8, y = 0, xend = 2.8, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Bark thickness")+ #labs(title="Bark thickness") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

LeafN_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, LeafN)) + #Quadratic relationship (linear relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.03***", x = 3.5, y = -0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafN ~ Aridity, data=DifCWM_Envars))), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Leaf N")+ #labs(title="Leaf N") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

LeafNP_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, LeafNP)) + #Quadratic relationship (linear relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.03***", x = 3.5, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafNP ~ Aridity, data=DifCWM_Envars))), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), size=0.5, linetype="dashed") +
  xlab("Humidity Index") + ylab(" Leaf NP")+ #labs(title="Leaf NP") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SeedMass_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, SeedMass)) + #Linear relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.02***", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SeedMass ~ Aridity, data=DifCWM_Envars))), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Seed Mass")+ #labs(title="Seed Mass") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Gymnosperm_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, PercInd_gymnosperm)) + #Linear relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.05***", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(PercInd_gymnosperm ~ Aridity, data=DifCWM_Envars))), alpha = 0.8, fill = "#9e7306")+
  #geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Gymnosperm %")+ #labs(title="Seed Mass") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size="none")

#ggplot(DifCWM_Envars, aes(Aridity, pca2)) + geom_smooth(size= 2, colour="#0a0a0a")
#cor.test(DifCWM_Envars$Aridity, DifCWM_Envars$pca2, method="pearson") #all correlation p<0.001

# Variable <- DifCWM_Envars$pca1
# summary(lm(Variable  ~ Aridity, data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ Aridity, data=DifCWM_Envars))
# summary(lm(Variable  ~ exp(Aridity), data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ exp(Aridity), data=DifCWM_Envars))
# summary(lm(Variable  ~ I(1/Aridity), data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ I(1/Aridity), data=DifCWM_Envars))
# summary(lm(Variable  ~ Aridity + I(Aridity^2), data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ Aridity + I(Aridity^2), data=DifCWM_Envars))

pca2_Aridity <- ggplot(DifCWM_Envars, aes(Aridity, pca2)) + #linear relationship or quadratic relationship with log(y)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", se=F) + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.02***", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(pca2 ~ Aridity, data=DifCWM_Envars))), alpha = 0.8, fill = "#9e7306")+
  geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), size=0.5, linetype="dashed") +
  xlab("Humidity Index") + ylab(" PC2")+ #labs(title="pca2") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

###Temperature graphs
#############MAIN TEXT
Height_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, Height)) + #Quadratic relationship with log(y) (linear relationship as good)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.06***", x = 23, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + #linetype="dashed", 
  xlab(" ") + ylab(" Height")+ 
  geom_ribbon(aes(ymin = 0,ymax = predict(lm(Height  ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8,fill = "#58038c")+
  geom_segment(aes(x = 25.5, y = 0, xend = 25.5, yend = -Inf), size=0.5, linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

RootDepth_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, RootDepth)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.03***", x = 23, y = 0.8, size = 6, colour = "black") + 
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(RootDepth ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 4.9, y = 0, xend = 4.9, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Rooting Depth")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

StemConduitDiameter_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, StemConduitDiameter)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.06***", x = 23, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(StemConduitDiameter ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 5, y = 0, xend = 5, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Stem Conduit Diam.")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
SLA_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, SLA)) + #Quadratic relationship with log(y)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.09***", x = 23, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SLA ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 6, y = 0, xend = 6, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" SLA")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

pca1_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, pca1)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.14***", x = 23, y = -0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(pca1 ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 4.3, y = 0, xend = 4.3, yend = -Inf), size=0.5, linetype="dashed") +
  xlab("Temperature C") + ylab(" PC1")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#############SI
CrownDiameter_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, CrownDiameter)) + #Quadratic term with log(y) (as good as with y)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.06***", x = 23, y = 0.8, size = 6, colour = "black") +
  theme_classic() + geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(CrownDiameter ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 5, y = 0, xend = 5, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Crown Diam.")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

WoodDensity_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, WoodDensity)) + #Quadratic term with log(y) (as good as with y)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.05***", x = 23, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(WoodDensity ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 6.2, y = 0, xend = 6.2, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Wood Density")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
BarkThickness_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, BarkThickness)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.03***", x = 23, y =0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(BarkThickness ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 23, y = 0, xend = 23, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Bark thickness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

LeafN_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, LeafN)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.07***", x = 23, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafN ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 4.5, y = 0, xend = 4.5, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Leaf N")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

LeafNP_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, LeafNP)) + #Quadratic relationship
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "0.03***", x = 25, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafNP ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 4, y = 0, xend = 4, yend = -Inf), size=0.5, linetype="dashed") +
  xlab("Temperature C") + ylab(" Leaf NP")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SeedMass_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, SeedMass)) + #Quadratic relationship with log(y) (as good as linear relationship)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.01***", x = 23, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SeedMass ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 4.8, y = 0, xend = 4.8, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Seed Mass")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Gymnosperm_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, PercInd_gymnosperm)) + #Quadratic relationship with log(y) (as good as linear relationship)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.04***", x = 23, y = -0.5, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(PercInd_gymnosperm ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  #geom_segment(aes(x = 5, y = 0, xend = 5, yend = -Inf), size=0.5, linetype="dashed") +
  xlab(" ") + ylab(" Gymnosperm %")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

# Variable <- DifCWM_Envars$pca2
# summary(lm(Variable  ~ Temperature, data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ Temperature, data=DifCWM_Envars))
# summary(lm(Variable  ~ exp(Temperature), data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ exp(Temperature), data=DifCWM_Envars))
# summary(lm(Variable  ~ I(1/Temperature), data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ I(1/Temperature), data=DifCWM_Envars))
# summary(lm(Variable  ~ Temperature + I(Temperature^2), data=DifCWM_Envars))
# summary(lm(log(Variable+1)  ~ Temperature + I(Temperature^2), data=DifCWM_Envars))

pca2_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, pca2)) + #Quadratic relationship with log(y)
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE), se=F) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "-0.09***", x = 23, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(pca2 ~ poly(Temperature, 2, raw=TRUE), data=DifCWM_Envars))), alpha = 0.8, fill = "#58038c")+
  geom_segment(aes(x = 8, y = 0, xend = 8, yend = -Inf), size=0.5, linetype="dashed") +
  xlab("Temperature C") + ylab(" PC2")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

##############Final graphs
###MAIN text
Graphs_Aridity <- grid.arrange(Height_Aridity, WoodDensity_Aridity, LeafN_Aridity, SeedMass_Aridity, RootDepth_Aridity,  pca1_Aridity, nrow=6)
Graphs_Temp <- grid.arrange(Height_Temperature, WoodDensity_Temperature, LeafN_Temperature, SeedMass_Temperature, RootDepth_Temperature,  pca1_Temperature, nrow=6)
Graph4 <- grid.arrange(Graphs_Temp, Graphs_Aridity, ncol=2, top=textGrob("Trait differences correlated with climate", gp=gpar(col="black", fontsize=21, fontface="bold")), padding = unit(3,"line"))

###SI
SI_Aridity_A <- grid.arrange(CrownDiameter_Aridity, BarkThickness_Aridity, StemConduitDiameter_Aridity, SLA_Aridity, LeafNP_Aridity, nrow=5)
SI_Temp_A <- grid.arrange(CrownDiameter_Temperature,  BarkThickness_Temperature, StemConduitDiameter_Temperature, SLA_Temperature, LeafNP_Temperature, nrow=5)
FigS2A <- grid.arrange(SI_Temp_A, SI_Aridity_A, ncol=2, top=textGrob("Trait differences correlated with climate", gp=gpar(col="black", fontsize=21, fontface="bold")), padding = unit(3,"line"))

SI_Aridity_B <- grid.arrange(CrownDiameter_Aridity,  BarkThickness_Aridity, StemConduitDiameter_Aridity, Gymnosperm_Aridity, pca2_Aridity, nrow=5)
SI_Temp_B <- grid.arrange(CrownDiameter_Temperature,  BarkThickness_Temperature, StemConduitDiameter_Temperature, Gymnosperm_Temperature, pca2_Temperature, nrow=5)
FigS2B <- grid.arrange(SI_Temp_B, SI_Aridity_B, ncol=2, padding = unit(3,"line")) #top=textGrob("Trait differences correlated with climate", gp=gpar(col="black", fontsize=25, fontface="bold"))

######Model
Plotsize <- DominantRare_Plot %>% dplyr::select(Biome, plot_id, Plotsize)
DifCWM_Envars <- left_join(DifCWM_Envars, Plotsize, by=c("Biome", "plot_id")) #Add Plotsize

model_Height <- lm(Height ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_Height)
VarImp_Height <- calc.relimp(model_Height, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
VarImp_Height <- as.data.frame(VarImp_Height@lmg)
VarImp_Height_Final <- VarImp_Height %>% rename(VarImp=`VarImp_Height@lmg`)
VarImp_Height_Final <- cbind(VarImp_Height_Final, summary(model_Height)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_Height_Final$Variable <- "Height"

model_CrownDiameter <- lm(CrownDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_CrownDiameter)
VarImp_CrownDiameter <- calc.relimp(model_CrownDiameter, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity*: contributing >5%
VarImp_CrownDiameter <- as.data.frame(VarImp_CrownDiameter@lmg)
VarImp_CrownDiameter_Final <- VarImp_CrownDiameter %>% rename(VarImp=`VarImp_CrownDiameter@lmg`)
VarImp_CrownDiameter_Final <- cbind(VarImp_CrownDiameter_Final, summary(model_CrownDiameter)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_CrownDiameter_Final$Variable <- "CrownDiameter"

model_BarkThickness <- lm(BarkThickness ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_BarkThickness)
VarImp_BarkThickness <- calc.relimp(model_BarkThickness, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
VarImp_BarkThickness <- as.data.frame(VarImp_BarkThickness@lmg)
VarImp_BarkThickness_Final <- VarImp_BarkThickness %>% rename(VarImp=`VarImp_BarkThickness@lmg`)
VarImp_BarkThickness_Final <- cbind(VarImp_BarkThickness_Final, summary(model_BarkThickness)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_BarkThickness_Final$Variable <- "BarkThickness"

model_WoodDensity <- lm(WoodDensity ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_WoodDensity)
VarImp_WoodDensity <- calc.relimp(model_WoodDensity, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity*: contributing >5%
VarImp_WoodDensity <- as.data.frame(VarImp_WoodDensity@lmg)
VarImp_WoodDensity_Final <- VarImp_WoodDensity %>% rename(VarImp=`VarImp_WoodDensity@lmg`)
VarImp_WoodDensity_Final <- cbind(VarImp_WoodDensity_Final, summary(model_WoodDensity)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_WoodDensity_Final$Variable <- "WoodDensity"

model_SLA <- lm(SLA ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_SLA)
VarImp_SLA <- calc.relimp(model_SLA, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity: contributing >5%
VarImp_SLA <- as.data.frame(VarImp_SLA@lmg)
VarImp_SLA_Final <- VarImp_SLA %>% rename(VarImp=`VarImp_SLA@lmg`)
VarImp_SLA_Final <- cbind(VarImp_SLA_Final, summary(model_SLA)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_SLA_Final$Variable <- "SLA"

model_LeafN <- lm(LeafN ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_LeafN)
VarImp_LeafN <- calc.relimp(model_LeafN, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_LeafN <- as.data.frame(VarImp_LeafN@lmg)
VarImp_LeafN_Final <- VarImp_LeafN %>% rename(VarImp=`VarImp_LeafN@lmg`)
VarImp_LeafN_Final <- cbind(VarImp_LeafN_Final, summary(model_LeafN)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_LeafN_Final$Variable <- "LeafN"

model_LeafNP <- lm(LeafNP ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_LeafNP)
VarImp_LeafNP <- calc.relimp(model_LeafNP, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_LeafNP <- as.data.frame(VarImp_LeafNP@lmg)
VarImp_LeafNP_Final <- VarImp_LeafNP %>% rename(VarImp=`VarImp_LeafNP@lmg`)
VarImp_LeafNP_Final <- cbind(VarImp_LeafNP_Final, summary(model_LeafNP)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_LeafNP_Final$Variable <- "LeafNP"

model_StemConduitDiam <- lm(StemConduitDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_StemConduitDiam)
VarImp_StemConduitDiam <- calc.relimp(model_StemConduitDiam, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_StemConduitDiam <- as.data.frame(VarImp_StemConduitDiam@lmg)
VarImp_StemConduitDiam_Final <- VarImp_StemConduitDiam %>% rename(VarImp=`VarImp_StemConduitDiam@lmg`)
VarImp_StemConduitDiam_Final <- cbind(VarImp_StemConduitDiam_Final, summary(model_StemConduitDiam)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_StemConduitDiam_Final$Variable <- "StemConduitDiam"

model_RootDepth <- lm(RootDepth ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_RootDepth)
VarImp_RootDepth <- calc.relimp(model_RootDepth, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_RootDepth <- as.data.frame(VarImp_RootDepth@lmg)
VarImp_RootDepth_Final <- VarImp_RootDepth %>% rename(VarImp=`VarImp_RootDepth@lmg`)
VarImp_RootDepth_Final <- cbind(VarImp_RootDepth_Final, summary(model_RootDepth)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_RootDepth_Final$Variable <- "RootDepth"

model_SeedMass <- lm(SeedMass ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_SeedMass)
VarImp_SeedMass <- calc.relimp(model_SeedMass, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_SeedMass <- as.data.frame(VarImp_SeedMass@lmg)
VarImp_SeedMass_Final <- VarImp_SeedMass %>% rename(VarImp=`VarImp_SeedMass@lmg`)
VarImp_SeedMass_Final <- cbind(VarImp_SeedMass_Final, summary(model_SeedMass)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_SeedMass_Final$Variable <- "SeedMass"

model_Gymnosperm <- lm(scale(PercInd_gymnosperm) ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_Gymnosperm)
VarImp_Gymnosperm <- calc.relimp(model_Gymnosperm, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_Gymnosperm <- as.data.frame(VarImp_Gymnosperm@lmg)
VarImp_Gymnosperm_Final <- VarImp_Gymnosperm %>% dplyr::rename(VarImp="VarImp_Gymnosperm@lmg")
VarImp_Gymnosperm_Final <- cbind(VarImp_Gymnosperm_Final, summary(model_Gymnosperm)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_Gymnosperm_Final$Variable <- "Gymnosperm"

model_pca1 <- lm(pca1 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_pca1)
VarImp_pca1 <- calc.relimp(model_pca1, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_pca1 <- as.data.frame(VarImp_pca1@lmg)
VarImp_pca1_Final <- VarImp_pca1 %>% rename(VarImp=`VarImp_pca1@lmg`)
VarImp_pca1_Final <- cbind(VarImp_pca1_Final, summary(model_pca1)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_pca1_Final$Variable <- "pca1"

model_pca2 <- lm(pca2 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Aridity) + I(scale(Aridity)^2) + scale(Temperature)*scale(Aridity) + scale(Temperature)*I(scale(Aridity)^2) + I(scale(Temperature)^2)*scale(Aridity) + I(scale(Temperature)^2)*I(scale(Aridity)^2) + scale(Elevation) + scale(Forest_Age) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_pca2)
VarImp_pca2 <- calc.relimp(model_pca2, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Aridity-Aridity2*: contributing >5%
VarImp_pca2 <- as.data.frame(VarImp_pca2@lmg)
VarImp_pca2_Final <- VarImp_pca2 %>% rename(VarImp=`VarImp_pca2@lmg`)
VarImp_pca2_Final <- cbind(VarImp_pca2_Final, summary(model_pca2)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_pca2_Final$Variable <- "pca2"

Final_models <- rbind(VarImp_Height_Final, VarImp_CrownDiameter_Final, VarImp_BarkThickness_Final, VarImp_WoodDensity_Final, VarImp_SLA_Final, VarImp_LeafN_Final, VarImp_LeafNP_Final, VarImp_StemConduitDiam_Final, VarImp_RootDepth_Final, VarImp_SeedMass_Final, VarImp_Gymnosperm_Final, VarImp_pca1_Final, VarImp_pca2_Final)

Final_models <- tibble::rownames_to_column(Final_models, "Term")

write_xlsx(Final_models, "Final_models_5-2024.xlsx") #Final_models.xlsx

#########################INTERACTIONS
###General model
Model_AT <- gam(Aridity ~ Temperature, data=DifCWM_Envars)
Data_AT <- with(DifCWM_Envars, data.frame(Temperature = seq(min(Temperature), max(Temperature), len=1000))) %>% mutate(Aridity = predict(Model_AT, newdata = (.), se = FALSE), Aridity_se = predict(Model_AT, newdata = (.), se = TRUE)$se) %>%
mutate(Aridity_upper = Aridity+1.96*Aridity_se, Aridity_lower = Aridity-1.96*Aridity_se)

dummy_dat <- with(DifCWM_Envars, data.frame(Temperature = seq(min(Temperature), max(Temperature), len=1000))) #Forest_AgeScaled=mean(Forest_AgeScaled, na.rm=T)

AI_cut <- quantile(DifCWM_Envars$Aridity, c(0.08, 0.988, 1), na.rm=T) #0.55, 0.988, 1 #0.08, 0.5, 0.98
AI_cut

all_dat <- data.frame()

for(i in 1:length(AI_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(Aridity = AI_cut[i]))}

###Graphs
Model_AridityTemp <- lm(Height  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(Height = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

Height_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=Height, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" Height") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 10, y = 0, xend = 10, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(CrownDiameter  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(CrownDiameter = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

CrownDiameter_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=CrownDiameter, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" CrownDiameter") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 4, y = 0, xend = 4, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(BarkThickness  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(BarkThickness = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

BarkThickness_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=BarkThickness, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" Bark Thickness") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 12, y = 0, xend = 12, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(WoodDensity  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(WoodDensity = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

WoodDensity_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=WoodDensity, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" Wood Density") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 9, y = 0, xend = 9, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(SLA  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(SLA = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

SLA_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=SLA, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" SLA") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 6, y = 0, xend = 6, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(LeafN  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(LeafN = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

LeafN_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=LeafN, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" LeafN") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 5, y = 0, xend = 5, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(LeafNP  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(LeafNP = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

LeafNP_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=LeafNP, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" Leaf NP") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 2, y = 0, xend = 2, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(StemConduitDiameter  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(StemConduitDiameter = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

StemConduitDiameter_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=StemConduitDiameter, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" Stem Conduit Diam.") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 7, y = 0, xend = 7, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(RootDepth  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(RootDepth = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

RootDepth_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=RootDepth, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" Root Depth") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 6, y = 0, xend = 6, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(SeedMass  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(SeedMass = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

SeedMass_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=SeedMass, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" Seed Mass") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 10, y = 0, xend = 10, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(pca1  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(pca1 = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

pca1_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=pca1, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" pca1") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 8, y = 0, xend = 8, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Model_AridityTemp <- lm(pca2  ~ Temperature * Aridity, data=DifCWM_Envars)
all_Temp <- all_dat %>% mutate(pca2 = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()
all_Temp$Aridity <- factor(all_Temp$Aridity)

pca2_TempAridity <- ggplot(all_Temp, aes(x=Temperature, y=pca2, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab(" pca2") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#fab302", "#9e7306", "#4a3501"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 8, y = 0, xend = 8, yend = -Inf), size=0.5, linetype="dashed", colour="black") +
  theme(legend.position = "none",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))

Fig4C <- grid.arrange(CrownDiameter_TempAridity, Height_TempAridity, WoodDensity_TempAridity, StemConduitDiameter_TempAridity, BarkThickness_TempAridity, LeafN_TempAridity, LeafNP_TempAridity, SLA_TempAridity, RootDepth_TempAridity, SeedMass_TempAridity, pca1_TempAridity, pca2_TempAridity, nrow=4, top=textGrob("Trait differences correlated with interaction temperature & aridity", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

```
###Fig. 4 Stats
```{r Fig. 4 Stats}

DifCWM_Envars$TemperatureScaled <- scale(DifCWM_Envars$Temperature)
DifCWM_Envars$AridityScaled <- scale(log(DifCWM_Envars$Aridity))
DifCWM_Envars$Forest_AgeScaled <- scale(DifCWM_Envars$Forest_Age)
Data_DifCWM_compl <- DifCWM_Envars[complete.cases(DifCWM_Envars$Forest_AgeScaled), ]

Heightlm <- lm(Height  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled + factor(Biome) + scale(Elevation), data=Data_DifCWM_compl) #0.06

HeightPoly <- lm(Height ~ poly(TemperatureScaled, 2, raw=TRUE)*poly(AridityScaled, 2, raw=TRUE) + Forest_AgeScaled + factor(Biome) + scale(Elevation), data=Data_DifCWM_compl)

library(car)
summary(Heightlm)
summary(HeightPoly)
vif(Heightlm)
plot(Heightlm)
```
###Fig.SI Biomes-Climate
```{r Fig. SI Biomes-Climate}

Plot_TraitsEnv_select <- Plot_TraitsEnv %>% group_by(Biome, plot_id) %>% slice(1)

colors <- c("#ffdd03", "#8fd613", "#3f5220", "#0281a8", "#00549e", "#270169")
Biomes_Temperature <- ggplot(Plot_TraitsEnv_select, aes(factor(Biome), Temperature)) + 
  geom_boxplot(col=colors) +
  scale_x_discrete(labels=c("1" = "Tropical moist", "2" = "Tropical dry", "3" = "Tropical conifer", "4"="Temperate", "5"="Temperate Conifer", "6"="Boreal")) +
  ylab("Mean annual temperature C") + xlab("Biomes") + ggtitle("Temperature in forest biomes") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_Humidity <- ggplot(Plot_TraitsEnv_select, aes(factor(Biome), Humidity)) + 
  geom_boxplot(col=colors) +
  scale_x_discrete(labels=c("1" = "Tropical moist", "2" = "Tropical dry", "3" = "Tropical conifer", "4"="Temperate", "5"="Temperate Conifer", "6"="Boreal")) +
  ylab("Humidity") + xlab("Biomes") + ggtitle("Water availability in forest biomes") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

grid.arrange(Biomes_Temperature, Biomes_Humidity, nrow=2)

#SI graph: Forest biomes-plotsize

colors <- c("#ffdd03", "#8fd613", "#3f5220", "#0281a8", "#00549e", "#270169")
Biomes_PlotSize <- ggplot(Plot_TraitsEnv_select, aes(factor(Biome), log(Plotsize))) + 
  geom_boxplot(col=colors) +
  scale_x_discrete(labels=c("1" = "Tropical moist", "2" = "Tropical dry", "3" = "Tropical conifer", "4"="Temperate", "5"="Temperate Conifer", "6"="Boreal")) +
  ylab("log(Plot size (ha))") + xlab("Biomes") + ggtitle("Plot size in forest biomes") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_Richness <- ggplot(Plot_TraitsEnv_select, aes(factor(Biome), log(SumS))) + 
  geom_boxplot(col=colors) +
  scale_x_discrete(labels=c("1" = "Tropical moist", "2" = "Tropical dry", "3" = "Tropical conifer", "4"="Temperate", "5"="Temperate Conifer", "6"="Boreal")) +
  ylab("log(Species richness)") + xlab("Biomes") + ggtitle("Richness in forest biomes") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_MeasurementYear <- ggplot(Plot_TraitsEnv_select, aes(factor(Biome), year)) + 
  geom_boxplot(col=colors) +
  scale_x_discrete(labels=c("1" = "Tropical moist", "2" = "Tropical dry", "3" = "Tropical conifer", "4"="Temperate", "5"="Temperate Conifer", "6"="Boreal")) +
  ylab("Measurement year") + xlab("Biomes") + ggtitle("Measurement year forest biomes") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

ForestAge <- DifCWM_Envars %>% group_by(Biome, plot_id) %>% slice(1)
Biomes_ForestAge <- ggplot(ForestAge, aes(factor(Biome), Forest_Age)) + 
  geom_boxplot(col=colors) +
  scale_x_discrete(labels=c("1" = "Tropical moist", "2" = "Tropical dry", "3" = "Tropical conifer", "4"="Temperate", "5"="Temperate Conifer", "6"="Boreal")) +
  ylab("Forest age (year)") + xlab("Biomes") + ggtitle("Age forest biomes") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

grid.arrange(Biomes_MeasurementYear, Biomes_ForestAge, Biomes_PlotSize, Biomes_Richness, nrow=2)


#SI graph: Distributions traits
Plot_SpTraitsCompl_select <- Plot_SpTraitsCompl %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass) %>% as.data.frame()

t_Plot_SpTraitsCompl <- transpose(Plot_SpTraitsCompl_select) # transpose
t_Plot_SpTraitsCompl <- as.data.frame(t_Plot_SpTraitsCompl)
  
colnames(t_Plot_SpTraitsCompl) <- rownames(Plot_SpTraitsCompl) # get row and colnames in order
rownames(t_Plot_SpTraitsCompl) <- colnames(Plot_SpTraitsCompl)

Biomes_TraitsHeight <- ggplot(Plot_SpTraitsCompl_select, aes(x=Height)) + 
  geom_histogram() + xlab("Height (m)") + ylab("Count") + ggtitle("Distribution of height") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsCrownDiameter <- ggplot(Plot_SpTraitsCompl_select, aes(x=CrownDiameter)) + 
  geom_histogram() + xlab("Crown diameter (m)") + ylab("Count") + ggtitle("Distribution of Crown diameter") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsBarkThickness <- ggplot(Plot_SpTraitsCompl_select, aes(x=BarkThickness)) + 
  geom_histogram() + xlab("Bark thickness (mm)") + ylab("Count") + ggtitle("Distribution of Bark thickness") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsWoodDensity <- ggplot(Plot_SpTraitsCompl_select, aes(x=WoodDensity)) + 
  geom_histogram() + xlab("Wood density (g dry/cm3 wet)") + ylab("Count") + ggtitle("Distribution of Wood density") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsSLA <- ggplot(Plot_SpTraitsCompl_select, aes(x=SLA)) + 
  geom_histogram() + xlab("SLA (mm2/mg)") + ylab("Count") + ggtitle("Distribution of SLA") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsLeafN <- ggplot(Plot_SpTraitsCompl_select, aes(x=LeafN)) + 
  geom_histogram() + xlab("Leaf N (mg/g)") + ylab("Count") + ggtitle("Distribution of Leaf N") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsLeafNP <- ggplot(Plot_SpTraitsCompl_select, aes(x=LeafNP)) + 
  geom_histogram() + xlab("Leaf NP (mg/g)") + ylab("Count") + ggtitle("Distribution of Leaf NP") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsStemConduitDiameter <- ggplot(Plot_SpTraitsCompl_select, aes(x=StemConduitDiameter)) + 
  geom_histogram() + xlab("Stem conduit diameter (m)") + ylab("Count") + ggtitle("Distribution of Stem conduit diameter") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsRootDepth <- ggplot(Plot_SpTraitsCompl_select, aes(x=RootDepth)) + 
  geom_histogram() + xlab("Root depth (m)") + ylab("Count") + ggtitle("Distribution of Root depth") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Biomes_TraitsSeedMass <- ggplot(Plot_SpTraitsCompl_select, aes(x=SeedMass)) + 
  geom_histogram() + xlab("Seed mass (mg)") + ylab("Count") + ggtitle("Distribution of Seed mass") +
  theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

grid.arrange(Biomes_TraitsHeight, Biomes_TraitsCrownDiameter, Biomes_TraitsBarkThickness, Biomes_TraitsWoodDensity, Biomes_TraitsSLA, Biomes_TraitsLeafN, Biomes_TraitsLeafNP, Biomes_TraitsStemConduitDiameter, Biomes_TraitsRootDepth, Biomes_TraitsSeedMass, ncol=2)

```
###Biome level boxplots
```{r Biome level boxplots}
###Match species with trait data
setwd("~/Desktop")
Traits <- read_feather("~/Desktop/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))

rm(Traits)

setwd("~/Documents/PhD projects/Traits Dominant Species")
Species_Biome <- fread("~/Documents/PhD projects/Traits Dominant Species/DominantRare_Biome_8-2021.csv")

Biome_SpTraits <- left_join(Species_Biome, Traits_Select, by="obs_id")

rm(Species_Biome, Traits_Select)

###Log transform and scale traits 
#boxplot(Biome_SpTraits$RootCN) #Check if log transformation is necessary
Biome_SpTraitsCompl <- Biome_SpTraits[complete.cases(Biome_SpTraits),]#Erase incomplete rows: 0.70% #100-(12816859/12907085)*100

fwrite(Biome_SpTraitsCompl, file="Biome_Traits_8-2021.csv")

#Biome_SpTraitsCompl <- fread("~/Documents/PhD projects/Traits Dominant Species/Biome_Traits_8-2021.csv")
Biome_SpTraitsLog <- Biome_SpTraitsCompl %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Biome_SpTraitsMean <- Biome_SpTraitsLog %>% group_by(Biome, plot_id, species_name) %>% slice(1) #%>% summarise_at(vars(-c(NrInd)), mean)  #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Biome_TraitsNrInd <- Biome_SpTraitsLog %>% group_by(Biome, plot_id, species_name) %>% summarise(NrIndSp=sum(NrInd)) 
Biome_TraitsMeanMerge <- as.data.frame(left_join(Biome_SpTraitsMean, Biome_TraitsNrInd, by=c("plot_id","species_name")))
Biome_TraitsMeanMerge <- subset(Biome_TraitsMeanMerge, select = -c(Biome.y, dbh, NrInd, NrIndSp))
setnames(Biome_TraitsMeanMerge, old="Biome.x", new="Biome")

Biome_TraitsScaled <- Biome_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), scale) #Standardise trait values by biome or globally group_by(Biome) %>% 
Biome_TraitsScaled <- as.data.frame(Biome_TraitsScaled)

rm(Biome_SpTraits, Biome_SpTraitsCompl, Biome_SpTraitsLog, Biome_SpTraitsMean, Biome_TraitsNrInd, Biome_TraitsMeanMerge)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Biome_TraitsScaled, file="Biome_TraitsScaledGlobally_8-2021.csv") #Scaled globally

###Boxplots
Biome_TraitsScaled <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Biome_TraitsScaledGlobally_8-2021.csv")
Biome_TraitsScaled <- subset(Biome_TraitsScaled, select=c(Biome, species_name, DominanceCategory, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))

Biome_TraitsDRScaled <- Biome_TraitsScaled[which(Biome_TraitsScaled$DominanceCategory == "rare" | Biome_TraitsScaled$DominanceCategory == "dominant"),]


TraitsDRScaled_CI <- as.data.frame(Biome_TraitsDRScaled %>% group_by(Biome, DominanceCategory) %>% summarise(
                  MeanHeight = mean(Height), uCI_Height = CI(Height)["upper"], lCI_Height = CI(Height)["lower"],
                  MeanCrownDiameter = mean(CrownDiameter), uCI_CrownDiameter = CI(CrownDiameter)["upper"], lCI_CrownDiameter = CI(CrownDiameter)["lower"],
                  MeanBarkThickness = mean(BarkThickness), uCI_BarkThickness = CI(BarkThickness)["upper"], lCI_BarkThickness = CI(BarkThickness)["lower"],
                  MeanWoodDensity = mean(WoodDensity), uCI_WoodDensity = CI(WoodDensity)["upper"], lCI_WoodDensity = CI(WoodDensity)["lower"],
                  MeanSLA = mean(SLA), uCI_SLA = CI(SLA)["upper"], lCI_SLA = CI(SLA)["lower"],
                  MeanLeafN = mean(LeafN), uCI_LeafN = CI(LeafN)["upper"], lCI_LeafN = CI(LeafN)["lower"],
                  MeanLeafNP = mean(LeafNP), uCI_LeafNP = CI(LeafNP)["upper"], lCI_LeafNP = CI(LeafNP)["lower"],
                  MeanConduitDiameter = mean(StemConduitDiameter), uCI_ConduitDiameter = CI(StemConduitDiameter)["upper"], lCI_ConduitDiameter = CI(StemConduitDiameter)["lower"],
                  MeanRootDepth = mean(RootDepth), uCI_RootDepth = CI(RootDepth)["upper"], lCI_RootDepth = CI(RootDepth)["lower"],
                  MeanSeedMass = mean(SeedMass), uCI_SeedMass = CI(SeedMass)["upper"], lCI_SeedMass = CI(SeedMass)["lower"]))

TraitsDRMean <- as.data.frame(Biome_TraitsDRScaled %>% group_by(Biome, DominanceCategory) %>% summarise(n = n(), MeanHeight=mean(Height), seHeight=(sd(Height)/sqrt(n)),   MeanCrownDiameter=mean(CrownDiameter), seCrownDiameter=(sd(CrownDiameter)/sqrt(n)), MeanBarkThickness=mean(BarkThickness), seBarkThickness=(sd(BarkThickness)/sqrt(n)), MeanWoodDensity=mean(WoodDensity), seWoodDensity=(sd(WoodDensity)/sqrt(n)), 
MeanSLA=mean(SLA), seSLA=(sd(SLA)/sqrt(n)), MeanLeafN=mean(LeafN), seLeafN=(sd(LeafN)/sqrt(n)), MeanLeafNP=mean(LeafNP), seLeafNP=(sd(LeafNP)/sqrt(n)), MeanStemConduitD=mean(StemConduitDiameter), seStemConduitD=(sd(StemConduitDiameter)/sqrt(n)),
MeanRootDepth=mean(RootDepth), seRootDepth=(sd(RootDepth)/sqrt(n)), MeanSeedMass=mean(SeedMass), seSeedMass=(sd(SeedMass)/sqrt(n))))

TraitsRMean <- TraitsDRMean[which(TraitsDRMean$DominanceCategory == "rare"),]
TraitsRMean$Biome <- as.factor(TraitsRMean$Biome)

########################Plot level analyses
###Global boxplot
Plot_TraitsScaled <- fread("~/Documents/PhD projects/Traits Dominant Species/Biome_TraitsScaledGlobally_8-2021.csv")
Plot_TraitsScaled <- subset(Plot_TraitsScaled, select=c(Biome, plot_id, species_name, DominanceCategory, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))

PlotTraits_CWM <- Plot_TraitsScaled %>% group_by(Biome, plot_id, DominanceCategory) %>% summarise_at(c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP","StemConduitDiameter", "RootDepth", "SeedMass"), mean) %>% as.data.frame()

set.seed(10)
Biome1_TraitsScaled <- DiffDomRare_CWM %>% filter(Biome==1) %>% sample_n(4017) #sample_n(1694) #DiffDomRare_CWM for difference in CWM
Biome2_TraitsScaled <- DiffDomRare_CWM %>% filter(Biome==2) %>% sample_n(1000) #sample_n(1000)
Biome3_TraitsScaled <- DiffDomRare_CWM %>% filter(Biome==3) %>% sample_n(296) #sample_n(20)
Biome4_TraitsScaled <- DiffDomRare_CWM %>% filter(Biome==4) %>% sample_n(1760) #sample_n(1000)
Biome5_TraitsScaled <- DiffDomRare_CWM %>% filter(Biome==5) %>% sample_n(1000) #sample_n(1000)
Biome6_TraitsScaled <- DiffDomRare_CWM %>% filter(Biome==6) %>% sample_n(2938) #sample_n(1239)

TraitsScaled_Global <- rbind(Biome1_TraitsScaled, Biome2_TraitsScaled, Biome3_TraitsScaled, Biome4_TraitsScaled, Biome5_TraitsScaled, Biome6_TraitsScaled)

###
DiffCWM_Global_CI <- TraitsScaled_Global %>% dplyr::summarise(
                  MeanHeight = mean(Height), uCI_Height = CI(Height,ci = 0.95)["upper"], lCI_Height = CI(Height,ci = 0.95)["lower"],
                  MeanCrownDiameter = mean(CrownDiameter), uCI_CrownDiameter = CI(CrownDiameter,ci = 0.95)["upper"], lCI_CrownDiameter = CI(CrownDiameter,ci = 0.95)["lower"],
                  MeanBarkThickness = mean(BarkThickness), uCI_BarkThickness = CI(BarkThickness,ci = 0.95)["upper"], lCI_BarkThickness = CI(BarkThickness,ci = 0.95)["lower"],
                  MeanWoodDensity = mean(WoodDensity), uCI_WoodDensity = CI(WoodDensity,ci = 0.95)["upper"], lCI_WoodDensity = CI(WoodDensity,ci = 0.95)["lower"],
                  MeanSLA = mean(SLA), uCI_SLA = CI(SLA,ci = 0.95)["upper"], lCI_SLA = CI(SLA,ci = 0.95)["lower"],
                  MeanLeafN = mean(LeafN), uCI_LeafN = CI(LeafN,ci = 0.95)["upper"], lCI_LeafN = CI(LeafN,ci = 0.95)["lower"],
                  MeanLeafNP = mean(LeafNP), uCI_LeafNP = CI(LeafNP,ci = 0.95)["upper"], lCI_LeafNP = CI(LeafNP,ci = 0.95)["lower"],
                  MeanConduitDiameter = mean(StemConduitDiameter,ci = 0.95), uCI_ConduitDiameter = CI(StemConduitDiameter,ci = 0.95)["upper"], lCI_ConduitDiameter = CI(StemConduitDiameter)["lower"],
                  MeanRootDepth = mean(RootDepth), uCI_RootDepth = CI(RootDepth,ci = 0.95)["upper"], lCI_RootDepth = CI(RootDepth,ci = 0.95)["lower"],
                  MeanSeedMass = mean(SeedMass), uCI_SeedMass = CI(SeedMass,ci = 0.95)["upper"], lCI_SeedMass = CI(SeedMass,ci = 0.95)["lower"]) %>% as.data.frame()

###Boxplots confidence interval Global
DiffCWM_Global <- fread("~/Documents/PhD projects/Traits Dominant Species/Traits_global.csv")

DiffCWM_Global$Trait <- factor(DiffCWM_Global$Trait, levels=c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "ConduitDiameter", "SLA", "LeafN", "LeafNP", "RootDepth", "SeedMass"))

position <- position_dodge(0.75)

DiffCWM_Global <- DiffCWM_Global[ which(DiffCWM_Global$DominanceCategory=='dif'), ]
BoxplotGlobal <- ggplot(TraitsScaled_Global, aes(x=factor(Trait), y=Mean, colour=DominanceCategory)) + 
  geom_rect(ymin=0, ymax=0.2, xmin=0, xmax=11, fill="#970af0", alpha=0.1) +
  geom_rect(ymin=0, ymax=-0.23, xmin=0, xmax=11, fill="#e851cc", alpha=0.1) +
  geom_errorbar(aes(ymin=lCI, ymax=uCI, group=DiffCWM_Global$DominanceCategory), color="black", width=.1, position=position) +
  scale_color_manual(values=c(dif="black")) + #"dominant"="#970af0", "rare"="#e851cc", dif="grey")
  geom_point(position=position, size=5) +
   labs(title="Global traits") + labs(x=" ", y="Scaled trait value") + 
  #geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

###Global statistics
TraitsScaled_Global <- TraitsScaled_Global[ which(TraitsScaled_Global$DominanceCategory=='rare' | TraitsScaled_Global$DominanceCategory== "dominant"), ]
TraitsScaled_Global$DominanceCategory <- ifelse(TraitsScaled_Global$DominanceCategory == "dominant", "2", "1") #2=dominant, 1=rare
TraitsScaled_Global$DominanceCategory <- as.numeric(TraitsScaled_Global$DominanceCategory)
a <- wilcox.test(TraitsScaled_Global$DominanceCategory, TraitsScaled_Global$Height)
b <- t.test(TraitsScaled_Global$DominanceCategory ~  TraitsScaled_Global$Height)

Results_Wilcoxon <- as.data.frame(TraitsScaled_Global %>%    summarise(Pvalue_Height = wilcox.test(Height ~ DominanceCategory)$p.value,
                                                             Pvalue_CrownDiameter = wilcox.test(CrownDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_BarkThickness = wilcox.test(BarkThickness ~ DominanceCategory)$p.value,
                                                             Pvalue_WoodDensity = wilcox.test(WoodDensity ~ DominanceCategory)$p.value,
                                                             Pvalue_SLA = wilcox.test(SLA ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafN = wilcox.test(LeafN ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafNP = wilcox.test(LeafNP ~ DominanceCategory)$p.value,
                                                             Pvalue_StemConduitDiameter = wilcox.test(StemConduitDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_RootDepth = wilcox.test(RootDepth ~ DominanceCategory)$p.value,
                                                             Pvalue_SeedMass = wilcox.test(SeedMass ~ DominanceCategory)$p.value))

TraitsScaled_Global$Biome <- as.character(TraitsScaled_Global$Biome)
TraitsScaled_Global$Height <- as.integer(TraitsScaled_Global$Height)
TraitsScaled_Global$Height <- as.numeric(TraitsScaled_Global$Height)

TraitsScaled_Global[,1:12] <- sapply(TraitsScaled_Global[,1:12],as.numeric)
TraitsScaled_Global <- TraitsScaled_Global %>% mutate_if(is.double, as.numeric)

DataSpread <- TraitsScaled_Global %>% pivot_longer(cols= Height:SeedMass, names_to= "Trait", values_to="Value") %>% as.data.frame()
DataSpread <- DataSpread[ which(DataSpread$DominanceCategory=='rare' | DataSpread$DominanceCategory== "dominant"), ]

DataSpread$Trait <- factor(DataSpread$Trait, levels=c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "StemConduitDiameter", "SLA", "LeafN", "LeafNP", "RootDepth", "SeedMass"))

DataSpreadSelect <- DataSpread[ which(DataSpread$Value <= 1 & DataSpread$Value >= -1), ]

ViolinGlobal <- ggplot(DataSpreadSelect, aes(x=Trait, y=Value)) + #colour=DominanceCategory
  #geom_errorbar(aes(ymin=lCI, ymax=uCI, group=DiffCWM_Global$DominanceCategory), color="black", width=.1, position=position) +
  #scale_color_manual(values=c("dominant"="#970af0", "rare"="#e851cc")) +
  #geom_violin(position=position, size=2) +
  geom_boxplot(width=0.1, position = position) + theme_minimal() +
   labs(title="Global traits") + labs(x=" ", y="Scaled trait value") +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + 
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

####Plot level analyses
###Test differences means
Plot_TraitsScaled <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Biome_TraitsScaledGlobally_8-2021.csv")
Plot_TraitsScaled <- subset(Plot_TraitsScaled, select=c(Biome, plot_id, species_name, DominanceCategory, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))

PlotTraits_CWM <- Plot_TraitsScaled %>% group_by(Biome, plot_id, DominanceCategory) %>% summarise_at(c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP","StemConduitDiameter", "RootDepth", "SeedMass"), mean)

PlotTraits_CWM$DominanceCategory <- ifelse(PlotTraits_CWM$DominanceCategory == "dominant", "2", "1") #2=dominant, 1=rare
PlotTraits_CWM$DominanceCategory <- as.numeric(PlotTraits_CWM$DominanceCategory)
a <- wilcox.test(PlotTraits_CWM$DominanceCategory, PlotTraits_CWM$Height)
b <- t.test(PlotTraits_CWM$DominanceCategory ~  PlotTraits_CWM$Height)

Checkn <- PlotTraits_CWM %>% group_by(Biome) %>% dplyr::summarise(n = n())

Results_Wilcoxon <- as.data.frame(PlotTraits_CWM %>% group_by(Biome) %>% summarise(Pvalue_Height = wilcox.test(Height ~ DominanceCategory)$p.value,
                                                             Pvalue_CrownDiameter = wilcox.test(CrownDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_BarkThickness = wilcox.test(BarkThickness ~ DominanceCategory)$p.value,
                                                             Pvalue_WoodDensity = wilcox.test(WoodDensity ~ DominanceCategory)$p.value,
                                                             Pvalue_SLA = wilcox.test(SLA ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafN = wilcox.test(LeafN ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafNP = wilcox.test(LeafNP ~ DominanceCategory)$p.value,
                                                             Pvalue_StemConduitDiameter = wilcox.test(StemConduitDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_RootDepth = wilcox.test(RootDepth ~ DominanceCategory)$p.value,
                                                             Pvalue_SeedMass = wilcox.test(SeedMass ~ DominanceCategory)$p.value))

Results_Ttest <- as.data.frame(PlotTraits_CWM %>% group_by(Biome) %>% summarise(Pvalue_Height = t.test(Height ~ DominanceCategory)$p.value,
                                                             Pvalue_CrownDiameter = t.test(CrownDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_BarkThickness = t.test(BarkThickness ~ DominanceCategory)$p.value,
                                                             Pvalue_WoodDensity = t.test(WoodDensity ~ DominanceCategory)$p.value,
                                                             Pvalue_SLA = t.test(SLA ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafN = t.test(LeafN ~ DominanceCategory)$p.value,
                                                             Pvalue_LeafNP = t.test(LeafNP ~ DominanceCategory)$p.value,
                                                             Pvalue_StemConduitDiameter = t.test(StemConduitDiameter ~ DominanceCategory)$p.value,
                                                             Pvalue_RootDepth = t.test(RootDepth ~ DominanceCategory)$p.value,
                                                             Pvalue_SeedMass = t.test(SeedMass ~ DominanceCategory)$p.value))

###Calculate mean
library(Rmisc)

DiffCWM_PlotLevel_CI <- DiffDomRare_CWM %>% dplyr::group_by(Biome) %>% dplyr::summarise(
                  MeanHeight = mean(Height), uCI_Height = CI(Height,ci = 0.95)["upper"], lCI_Height = CI(Height,ci = 0.95)["lower"],
                  MeanCrownDiameter = mean(CrownDiameter), uCI_CrownDiameter = CI(CrownDiameter,ci = 0.95)["upper"], lCI_CrownDiameter = CI(CrownDiameter,ci = 0.95)["lower"],
                  MeanBarkThickness = mean(BarkThickness), uCI_BarkThickness = CI(BarkThickness,ci = 0.95)["upper"], lCI_BarkThickness = CI(BarkThickness,ci = 0.95)["lower"],
                  MeanWoodDensity = mean(WoodDensity), uCI_WoodDensity = CI(WoodDensity,ci = 0.95)["upper"], lCI_WoodDensity = CI(WoodDensity,ci = 0.95)["lower"],
                  MeanSLA = mean(SLA), uCI_SLA = CI(SLA,ci = 0.95)["upper"], lCI_SLA = CI(SLA,ci = 0.95)["lower"],
                  MeanLeafN = mean(LeafN), uCI_LeafN = CI(LeafN,ci = 0.95)["upper"], lCI_LeafN = CI(LeafN,ci = 0.95)["lower"],
                  MeanLeafNP = mean(LeafNP), uCI_LeafNP = CI(LeafNP,ci = 0.95)["upper"], lCI_LeafNP = CI(LeafNP,ci = 0.95)["lower"],
                  MeanConduitDiameter = mean(StemConduitDiameter,ci = 0.95), uCI_ConduitDiameter = CI(StemConduitDiameter,ci = 0.95)["upper"], lCI_ConduitDiameter = CI(StemConduitDiameter)["lower"],
                  MeanRootDepth = mean(RootDepth), uCI_RootDepth = CI(RootDepth,ci = 0.95)["upper"], lCI_RootDepth = CI(RootDepth,ci = 0.95)["lower"],
                  MeanSeedMass = mean(SeedMass), uCI_SeedMass = CI(SeedMass,ci = 0.95)["upper"], lCI_SeedMass = CI(SeedMass,ci = 0.95)["lower"]) %>% as.data.frame()

# DiffCWM_PlotLevel_SE <- as.data.frame(DiffDomRare_CWM %>% group_by(Biome) %>% summarise(n = n(), MeanHeight=mean(Height), seHeight=(sd(Height)/sqrt(n)),   MeanCrownDiameter=mean(CrownDiameter), seCrownDiameter=(sd(CrownDiameter)/sqrt(n)), MeanBarkThickness=mean(BarkThickness), seBarkThickness=(sd(BarkThickness)/sqrt(n)), MeanWoodDensity=mean(WoodDensity), seWoodDensity=(sd(WoodDensity)/sqrt(n)),
# MeanSLA=mean(SLA), seSLA=(sd(SLA)/sqrt(n)), MeanLeafN=mean(LeafN), seLeafN=(sd(LeafN)/sqrt(n)), MeanLeafNP=mean(LeafNP), seLeafNP=(sd(LeafNP)/sqrt(n)), MeanStemConduitD=mean(StemConduitDiameter), seStemConduitD=(sd(StemConduitDiameter)/sqrt(n)),
# MeanRootDepth=mean(RootDepth), seRootDepth=(sd(RootDepth)/sqrt(n)), MeanSeedMass=mean(SeedMass), seSeedMass=(sd(SeedMass)/sqrt(n))))

#Filter out tropical conifer forest
unique(DiffCWM_PlotLevel_CI$Biome)
DiffCWM_PlotLevel_CI <- DiffCWM_PlotLevel_CI[which(DiffCWM_PlotLevel_CI$Biome!=3),]

 ###Boxplots confidence interval
 BoxplotHeight <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanHeight)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_Height, ymax=uCI_Height), color="black", width=.1) +
   labs(title="Tree Height") + labs(x=" ", y="Difference Tree height") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotCrownDiameter <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanCrownDiameter)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75))+
   geom_errorbar(aes(ymin=lCI_CrownDiameter, ymax=uCI_CrownDiameter), color="black", width=.1) +
   labs(title="Crown diameter") + labs(x=" ", y="Difference Crown diameter") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotBarkThickness <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanBarkThickness)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_BarkThickness, ymax=uCI_BarkThickness), color="black", width=.1) +
   labs(title="Bark thickness") +
   labs(x=" ", y="Difference Bark thickness") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotWoodDensity <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanWoodDensity)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_WoodDensity, ymax=uCI_WoodDensity), color="black", width=.1) +
   labs(title="Wood density") +
   labs(x=" ", y="Difference Wood density") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotSLA <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanSLA)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_SLA, ymax=uCI_SLA), color="black", width=.1) +
   labs(title="Specific leaf area") +
   labs(x=" ", y="Difference SLA") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotLeafN <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanLeafN)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_LeafN, ymax=uCI_LeafN), color="black", width=.1) +
   labs(title="Leaf nitrogen") +
   labs(x=" ", y="Difference Leaf N") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotLeafNP <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanLeafNP)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_LeafNP, ymax=uCI_LeafNP), color="black", width=.1) +
   labs(title="Leaf N/P ratio") +
   labs(x=" ", y="Difference Leaf NP") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotStemConduitD <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanConduitDiameter)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_ConduitDiameter, ymax=uCI_ConduitDiameter), color="black", width=.1) +
   labs(title="Stem Conduit Diameter") +
   labs(x=" ", y="Difference Stem Conduit Diam.") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotRootDepth <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanRootDepth)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_RootDepth, ymax=uCI_RootDepth), color="black", width=.1) +
   labs(title="Root depth") +
   labs(x=" ", y="Difference Root depth") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom", breaks = c("1", "2", "4", "5", "6"), labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotSeedMass <- ggplot(DiffCWM_PlotLevel_CI, aes(x=as.factor(Biome), y=MeanSeedMass)) + geom_point(colour="#047000", size=4, position = position_dodge(width=0.75)) +
   geom_errorbar(aes(ymin=lCI_SeedMass, ymax=uCI_SeedMass), color="black", width=.1) +
   labs(title="Seed mass") +
   labs(x=" ", y="Difference Seed mass") +
   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom", breaks = c("1", "2", "4", "5", "6"), labels=c("Trop Moist", "Trop Dry", "Temperate", "Temp Conifer",  "Boreal"))+
   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
         axis.title.x = element_text(size = 16),
         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
         axis.title.y = element_text(size = 16),
         axis.text.y = element_text(size = 16),
         legend.position = "none")

 BoxplotHeight <- BoxplotHeight + ylim(c(-0.5, 0.3))
 BoxplotCrownDiameter <- BoxplotCrownDiameter + ylim(c(-0.5, 0.3))
 BoxplotWoodDensity <- BoxplotWoodDensity + ylim(c(-0.5, 0.3)) 
 BoxplotLeafNP <- BoxplotLeafNP + ylim(c(-0.5, 0.3))
 BoxplotSLA <- BoxplotSLA + ylim(c(-0.5, 0.3))
 BoxplotRootDepth <- BoxplotRootDepth + ylim(c(-0.5, 0.3))
 
 BoxplotStemConduitD <- BoxplotStemConduitD + ylim(c(-0.7, 0.3))
 BoxplotLeafN <- BoxplotLeafN + ylim(c(-0.7, 0.3))
 BoxplotBarkThickness <- BoxplotBarkThickness + ylim(c(-0.7, 0.3))
 BoxplotSeedMass <- BoxplotSeedMass + ylim(c(-0.7, 0.3))

#Boxplots CI Fig. 2
 grid.arrange(BoxplotHeight, BoxplotCrownDiameter, BoxplotWoodDensity, BoxplotSLA, BoxplotLeafNP, BoxplotRootDepth, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

#Boxplots CI for SI Fig. S1
grid.arrange(BoxplotBarkThickness, BoxplotStemConduitD, BoxplotLeafN, BoxplotSeedMass, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

# #All together
#  grid.arrange(BoxplotHeight, BoxplotCrownDiameter, BoxplotWoodDensity, BoxplotBarkThickness, BoxplotSLA, BoxplotRootDepth, BoxplotStemConduitD, BoxplotLeafN, BoxplotLeafNP, BoxplotSeedMass, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

# ###############
# ##Boxplots standard error for SI Fig. S1
# BoxplotLeafN <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanLeafN)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanLeafN-seLeafN, ymax=MeanLeafN+seLeafN), color="black", width=.1) +
#   labs(title="Leaf nitrogen") +
#   labs(x=" ", y="Scaled Leaf N") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotLeafNP <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanLeafNP)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanLeafNP-seLeafNP, ymax=MeanLeafNP+seLeafNP), color="black", width=.1) +
#   labs(title="Leaf N/P ratio") +
#   labs(x=" ", y="Scaled Leaf NP") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotStemConduitD <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanStemConduitD)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanStemConduitD-seStemConduitD, ymax=MeanStemConduitD+seStemConduitD), color="black", width=.1) +
#   labs(title="Stem Conduit Diameter") +
#   labs(x=" ", y="Scaled Stem Conduit Diam.") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotSeedMass <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanSeedMass)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanSeedMass-seSeedMass, ymax=MeanSeedMass+seSeedMass), color="black", width=.1) +
#   labs(title="Seed mass") +
#   labs(x=" ", y="Scaled Seed mass") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) + scale_x_discrete(position="bottom", breaks = c("1", "2", "3", "4", "5", "6"), labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+ # labels=c("Tropical Moist", "Tropical dry", "Tropical conifer", "Temperate", "Temperate conifer",  "Boreal"))
#   theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# grid.arrange(BoxplotStemConduitD, BoxplotLeafN, BoxplotLeafNP, BoxplotSeedMass, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))
# 
# str(DiffCWM_PlotLevel_SE)
# DiffCWM_PlotLevel_SE$Biome <- as.factor(DiffCWM_PlotLevel_SE$Biome)
# 
# BoxplotHeight <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanHeight)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanHeight-seHeight, ymax=MeanHeight+seHeight), color="black", width=.1) +
#   labs(title="Tree Height") + labs(x=" ", y="Difference Tree height") + geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
#         plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotCrownDiameter <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanCrownDiameter)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanCrownDiameter-seCrownDiameter, ymax=MeanCrownDiameter+seCrownDiameter), color="black", width=.1) +
#   labs(title="Crown diameter") +
#   labs(x=" ", y="Difference Crown diameter") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
#         plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotWoodDensity <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanWoodDensity)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanWoodDensity-seWoodDensity, ymax=MeanWoodDensity+seWoodDensity), color="black", width=.1) +
#   labs(title="Wood density") +
#   labs(x=" ", y="Difference Wood density") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
#         plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotBarkThickness <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanBarkThickness)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanBarkThickness-seBarkThickness, ymax=MeanBarkThickness+seBarkThickness), color="black", width=.1) +
#   labs(title="Bark thickness") +
#   labs(x=" ", y="Difference Bark thickness") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
#         plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotSLA <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanSLA)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanSLA-seSLA, ymax=MeanSLA+seSLA), color="black", width=.1) +
#   labs(title="Specific leaf area") +
#   labs(x=" ", y="Difference SLA") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ scale_x_discrete(position="bottom",labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
#         plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 16),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# BoxplotRootDepth <- ggplot(DiffCWM_PlotLevel_SE, aes(x=Biome, y=MeanRootDepth)) + geom_point(colour="#2ab325", size=4, position = position_dodge(width=0.75)) +
#   geom_errorbar(aes(ymin=MeanRootDepth-seRootDepth, ymax=MeanRootDepth+seRootDepth), color="black", width=.1) +
#   labs(title="Root depth") +
#   labs(x=" ", y="Difference Root depth") +
#   geom_hline(yintercept=0, linetype="dashed", color = "darkgrey", size=0.5) +
#   theme_linedraw()+ scale_x_discrete(position="bottom", labels=c("Trop Moist", "Trop Dry", "Trop Conifer", "Temperate", "Temp Conifer",  "Boreal"))+
#   theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank(),
#         plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
#         axis.title.x = element_text(size = 16),
#         axis.text.x = element_text(angle = 25, vjust = 0.5, size = 14),
#         axis.title.y = element_text(size = 16),
#         axis.text.y = element_text(size = 16),
#         legend.position = "none")
# 
# # BoxplotHeight <- BoxplotHeight + ylim(c(-0.5, 0.5))
# # BoxplotCrownDiameter <- BoxplotCrownDiameter + ylim(c(-0.5, 0.5))
# # BoxplotWoodDensity <- BoxplotWoodDensity + ylim(c(-0.5, 0.5))  # + scale_y_continuous(breaks=c(-0.5, 0.5))
# # BoxplotSLA <- BoxplotSLA + ylim(c(-0.5, 0.5))
# # BoxplotRootDepth <- BoxplotRootDepth + ylim(c(-0.5, 0.5))
# 
# # grid.arrange(BoxplotHeight, BoxplotCrownDiameter, BoxplotWoodDensity, BoxplotStemConduitD, BoxplotBarkThickness, BoxplotSLA, BoxplotLeafN, BoxplotLeafNP, BoxplotRootDepth, BoxplotSeedMass, nrow=2)
# grid.arrange(BoxplotHeight, BoxplotCrownDiameter, BoxplotWoodDensity, BoxplotBarkThickness, BoxplotSLA, BoxplotRootDepth, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

```
###Biome level PCA's
```{r Biome level PCA}

###Scale and mean trait values
setwd("~/Documents/PhD projects/Traits Dominant Species")
Biome_TraitsScaled <- fread("~/Documents/PhD projects/Traits Dominant Species/Biome_TraitsScaledGlobally_8-2021.csv")

Biome_Traits <- subset(Biome_TraitsScaled, select=c(Biome, species_name, DominanceCategory, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))

Biome_TraitsDR <- Biome_Traits[which(Biome_Traits$DominanceCategory == "rare" | Biome_Traits$DominanceCategory == "dominant"),]

Biome_TraitsDR$DominanceCategory <- ifelse(Biome_TraitsDR$DominanceCategory == "dominant", "2", "1") #2=dominant, 1=rare
Biome_TraitsDR$DominanceCategory <- as.numeric(Biome_TraitsDR$DominanceCategory)
Biome_TraitsDRMean <- Biome_TraitsDR %>% group_by(DominanceCategory, Biome, species_name) %>% summarise_all(mean) 
Biome_TraitsDRMean <- as.data.frame(Biome_TraitsDRMean)

# #Species for figure 1
# SpeciesGraph1 <- as.data.frame(Biome_TraitsDRMean %>% group_by(Biome, DominanceCategory) %>% sample_n(3))

###PCA graphs
Biome1 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 1), ]
Biome2 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 2), ]
Biome3 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 3), ]
Biome4 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 4), ]
Biome5 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 5), ]
Biome6 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 6), ]

df <- subset(Biome1, select=-c(Biome, species_name, DominanceCategory))
pca_res1 <- prcomp(df, scale. = FALSE)
GraphBiome1 <- print(ggbiplot(pca_res1, obs.scale = 1, var.scale = 1, groups = as.factor(Biome1$DominanceCategory), scale.factor = 1,
                              ellipse = TRUE, ellipse.prob = 0.68, circle = FALSE, varname.size = 5, varname.adjust = 1.2, alpha=0.3, color="black", linetype="dashed", alpha_arrow=1)) + 
  scale_colour_manual(values= c("deepskyblue", "blue1"))+ggtitle("Tropical Moist Forest")+ theme_minimal() + 
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12))
GraphBiome1$layers <- c(GraphBiome1$layers, GraphBiome1$layers[[1]])

df <- subset(Biome2, select=-c(Biome, species_name, DominanceCategory))
pca_res2 <- prcomp(df, scale. = FALSE)
GraphBiome2 <- print(ggbiplot(pca_res2, obs.scale = 1, var.scale = 1, groups = factor(Biome2$DominanceCategory), scale.factor = 1,
                                        ellipse = TRUE, circle = FALSE, varname.size = 5, varname.adjust = 1.2, alpha=0.3, color="black", linetype="dashed", alpha_arrow=1)) + 
  scale_colour_manual(values= c("deepskyblue", "blue1", "black"))+ ggtitle("Tropical Dry Forest")+ theme_minimal() + 
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12))
GraphBiome2$layers <- c(GraphBiome2$layers, GraphBiome2$layers[[1]])

df <- subset(Biome3, select=-c(Biome, species_name, DominanceCategory))
pca_res3 <- prcomp(df, scale. = FALSE)
GraphBiome3 <- print(ggbiplot::ggbiplot(pca_res3, obs.scale = 1, var.scale = 1, groups = as.factor(Biome3$DominanceCategory), scale.factor = 1,
                              ellipse = FALSE, circle = FALSE, varname.size = 5, varname.adjust = 1.2, alpha=0.3, color="black", linetype="dashed", alpha_arrow=1)) + 
  scale_colour_manual(values= c("deepskyblue", "blue1"))+ ggtitle("Tropical conifer Forest")+ theme_minimal() +
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12))
GraphBiome3$layers <- c(GraphBiome3$layers, GraphBiome3$layers[[1]])

df <- subset(Biome4, select=-c(Biome, species_name, DominanceCategory))
pca_res4 <- prcomp(df, scale. = FALSE)
GraphBiome4 <- print(ggbiplot(pca_res4, obs.scale = 1, var.scale = 1, groups = factor(Biome4$DominanceCategory), scale.factor = 1,
                              ellipse = TRUE, circle = FALSE, varname.size = 5, varname.adjust = 1.2, alpha=0.3, color="black", linetype="dashed", alpha_arrow=1)) + 
  scale_colour_manual(values= c("deepskyblue", "blue1", "black"))+ ggtitle("Temperate Forest")+ theme_minimal() + 
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12))
GraphBiome4$layers <- c(GraphBiome4$layers, GraphBiome4$layers[[1]])

df <- subset(Biome5, select=-c(Biome, species_name, DominanceCategory))
pca_res5 <- prcomp(df, scale. = FALSE)
GraphBiome5 <- print(ggbiplot(pca_res5, obs.scale = 1, var.scale = 1, groups = factor(Biome5$DominanceCategory), scale.factor = 1,
                              ellipse = TRUE, circle = FALSE, varname.size = 5, varname.adjust = 1.2, alpha=0.3, color="black", linetype="dashed", alpha_arrow=1)) + 
  scale_colour_manual(values= c("deepskyblue", "blue1", "black"))+ ggtitle("Temperate conifer Forest")+ theme_minimal() + 
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12))
GraphBiome5$layers <- c(GraphBiome5$layers, GraphBiome5$layers[[1]])

df <- subset(Biome6, select=-c(Biome, species_name, DominanceCategory))
pca_res6 <- prcomp(df, scale. = FALSE)
GraphBiome6 <- print(ggbiplot(pca_res6, obs.scale = 1, var.scale = 1, groups = factor(Biome6$DominanceCategory), scale.factor = 1,
                              ellipse = TRUE, circle = FALSE, varname.size = 5, varname.adjust = 1.2, alpha=0.3, color="black", linetype="dashed", alpha_arrow=1)) + 
  scale_colour_manual(values= c("deepskyblue", "blue1"))+ggtitle("Boreal Forest")+ theme_minimal() + 
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12))
GraphBiome6$layers <- c(GraphBiome6$layers, GraphBiome6$layers[[1]])

GraphBiome1 <- GraphBiome1 + xlim(c(-6, 6)) + ylim(c(-6, 6)) 
GraphBiome2 <- GraphBiome2 + xlim(c(-6, 6)) + ylim(c(-6, 6)) 
GraphBiome3 <- GraphBiome3 + xlim(c(-6, 6)) + ylim(c(-6, 6)) 
GraphBiome4 <- GraphBiome4 + xlim(c(-6, 6)) + ylim(c(-6, 6)) 
GraphBiome5 <- GraphBiome5 + xlim(c(-6, 6)) + ylim(c(-6, 6)) 
GraphBiome6 <- GraphBiome6 + xlim(c(-6, 6)) + ylim(c(-6, 6)) 

###Mark's genius contribution to the PCA's #nopressure
Biome <- Biome1
df <- subset(Biome, select=-c(Biome, species_name, DominanceCategory))
pca_res <- prcomp(df, scale. = FALSE)
pca_res$sig <- c("darkgrey", "black", "black", "black", "black", "darkgrey", "darkgrey", "darkgrey", "darkgrey", "darkgrey") 
pca.df<- data.frame(pca1 = pca_res$x[,1], pca2 = pca_res$x[,2], DominanceCategory = Biome$DominanceCategory)
pca.df2<- data.frame(pca1 = pca_res$rotation[,1], pca2 = pca_res$rotation[,2], sig = pca_res$sig, labels = row.names(pca_res$rotation))
pca.df$DominanceCategory <- as.factor(pca.df$DominanceCategory)

PCA_Biome1 <- ggplot(data=pca.df, aes(x=pca1, y = pca2)) + 
         geom_point(aes(color = factor(DominanceCategory)), size = 3, shape = 19, alpha = 0.1) + stat_ellipse(aes(group=DominanceCategory, color=DominanceCategory), level = 0.68) +
         scale_color_manual(values = c("deepskyblue", "blue1")) + 
         theme_bw() + labs(x = "PCA 1 (36%)", y = "PCA 2 (19%)") + ggtitle("Tropical Moist Forest") +
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
          axis.text.x = element_text(family="sans", size = 14, color = "black"),
          axis.text.y = element_text(family="sans", size = 14, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          geom_segment(data=pca.df2,aes(x=0, xend=pca1*4,y=0,yend=pca2*4), arrow = arrow(length = unit(0.5, "cm")), color = pca.df2$sig, alpha = 1) +
          geom_text_repel(data=pca.df2,aes(x=4*pca1,y=4.5*pca2, label = labels), color = pca.df2$sig, size=5, fontface="bold") 

Biome <- Biome2
df <- subset(Biome, select=-c(Biome, species_name, DominanceCategory))
pca_res <- prcomp(df, scale. = FALSE)
pca_res$sig <- c("darkgrey", "darkgrey", "black", "darkgrey","black", "black", "darkgrey", "darkgrey", "black", "darkgrey")
pca.df<- data.frame(pca1 = pca_res$x[,1], pca2 = pca_res$x[,2], DominanceCategory = Biome$DominanceCategory)
pca.df2<- data.frame(pca1 = pca_res$rotation[,1], pca2 = pca_res$rotation[,2], sig = pca_res$sig, labels = row.names(pca_res$rotation))
pca.df$DominanceCategory <- as.factor(pca.df$DominanceCategory)

PCA_Biome2 <- ggplot(data=pca.df, aes(x=pca1, y = pca2)) + 
         geom_point(aes(color = factor(DominanceCategory)), size = 3, shape = 19, alpha = 0.4) + stat_ellipse(aes(group=DominanceCategory, color=DominanceCategory), level = 0.68) +
         scale_color_manual(values = c("deepskyblue", "blue1")) + 
         theme_bw() + labs(x = "PCA 1 (31%)", y = "PCA 2 (27%)") + ggtitle("Tropical Dry Forest") +
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
          axis.text.x = element_text(family="sans", size = 14, color = "black"),
          axis.text.y = element_text(family="sans", size = 14, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          geom_segment(data=pca.df2,aes(x=0, xend=pca1*4,y=0,yend=pca2*4), arrow = arrow(length = unit(0.5, "cm")), color = pca.df2$sig, alpha = 1) +
          geom_text_repel(data=pca.df2,aes(x=4*pca1,y=4.5*pca2, label = labels), color = pca.df2$sig, size=5, fontface="bold") 

Biome <- Biome3
df <- subset(Biome, select=-c(Biome, species_name, DominanceCategory))
pca_res <- prcomp(df, scale. = FALSE)
pca_res$sig <- c( "black", "black", "black", "darkgrey", "darkgrey", "darkgrey", "darkgrey", "black", "darkgrey", "darkgrey")
pca.df<- data.frame(pca1 = pca_res$x[,1], pca2 = pca_res$x[,2], DominanceCategory = Biome$DominanceCategory)
pca.df2<- data.frame(pca1 = pca_res$rotation[,1], pca2 = pca_res$rotation[,2], sig = pca_res$sig, labels = row.names(pca_res$rotation))
pca.df$DominanceCategory <- as.factor(pca.df$DominanceCategory)

PCA_Biome3 <- ggplot(data=pca.df, aes(x=pca1, y = pca2)) + 
         geom_point(aes(color = factor(DominanceCategory)), size = 3, shape = 19, alpha = 0.4) + stat_ellipse(aes(group=DominanceCategory, color=DominanceCategory), level = 0.68) +
         scale_color_manual(values = c("deepskyblue", "blue1")) + 
         theme_bw() + labs(x = "PCA 1 (65%)", y = "PCA 2 (29%)") + ggtitle("Tropical Conifer Forest") +
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
          axis.text.x = element_text(family="sans", size = 14, color = "black"),
          axis.text.y = element_text(family="sans", size = 14, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          geom_segment(data=pca.df2,aes(x=0, xend=pca1*4,y=0,yend=pca2*4), arrow = arrow(length = unit(0.5, "cm")), color = pca.df2$sig, alpha = 1) +
          geom_text_repel(data=pca.df2,aes(x=4*pca1,y=4.5*pca2, label = labels), color = pca.df2$sig, size=5, fontface="bold") 

Biome <- Biome4
df <- subset(Biome, select=-c(Biome, species_name, DominanceCategory))
pca_res <- prcomp(df, scale. = FALSE)
pca_res$sig <- c("black", "darkgrey", "darkgrey", "darkgrey","black", "darkgrey", "darkgrey", "black", "black", "darkgrey")
pca.df<- data.frame(pca1 = pca_res$x[,1], pca2 = pca_res$x[,2], DominanceCategory = Biome$DominanceCategory)
pca.df2<- data.frame(pca1 = pca_res$rotation[,1], pca2 = pca_res$rotation[,2], sig = pca_res$sig, labels = row.names(pca_res$rotation))
pca.df$DominanceCategory <- as.factor(pca.df$DominanceCategory)

PCA_Biome4 <- ggplot(data=pca.df, aes(x=pca1, y = pca2)) + 
         geom_point(aes(color = factor(DominanceCategory)), size = 3, shape = 19, alpha = 0.4) + stat_ellipse(aes(group=DominanceCategory, color=DominanceCategory), level = 0.68) +
         scale_color_manual(values = c("deepskyblue", "blue1")) + 
         theme_bw() + labs(x = "PCA 1 (36%)", y = "PCA 2 (22%)") + ggtitle("Temperate Forest") +
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
          axis.text.x = element_text(family="sans", size = 14, color = "black"),
          axis.text.y = element_text(family="sans", size = 14, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          geom_segment(data=pca.df2,aes(x=0, xend=pca1*4,y=0,yend=pca2*4), arrow = arrow(length = unit(0.5, "cm")), color = pca.df2$sig, alpha = 1) +
          geom_text_repel(data=pca.df2,aes(x=4*pca1,y=4.5*pca2, label = labels), color = pca.df2$sig, size=5, fontface="bold") 

Biome <- Biome5
df <- subset(Biome, select=-c(Biome, species_name, DominanceCategory))
pca_res <- prcomp(df, scale. = FALSE)
pca_res$sig <- c("darkgrey", "darkgrey", "black", "darkgrey", "black", "darkgrey", "darkgrey", "black", "darkgrey", "black")
pca.df<- data.frame(pca1 = pca_res$x[,1], pca2 = pca_res$x[,2], DominanceCategory = Biome$DominanceCategory)
pca.df2<- data.frame(pca1 = pca_res$rotation[,1], pca2 = pca_res$rotation[,2], sig = pca_res$sig, labels = row.names(pca_res$rotation))
pca.df$DominanceCategory <- as.factor(pca.df$DominanceCategory)

PCA_Biome5 <- ggplot(data=pca.df, aes(x=pca1, y = pca2)) + 
         geom_point(aes(color = factor(DominanceCategory)), size = 3, shape = 19, alpha = 0.4) + stat_ellipse(aes(group=DominanceCategory, color=DominanceCategory), level = 0.68) +
         scale_color_manual(values = c("deepskyblue", "blue1")) + 
         theme_bw() + labs(x = "PCA 1 (62%)", y = "PCA 2 (14%)") + ggtitle("Temperate Conifer Forest") +
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
          axis.text.x = element_text(family="sans", size = 14, color = "black"),
          axis.text.y = element_text(family="sans", size = 14, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          geom_segment(data=pca.df2,aes(x=0, xend=pca1*4,y=0,yend=pca2*4), arrow = arrow(length = unit(0.5, "cm")), color = pca.df2$sig, alpha = 1) +
          geom_text_repel(data=pca.df2,aes(x=4*pca1,y=4.5*pca2, label = labels), color = pca.df2$sig, size=5, fontface="bold") 

Biome <- Biome6
df <- subset(Biome, select=-c(Biome, species_name, DominanceCategory))
pca_res <- prcomp(df, scale. = FALSE)
pca_res$sig <- c("darkgrey", "darkgrey", "black", "darkgrey", "darkgrey", "black", "darkgrey", "black", "darkgrey", "darkgrey")
pca.df<- data.frame(pca1 = pca_res$x[,1], pca2 = pca_res$x[,2], DominanceCategory = Biome$DominanceCategory)
pca.df2<- data.frame(pca1 = pca_res$rotation[,1], pca2 = pca_res$rotation[,2], sig = pca_res$sig, labels = row.names(pca_res$rotation))
pca.df$DominanceCategory <- as.factor(pca.df$DominanceCategory)

PCA_Biome6 <- ggplot(data=pca.df, aes(x=pca1, y = pca2)) + 
         geom_point(aes(color = factor(DominanceCategory)), size = 3, shape = 19, alpha = 0.4) + stat_ellipse(aes(group=DominanceCategory, color=DominanceCategory), level = 0.68) +
         scale_color_manual(values = c("deepskyblue", "blue1")) + 
         theme_bw() + labs(x = "PCA 1 (54%)", y = "PCA 2 (24%)") + ggtitle("Boreal Forest") +
         theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(), 
          legend.position = "none", 
          plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
          axis.text.x = element_text(family="sans", size = 14, color = "black"),
          axis.text.y = element_text(family="sans", size = 14, color = "black"),
          axis.title.x = element_text(family="sans", size = 16, color = "black"),
          axis.title.y = element_text(family="sans", size = 16, color = "black")) +
          geom_segment(data=pca.df2,aes(x=0, xend=pca1*4,y=0,yend=pca2*4), arrow = arrow(length = unit(0.5, "cm")), color = pca.df2$sig, alpha = 1) +
          geom_text_repel(data=pca.df2,aes(x=4*pca1,y=4.5*pca2, label = labels), color = pca.df2$sig, size=5, fontface="bold") 

PCA_Biome1 <- PCA_Biome1 + xlim(c(-4, 4)) + ylim(c(-4, 4)) 
PCA_Biome2 <- PCA_Biome2 + xlim(c(-4, 4)) + ylim(c(-4, 4)) 
PCA_Biome3 <- PCA_Biome3 + xlim(c(-5.5, 4)) + ylim(c(-4, 4)) 
PCA_Biome4 <- PCA_Biome4 + xlim(c(-4, 4)) + ylim(c(-4, 4)) 
PCA_Biome5 <- PCA_Biome5 + xlim(c(-5.2, 4.1)) + ylim(c(-4, 4)) 
PCA_Biome6 <- PCA_Biome6 + xlim(c(-4, 4)) + ylim(c(-4, 4)) 
          
grid.arrange(PCA_Biome1, PCA_Biome2, PCA_Biome3, PCA_Biome4, PCA_Biome5, PCA_Biome6, ncol=3, top=textGrob("Traits of dominant and rare species at biome level", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

###

PCA_graph <- grid.arrange(GraphBiome1, GraphBiome2, GraphBiome3, GraphBiome4, GraphBiome5, GraphBiome6, ncol=3)
```
###Analyses PCA's
```{r Analyses PCA's}
###Calculate Centroid distance (and check if the distance is significant)
u_Biome <- Biome_TraitsDRMean %>% ungroup %>% select(Biome) %>% distinct() %>% unlist 
DistanceCentroids <- tibble()
for(i in 1:length(u_Biome)){
  Data <- Biome_TraitsDRMean %>% filter(Biome == u_Biome[i])
  df <- subset(Data, select=-c(DominanceCategory, Biome, species_name))
  Biome.pca <- prcomp(df, scale. = TRUE)
  df.Biome.x <- as.data.frame(Biome.pca$x)
  df.Biome.x$groups <- Data$DominanceCategory
  pca.centroids <- aggregate(df.Biome.x[,1:5], list(Type = df.Biome.x$groups), mean)
  DistanceCentroids <- DistanceCentroids %>% rbind(tibble(Biome = u_Biome[i], distance = dist(rbind(pca.centroids[pca.centroids$Type == "1",1:4],pca.centroids[pca.centroids$Type == "2",1:4]), method = "euclidean")))
}

DistanceCentroids <- as.data.frame(DistanceCentroids)

Biome1 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 1), ]
Biome2 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 2), ]
Biome3 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 3), ]
Biome4 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 4), ]
Biome5 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 5), ]
Biome6 <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 6), ]

Data <- Biome4
data <- Data[,-c(1:3)]
rownames(data) <- Data$species_name

dissimilarity <- vegdist(data, method="euclidean", upper=TRUE) 
ad <- adonis(dissimilarity ~ DominanceCategory, data=Data)
ad

groups <- Data$DominanceCategory
mod <- betadisper(dissimilarity, groups, type="centroid")
permutest(mod)
anova(mod)
plot(mod)
boxplot(mod)

# Data <- Biome1
# data <- Data[,-c(1:3)]
# rownames(data) <- Data$species_name
# 
# sim <- with(Data, simper(data, DominanceCategory, permutations=999))
# summary(sim)
# sim$`1_2`$species
# sim$`1_2`$cusum
# sim$`1_2`$p

###PCA statistics
Data <- Biome6
df <- subset(Data, select=-c(Biome, species_name, DominanceCategory))
pca_res <- prcomp(df, scale. = TRUE)
#summary(pca_res)
barplot(pca_res$rotation[,1], main="PC 1 Loadings Plot", las=2)
barplot(pca_res$rotation[,2], main="PC 2 Loadings Plot", las=2)
# barplot(pca_res$rotation[,3], main="PC 3 Loadings Plot", las=2)
# barplot(pca_res$rotation[,4], main="PC 4 Loadings Plot", las=2)

###Calculate FRic/FEve/FDis
Biome_TraitsDRMean$SpeciesBiome <- paste(Biome_TraitsDRMean$Biome,Biome_TraitsDRMean$species_name,sep="_")
Biome_TraitsDRMean$NrInd <- 1

Biome_TraitsDRMean <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$Biome == 4),]

#Dominant species
TraitsD_Biome <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$DominanceCategory == 2),]
DominantTraits_Biome <- TraitsD_Biome[,c("SpeciesBiome", "Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass")]
DominantAbundance_Biome <- as.data.frame(TraitsD_Biome[,c("Biome", "SpeciesBiome", "NrInd")])

Abundance <- DominantAbundance_Biome[order(DominantAbundance_Biome$SpeciesBiome),]
Traits <- DominantTraits_Biome[order(DominantTraits_Biome$SpeciesBiome),]
AbundanceSpread <- spread(Abundance, SpeciesBiome, NrInd,  fill = 0)
AbundanceSpreads <- AbundanceSpread[, -c(1)] #Last row is plot_id? ###Adjust!
row.names(AbundanceSpreads) <- AbundanceSpread$Biome

Trait <- as.data.frame(Traits[, -c(1)])
row.names(Trait) <- Traits$SpeciesBiome
AbundanceSpreadOrder <- setcolorder(AbundanceSpreads, as.character(Trait$SpeciesBiome))
AbundanceSpreadOrder <- as.matrix(AbundanceSpreadOrder)

Analyse <- as.data.frame(dbFD(Trait, AbundanceSpreadOrder, calc.FRic = TRUE, w.abun=FALSE, stand.x=FALSE, scale.RaoQ=TRUE))

Analyse <- as.data.frame(Analyse)
Analyse$Biome <- AbundanceSpread$Biome
Analyse$SpeciesCategory <- "dominant"
head(Analyse)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Analyse, file="FDiv_Dominant_Biome_27-07-2021.csv") 
FdivDomBiome <- fread("~/Documents/PhD projects/Traits Dominant Species/FDiv_Dominant_Biome_27-07-2021.csv")

#ric PCoA removed: 0.71

#Rare species
TraitsR_Biome <- Biome_TraitsDRMean[which(Biome_TraitsDRMean$DominanceCategory == 1),]
RareTraits_Biome <- TraitsR_Biome[,c("SpeciesBiome", "Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass")]
RareAbundance_Biome <- as.data.frame(TraitsR_Biome[,c("Biome", "SpeciesBiome", "NrInd")])

Abundance <- RareAbundance_Biome[order(RareAbundance_Biome$SpeciesBiome),]
Traits <- RareTraits_Biome[order(RareTraits_Biome$SpeciesBiome),]
AbundanceSpread <- spread(Abundance, SpeciesBiome, NrInd,  fill = 0)
AbundanceSpreads <- AbundanceSpread[, -c(1)] #Last row is plot_id? ###Adjust!
row.names(AbundanceSpreads) <- AbundanceSpread$Biome

Trait <- as.data.frame(Traits[, -c(1)])
row.names(Trait) <- Traits$SpeciesBiome
AbundanceSpreadOrder <- setcolorder(AbundanceSpreads, as.character(Trait$SpeciesBiome))
AbundanceSpreadOrder <- as.matrix(AbundanceSpreadOrder)

Analyse <- as.data.frame(dbFD(Trait, AbundanceSpreadOrder, calc.FRic = TRUE, w.abun=FALSE, stand.x=FALSE, scale.RaoQ=TRUE))

Analyse <- as.data.frame(Analyse)
Analyse$Biome <- AbundanceSpread$Biome
Analyse$SpeciesCategory <- "rare"
head(Analyse)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Analyse, file="FDiv_Rare_Biome_27-07-2021.csv") 

#ric PCoA removed: 0.69

###Correlation centroid ditance and difference FDis
Diff_FDis <- c(-0.44, -0.26, 0.46, 0.32,	0.48,	0.22)
Centroid_dis <- c(1.24,1.13, 2.9, 1.87,	3.45,	3.7)

Correlation <- as.data.frame(cbind(Diff_FDis, Centroid_dis))
row.names(Correlation) <- c(1,2,3,4,5,6)

cor.test(Correlation$Diff_FDis, Correlation$Centroid_dis, method="pearson")

```
###FDis biome level
```{r FDis biome level}

DominantRareSp_plotlevel <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")
Traits <- read_feather("~/Desktop/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

Plot_SpTraits <- left_join(DominantRareSp_plotlevel, Traits, by="obs_id")
summary(Plot_SpTraits)

rm(Traits, DominantRareSp_plotlevel)

Plot_SpTraits <- subset(Plot_SpTraits, select=-c(plot_id.y, LAT, LON, accepted_bin, dbh.y, tph.y, year.y, old_plot_id, raw_name))
setnames(Plot_SpTraits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                                 "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44", "trait45",  
                                 "trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9", "plot_id.x", "dbh.x", "tph.x", "year.x"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll", "LeafK", "StomatalConductance",
                 "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN", "RootShootRatio","plot_id", "dbh", "tph", "year"))

###Log transform and scale traits 
Plot_SpTraitsCompl <- Plot_SpTraits[complete.cases(Plot_SpTraits),]#Erase incomplete rows: 0.70% #100-(12816859/12907085)*100
Plot_SpTraitsLog <- Plot_SpTraitsCompl %>% mutate_at(vars(RootCN:RootShootRatio), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #%>% summarise_at(vars(-c(NrInd)), mean)  #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))
Plot_TraitsMeanMerge <- subset(Plot_TraitsMeanMerge, select = -c(dbh, NrInd, NrIndSp))

Plot_TraitsScaled <- as.data.frame(Plot_TraitsMeanMerge %>% mutate_at(vars(RootCN:RootShootRatio), scale)) #Standardise trait values by biome or globally group_by(Biome) %>% 
rm(Plot_SpTraits, Plot_SpTraitsCompl, Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Plot_TraitsScaled, file="Plot_TraitsScaledGlobally_8-2021.csv") #Scaled globally

###Calculate trait diversity
summary(Plot_TraitsScaled$SumS) #Select only plots with at least 6 sp. (if needed)

#Select 10 traits: Height, WoodDensity, SLA, LeafNP, RootDepth, SeedMass
TraitsDRScaledSelect <- Plot_TraitsScaled[,c("DominanceCategory", "Biome", "plot_id", "species_name", "Plotsize", "SumS", "PercPerSpecies", "Height", "CrownDiameter", "BarkThickness", "StemConduitDiameter", "WoodDensity", "SLA", "LeafN","LeafNP", "RootDepth", "SeedMass" )]
TraitsDRScaledSelect$SpeciesPlots <- paste(TraitsDRScaledSelect$plot_id,TraitsDRScaledSelect$species_name,sep="_")

#Rare species
TraitsR <- TraitsDRScaledSelect[which(TraitsDRScaledSelect$DominanceCategory == "rare"),]
RareAbundance <- as.data.frame(TraitsR[,c("plot_id", "SpeciesPlots", "PercPerSpecies")])

#Dominant species
TraitsD <- TraitsDRScaledSelect[which(TraitsDRScaledSelect$DominanceCategory == "dominant"),]
DominantAbundance <- as.data.frame(TraitsD[,c("plot_id", "SpeciesPlots", "PercPerSpecies")])

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(RareAbundance, file = "RareSpAbundanceAll_8-2021.csv")
fwrite(DominantAbundance, file = "DominantSpAbundanceAll_8-2021.csv")
fwrite(TraitsR, file = "RareSpTraitsAll_8-2021.csv")
fwrite(TraitsD, file = "DominantSpTraitsAll_8-2021.csv")

###Trait diversity calculations at iMac (R file named: Traits2021.R) #Import data from iMa
setwd("~/Documents/PhD projects/Traits Dominant Species/FDis_04082021")
FDIV_DomRare <- list.files("~/Documents/PhD projects/Traits Dominant Species/FDis_04082021") %>% map_df(~fread(.))
FDivTotal <- as.data.frame(FDIV_DomRare)

###Calculate difference between dominant and rare trait diversity
FDIV_Dom <- FDivTotal[which(FDivTotal$SpeciesCategory == "dominant"),]
FDIV_Rare <- FDivTotal[which(FDivTotal$SpeciesCategory == "rare"),]  

JoinRare <- anti_join(FDIV_Rare, FDIV_Dom, by="plot_id")
JoinDom <- anti_join(FDIV_Dom, FDIV_Rare, by="plot_id")

FDivDomFilter <- anti_join(FDIV_Dom, JoinDom, by="plot_id")
FDivDomOrder <- FDivDomFilter[order(FDivDomFilter$plot_id),]
FDivDomSubset <- as.data.frame(subset(FDivDomOrder, select=-c(nbsp, sing.sp, plot_id, SpeciesCategory)))

FDivRareFilter <- anti_join(FDIV_Rare, JoinRare, by="plot_id")
FDivRareOrder <- FDivRareFilter[order(FDivRareFilter$plot_id),]
FDivRareSubset <- as.data.frame(subset(FDivRareOrder, select=-c(nbsp, sing.sp, plot_id, SpeciesCategory)))

FDivDomSubset$FDisRound <- round(FDivDomSubset$FDis, 1)
FDivRareSubset$FDisRound <- round(FDivRareSubset$FDis, 1)
summary(FDivRareSubset$FDisRound)
summary(FDivDomSubset$FDisRound)

DifferenceDomRare <- FDivDomSubset - FDivRareSubset
DifferenceDomRare$FDivPerc <- (FDivDomSubset$FDisRound/FDivRareSubset$FDisRound)*100
DifferenceDomRare$plot_id <- FDivRareOrder$plot_id
DifferenceDomRare$FDisRare <- FDivRareSubset$FDis
DifferenceDomRare$FDisDom <- FDivDomSubset$FDis

###Calulate FDis difference % per biome
# DifferenceDomRare$FDis_direction <- ifelse(DifferenceDomRare$FDis > 0, "pos", "neg")
# 
# Calculate <- DifferenceDomRare %>% group_by(Biome, FDis_direction) %>% summarise(n = n()) %>% summarise(freq=n/sum(n))

# DifferenceDomRareCompl <- DifferenceDomRareGEE[complete.cases(DifferenceDomRareGEE$FDivPerc),]
# 
# FDivSelect <- DifferenceDomRareGEE[which(DifferenceDomRareGEE$FDisDom > 0),]
# FDivSelect <- DifferenceDomRareCompl
#   
# FDis_Violin <- ggplot(data=FDivSelect, aes(x=factor(Biome), y=FDivPerc)) + geom_boxplot() #+ ylim(0,300) 
# FDis_ViolinRare <- ggplot(data=FDivSelect, aes(x=factor(Biome), y=FDivPerc)) + geom_boxplot() + ylim(0, 100)
# FDis_ViolinDom <- ggplot(data=FDivSelect, aes(x=factor(Biome), y=FDivPerc)) + geom_boxplot() + ylim(100, 500)

#Import and add GEE information
setwd("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021")
GEE <- list.files("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021") %>% map_df(~fread(.))
GEE <- as.data.frame(GEE)
Biomes <- GEE[,c("plot_id", "Resolve_Biome")]

FDivBiome <- left_join(FDivTotal, Biomes, by="plot_id")
setnames(FDivBiome, old=c("Resolve_Biome"), new=c("Biome"))

###Calculate significant differences FDis between biomes
library(dunn.test)
unique(FDivBiome$SpeciesCategory)
FDivBiomeDom <- FDivBiome[which(FDivBiome$SpeciesCategory == "dominant"),]
FDivBiomeRare <- FDivBiome[which(FDivBiome$SpeciesCategory == "rare"),]

a <- kruskal.test(FDivBiomeDom$FDis ~ FDivBiomeDom$Biome)
pairwise.wilcox.test(FDivBiomeDom$FDis, FDivBiomeDom$Biome) 
dunn.test(FDivBiomeRare$FDis, FDivBiomeRare$Biome)
boxplot(FDivBiome$FDis, FDivBiome$Biome)
Mean <- FDivBiome %>% group_by(Biome) %>% summarise(MeanFDis=median(FDis))

###Graph Functional Dispersion (RaoQ shows the same pattern)
FDisScaled <- FDivBiome %>% group_by(Biome) %>% mutate(ScaledFDis=scale(FDis)) ###Scale FDis by biome

FDivSelect <- FDivBiome[which(FDivBiome$FDis > 0),]
FDis_Violin <- ggplot(data=FDivPerc, aes(y=factor(Biome), x=FDis, fill=SpeciesCategory)) + geom_boxplot()

###Decision: scaled or not???
library(dplyr)
library(Rmisc)
FDisScaledMean <- FDisScaled %>% group_by(Biome, SpeciesCategory) %>% dplyr::summarise(n = n(), MeanFDis=mean(FDis), seFDis=(sd(FDis)/sqrt(n)), uCI_FDis = CI(FDis)["upper"], lCI_FDis = CI(FDis)["lower"]) %>% as.data.frame()

FDisMean <- FDivBiome %>% group_by(Biome, SpeciesCategory) %>% dplyr::summarise(n = n(), MeanFDis=mean(FDis), seFDis=(sd(FDis)/sqrt(n)), uCI_FDis = CI(FDis)["upper"], lCI_FDis = CI(FDis)["lower"]) %>% as.data.frame()
  
Graph_FDisSE <- ggplot(data=FDisScaledMean, aes(y=factor(Biome), x=MeanFDis, fill=SpeciesCategory)) + geom_point(aes(colour=SpeciesCategory), size=4) +
  geom_errorbar(aes(xmin=MeanFDis-seFDis, xmax=MeanFDis+seFDis), color="black", width=.1) +
  scale_color_manual(breaks = c("dominant", "rare"), values=c("blue1", "deepskyblue")) +
  #geom_vline(xintercept = 0, linetype="dotted", color = "grey", size=1.5) +
  theme_classic() + ggtitle("Trait Variation Forest Biomes") +  xlab("Scaled Trait Variation") + #xlim(-0.5,0.5) + #ylab("Altitude (m)") +
  scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry", "Tropical Moist")) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 16))

Graph_FDisCI <- ggplot(data=FDisScaledMean, aes(y=factor(Biome), x=MeanFDis, fill=SpeciesCategory)) + geom_point(aes(colour=SpeciesCategory), size=4) +
  geom_errorbar(aes(xmin=lCI_FDis, xmax=uCI_FDis), color="black", width=.1) +
  scale_color_manual(breaks = c("dominant", "rare"), values=alpha(c("blue1", "deepskyblue"),.8)) +
  theme_classic() + ggtitle("Trait Diversity") +  xlab("Trait Diversity (FDis)") + #xlim(-0.5,0.5) + #ylab("Altitude (m)") +
  scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry ", "Tropical Moist")) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 16))

###Pair up difference FDis with environmental variables
#Import and add GEE information
setwd("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021") %>% map_df(~fread(.)))
GEE_Select <- subset(GEE, select=c(plot_id, Resolve_Biome, CHELSA_BIO_Annual_Mean_Temperature, CHELSA_BIO_Annual_Precipitation, CHELSA_BIO_Precipitation_Seasonality, CHELSA_BIO_Temperature_Seasonality, EarthEnvTopoMed_Elevation, GFAD_FractionOfRegrowthForest_downsampled50km, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/Traits Dominant Species/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/Traits Dominant Species/TraitsPET_07-2021") %>% map_df(~fread(.)))
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index, CGIAR_PET))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("Resolve_Biome","CHELSA_BIO_Annual_Mean_Temperature", "CHELSA_BIO_Annual_Precipitation", "CHELSA_BIO_Precipitation_Seasonality",  "CHELSA_BIO_Temperature_Seasonality", "EarthEnvTopoMed_Elevation", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "CGIAR_Aridity_Index", "CGIAR_PET"), new=c("Biome", "Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "Forest_Age", "Aridity", "PET"))

###Calculate significant differences FDis
FDis_Envars <- left_join(FDivTotal, Env_vars, by="plot_id")
Results_KruskalWallis <- as.data.frame(FDis_Envars %>% group_by(Biome) %>% summarise(Pvalue_FDis = kruskal.test(FDis ~ SpeciesCategory)$p.value))
#   Biome   Pvalue_FDis
# 1     1  1.214881e-01
# 2     2  3.762654e-03
# 3     3  7.660139e-01
# 4     4  5.932594e-17
# 5     5 8.274393e-164
# 6     6  3.962754e-02

###Correlations FDis-Environmental vars
DifFDis_Envars <- left_join(DifferenceDomRare, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

dataframe <- subset(DifFDis_Envars, select=c("FDis", "Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "Forest_Age", "Aridity", "PET"))
dataframe <- dataframe[complete.cases(dataframe),]
res <- as.data.frame(cor(dataframe, method = "spearman"))
results <- res[, c(1,2)]

# ###3D graph
# library(plotly)
# dataframe <- subset(DifFDis_Envars, select=c("FDis", "Temperature", "Aridity"))
# plot_ly() %>% add_trace(data = dataframe,  x=dataframe$FDis, y=dataframe$Aridity, z=dataframe$Temperature, type="mesh3d" ) 
# 
# ###Models
# boxplot(log(DifFDis_Envars$Aridity*0.0001))
# 
# summary(lm(FDis  ~ Temperature * log(Aridity), data=DifFDis_Envars)) #0.041
# summary(lm(FDis ~ poly(Temperature * log(Aridity), 2, raw=TRUE), data=DifFDis_Envars)) #2:0.027, 3:0.042, 4:0.043
# 
# summary(lm(FDis  ~ Temperature, data=DifFDis_Envars)) #0.018
# summary(lm(FDis ~ poly(Temperature, 3, raw=TRUE), data=DifFDis_Envars)) #2:0.025, 3:0.04, 4:0.04
# 
# summary(lm(FDis  ~ log(Aridity), data=DifFDis_Envars)) #0.009
# summary(lm(FDis ~ poly(log(Aridity), 2, raw=TRUE), data=DifFDis_Envars)) #2:0.011, 3:0.014, 4:0.014

###Interaction graph 
DifFDis_Envars$TemperatureScaled <- scale(DifFDis_Envars$Temperature/10)
DifFDis_Envars$AridityScaled <- scale(log(DifFDis_Envars$Aridity*0.0001))
DifFDis_Envars$Forest_AgeScaled <- scale(DifFDis_Envars$Forest_Age)
Data_FDis <- DifFDis_Envars[complete.cases(DifFDis_Envars$Forest_AgeScaled), ]

b <- lm(FDis  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_FDis) #0.044 #Aridity is log transformed
a <- lm(FDis ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_FDis) #2:0.03, 3:0.03, 4:0.031 #Aridity is log transformed

Data_FDis$Temperature <- Data_FDis$Temperature/10
Data_FDis$Aridity <- Data_FDis$Aridity*0.0001
Model_AridityTemp <- lm(FDis  ~ Temperature * Aridity, data=Data_FDis) #r=0.042

###Model statistics
vif(Model_AridityTemp)
summary(Model_AridityTemp) 
anova(Model_AridityTemp) 
plot(Model_AridityTemp)
(coef <- as.data.frame(coefficients(Model_AridityTemp)))

library(relaimpo)
library(car)
library(gam)

Model_AT <- gam(Temperature ~ Aridity, data=Data_FDis)
Data_AT <- with(Data_FDis, data.frame(Aridity = seq(min(Aridity), max(Aridity), len=1000))) %>% mutate(Temperature = predict(Model_AT, newdata = (.), se = FALSE), Temperature_se = predict(Model_AT, newdata = (.), se = TRUE)$se) %>%
mutate(Temperature_upper = Temperature+1.96*Temperature_se, Temperature_lower = Temperature-1.96*Temperature_se)

dummy_dat <- with(Data_FDis, data.frame(Aridity = seq(min(Aridity), max(Aridity), len=1000))) #Forest_AgeScaled=mean(Forest_AgeScaled, na.rm=T)

Temp_cut <- quantile(Data_FDis$Temperature, c(0.1, 0.5, 0.9), na.rm=T) #0.38, 0.865, 1
Temp_cut

all_dat <- data.frame()

for(i in 1:length(Temp_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(Temperature = Temp_cut[i]))}

all_dat <- all_dat %>% mutate(FDis = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()

# ###Predict SE
# Data_AT_mean <- Data_AT %>% dplyr::select(Temperature, Aridity) %>% bind_cols(dummy_dat %>% dplyr::select(-Aridity) %>% slice(rep(1,nrow(Data_AT)))) %>% mutate(FDis = predict(Model_AridityTemp, newdata = (.))) #mutate(WWFBiome = 7) %>%
# names(Data_AT_mean)
# Data_AT_mean <- rename(Data_AT_mean, c("Temperature_mean"="Temperature", "FDis_mean"="FDis"))  
# 
# Data_AT_up <- Data_AT 
# Data_AT_up$Temperature <- Data_AT_up$Temperature_upper
# Data_AT_upper <- Data_AT_up %>% dplyr::select(Temperature, Aridity) %>% bind_cols(dummy_dat %>% dplyr::select(-Aridity) %>% slice(rep(1,nrow(Data_AT_up)))) %>% mutate(FDis = predict(Model_AridityTemp, newdata = (.))) #mutate(WWFBiome = 7) %>% 
# names(Data_AT_upper)
# Data_AT_upper <- rename(Data_AT_upper, c("Temperature_upper"="Temperature", "FDis_upper"="FDis"))
# 
# Data_AT_low <- Data_AT 
# Data_AT_low$Temperature <- Data_AT_low$Temperature_lower
# Data_AT_lower <- Data_AT_low %>% dplyr::select(Temperature, Aridity) %>% bind_cols(dummy_dat %>% dplyr::select(-Aridity) %>% slice(rep(1,nrow(Data_AT_low)))) %>% mutate(FDis = predict(Model_AridityTemp, newdata = (.))) #mutate(WWFBiome = 7) %>% 
# names(Data_AT_lower)
# Data_AT_lower <- rename(Data_AT_lower, c("Temperature_lower"="Temperature", "FDis_lower"="FDis"))  
# 
# Data_AT_final <- left_join(Data_AT_mean, Data_AT_upper, by='Aridity') %>% left_join(., Data_AT_lower, by='Aridity') %>% as.data.frame()

###

#Calculate mean temp and AI per biome
library(Rmisc)
Data_FDis_Env <- Data_FDis %>% dplyr::group_by(Biome) %>% dplyr::summarise(MeanTemp = mean(Temperature), MeanAI = mean(Aridity), uCI_AI = CI(Aridity, ci=0.95)["upper"], lCI_AI = CI(Aridity, ci=0.95)["lower"]) %>% as.data.frame()

#Data boundaries
boxplot(Data_FDis$Aridity)
boxplot(Data_FDis$FDis)

library(ggExtra)
GraphAridityTemp <- ggplot(all_dat, aes(x=Aridity, y=FDis, color=factor(Temperature)))+
  geom_point() + ylim(c(-1, 1)) + xlim(c(0,4)) +
  xlab("Aridity Index") + ylab("Difference FDis") +
  theme_classic()+ scale_colour_manual("Temperature", values=c( "#ffdd00", "#ffa200", "#ff4800", "#ff4800"), labels = c("Low (<4)", "Median (4-21)", "High (>21)"))+
  annotate("text", label = "Humid", x = 3.85, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 1.55, y = 0, xend = 1.55, yend = -Inf), linetype="dashed", colour="black") +
  theme(legend.position = "bottom",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))
GraphAridityTempFinal <- ggMarginal(GraphAridityTemp, type="boxplot", size=10)

###
Model_AT <- gam(Aridity ~ Temperature, data=Data_FDis)
Data_AT <- with(Data_FDis, data.frame(Temperature = seq(min(Temperature), max(Temperature), len=1000))) %>% mutate(Aridity = predict(Model_AT, newdata = (.), se = FALSE), Aridity_se = predict(Model_AT, newdata = (.), se = TRUE)$se) %>%
mutate(Aridity_upper = Aridity+1.96*Aridity_se, Aridity_lower = Aridity-1.96*Aridity_se)

dummy_dat <- with(Data_FDis, data.frame(Temperature = seq(min(Temperature), max(Temperature), len=1000))) #Forest_AgeScaled=mean(Forest_AgeScaled, na.rm=T)

AI_cut <- quantile(Data_FDis$Aridity, c(0.08, 0.5, 0.98), na.rm=T) #0.55, 0.988, 1
AI_cut

all_dat <- data.frame()

for(i in 1:length(AI_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(Aridity = AI_cut[i]))}

all_Temp <- all_dat %>% mutate(FDis = predict(Model_AridityTemp, newdata = all_dat)) %>% as.data.frame()

all_Temp$Aridity <- factor(all_Temp$Aridity)
GraphTempAridity <- ggplot(all_Temp, aes(x=Temperature, y=FDis, color=Aridity)) +
  geom_point() + ylim(c(-1, 1)) + 
  xlab("Temperature (C)") + ylab("Difference FDis") +
  theme_classic()+ scale_colour_manual("Aridity Index", values=c("#ffdd00", "#ffa200", "#ff4800", "#ff4800"), labels = c("Low (<0.7)", "Median (0.7-2)", "High (>2)"))+ #"#e600ff", "#8400ff", "#390061", "#390061"
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_segment(aes(x = 6.8, y = 0, xend = 6.8, yend = -Inf), linetype="dashed", colour="black") +
  theme(legend.position = "bottom",
        legend.text=element_text(size=12),
        legend.title=element_text(size=12, face="bold"),
        #legend.key.size = unit(3,"line"), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14)) +
  guides(color = guide_legend(override.aes = list(size=3)))
GraphTempAridityFinal <- ggMarginal(GraphTempAridity, type="boxplot", size=10)

###Scatterplots
#Graphs scatterplot Environmental variables
paletteForUse <- c('#d10000', '#ff6622', '#ffda21', '#33dd00', '#1133cc', '#220066', '#330044')
colors <-  colorRampPalette(paletteForUse)(256)

DifFDis_Envars$dens <- col2rgb(densCols(log(DifFDis_Envars$Precipitation_Seasonality), DifFDis_Envars$FDis))[1,] + 1L
DifFDis_Envars$colors = colors[DifFDis_Envars$dens]
FDis_PrecSeas <- ggplot(DifFDis_Envars, aes(log(Precipitation_Seasonality), FDis)) +
  geom_point(color= DifFDis_Envars$colors)+
  geom_smooth(se = FALSE, level=0.95, size= 2, colour="#0a0a0a", method="lm", span = 0.9) + #method="lm", 
  annotate("text", label = "r = -0.12", x = 4.5, y = 3.5, size = 6, colour = "black") +
  theme_classic()+ #xlim(20,200) + #ggtitle("Difference Dominant - Rare sp")+
  geom_hline(yintercept=0, linetype="dashed", color = "grey", size=1) +
  xlab("log(Precipitation seasonality) (mm/yr)") + ylab("Difference Trait Variation")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

DifFDis_Envars$dens <- col2rgb(densCols(log(DifFDis_Envars$Aridity/0.0001), DifFDis_Envars$FDis))[1,] + 1L
DifFDis_Envars$colors = colors[DifFDis_Envars$dens]
FDis_Aridity <- ggplot(DifFDis_Envars, aes(log(Aridity/0.0001), FDis)) +
  geom_point(color= DifFDis_Envars$colors)+
  geom_smooth(se = FALSE, level=0.95, size= 2, colour="#0a0a0a", method="lm", span = 0.9) + #method="lm", 
  annotate("text", label = "r = -0.12", x = 20, y = 3.5, size = 6, colour = "black") +
  theme_classic()+ #xlim(20,200) + #ggtitle("Difference Dominant - Rare sp")+
  geom_hline(yintercept=0, linetype="dashed", color = "grey", size=1) +
  xlab("log(Aridity)") + ylab("Difference Trait Variation")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

DifFDis_Envars$dens <- col2rgb(densCols(DifFDis_Envars$Forest_Age, DifFDis_Envars$FDis))[1,] + 1L
DifFDis_Envars$colors = colors[DifFDis_Envars$dens]
FDis_Forest_Age <- ggplot(DifFDis_Envars, aes(Forest_Age, FDis)) +
  geom_point(color= DifFDis_Envars$colors)+
  geom_smooth(se = FALSE, level=0.95, size= 2, colour="#0a0a0a", method="lm", span = 0.9) + #method="lm", 
  annotate("text", label = "r = -0.15", x = 90, y = 3.5, size = 6, colour = "black") +
  theme_classic()+ #xlim(20,200) + #ggtitle("Difference Dominant - Rare sp")+
  geom_hline(yintercept=0, linetype="dashed", color = "grey", size=1) +
  xlab("Forest age (yr)") + ylab("Difference Trait Variation")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

graph_FDis <- grid.arrange(FDisSE, top=textGrob("Trait variation correlated with climatic variables", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))
graph_Env <- grid.arrange(FDis_Forest_Age, FDis_PrecSeas, FDis_Aridity, nrow=1)
grid.arrange(graph_FDis, graph_Env, nrow=2)

####Regression line ForestAge, Aridity and Temperature
dim(DifFDis_Envars)

DifFDis_SelectForest_Age <- DifFDis_Envars[complete.cases(DifFDis_Envars$Forest_Age), ]
#cor.test(DifFDis_SelectForest_Age$Forest_Age, DifFDis_SelectForest_Age$FDis, method="spearman") #all corrletaion p<0.001
FDis_Forest_Age <- ggplot(DifFDis_SelectForest_Age, aes(Forest_Age, FDis)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + xlim(25,100) + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.15", x = 90, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + xlab("Forest Age (yr)") + ylab("Difference FDis")+ 
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(FDis ~ Forest_Age, data=DifFDis_SelectForest_Age))), alpha = 0.3,fill = "blue")+
  geom_segment(aes(x = 62, y = 0, xend = 62, yend = -Inf), linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

DifFDis_Envars$AridityFinal <- DifFDis_Envars$Aridity*0.0001
DifFDis_Envars$AridityFinalScaled <- scale(DifFDis_Envars$AridityFinal)
DifFDis_SelectAridity <- DifFDis_Envars[which(DifFDis_Envars$AridityFinal <= 4),]
#cor.test(DifFDis_Envars$AridityFinal, DifFDis_Envars$FDis, method="spearman") #all corrletaion p<0.001
a <- lm(FDis  ~ AridityFinal, data=DifFDis_SelectAridity) #0.011
a <- lm(FDis ~ poly(AridityFinalScaled, 2, raw=TRUE), data=DifFDis_Envars) #2:0.011 #3:0.011
vif(a)
summary(a) 
anova(a) 
plot(a)
(coef <- as.data.frame(coefficients(a)))

FDis_Aridity <- ggplot(DifFDis_SelectAridity, aes(AridityFinal, FDis)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE)) + coord_cartesian(ylim=c(-1, 1)) +
  theme_classic() + xlim(0,4) +
  geom_hline(yintercept=0, color = "grey", size=1) + xlab("Aridity Index") + ylab("Difference FDis")+ 
  annotate("text", label = "Humid", x = 3.85, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0,ymax = predict(lm(FDis ~ poly(AridityFinal, 2, raw=TRUE), data=DifFDis_SelectAridity))), alpha = 0.6,fill = "#ffa200")+
  geom_segment(aes(x = 1.55, y = 0, xend = 1.55, yend = -Inf), linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

DifFDis_Envars$Temperature <- DifFDis_Envars$Temperature/10
#cor.test(DifFDis_Envars$Temperature, DifFDis_Envars$FDis, method="spearman") #all corrletaion p<0.001
a <- lm(FDis  ~ Temperature, data=DifFDis_SelectAridity) #0.018
a <- lm(FDis ~ poly(Temperature, 2, raw=TRUE), data=DifFDis_Envars) #2:0.026 #3:0.042
summary(a) 
anova(a) 
plot(a)
(coef <- as.data.frame(coefficients(a)))

FDis_Temperature <- ggplot(DifFDis_Envars, aes(Temperature, FDis)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm", formula=y ~ poly(x, 2, raw=TRUE)) + coord_cartesian(ylim=c(-1, 1)) +
  #annotate("text", label = "r = 0.13", x = 24, y = 0.8, size = 6, colour = "black") + 
  theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + #linetype="dashed", 
  xlab("Temperature (C)") + ylab("Difference FDis")+ 
  geom_ribbon(aes(ymin = 0,ymax = predict(lm(FDis  ~ poly(Temperature, 2, raw=TRUE), data=DifFDis_Envars))), alpha = 0.6,fill = "#8400ff")+
  geom_segment(aes(x = 6, y = 0, xend = 6, yend = -Inf), linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Fig4A <- grid.arrange(Graph_FDisCI, top=textGrob("Trait diversity correlated with climatic variables", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

Layout_matrix = rbind(c(1,2),
                      c(3,3),
                      c(3,3))

Fig4B <- grid.arrange(FDis_Temperature, FDis_Aridity, GraphTempAridityFinal, layout_matrix=Layout_matrix)
grid.arrange(Fig4A, Fig4B, nrow=2)


```
###Centroid graphs
```{r Centroid graphs}

###Match species with trait data
setwd("~/Documents/PhD projects/Traits Dominant Species/")
Species_Ecoregion <- fread("~/Documents/PhD projects/Traits Dominant Species/DominantRare_Ecoregion_8-2021.csv")

setwd("~/Desktop")
Traits <- read_feather("~/Desktop/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

Ecoregion_SpTraits <- left_join(Species_Ecoregion, Traits, by="obs_id")
rm(Traits, Species_Ecoregion)

names(Ecoregion_SpTraits)
Ecoregion_SpTraits <- subset(Ecoregion_SpTraits, select=-c(lat, lon, accepted_bin, old_plot_id))
setnames(Ecoregion_SpTraits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                                 "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44", "trait45",  
                                 "trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9", "plot_id.x", "dbh.x", "tph.x", "year.x"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll", "LeafK", "StomatalConductance",
                 "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN", "RootShootRatio","plot_id", "dbh", "tph", "year"))

###Log transform and scale traits 
#boxplot(Biome_SpTraits$RootCN) #Check if log transformation is necessary
Ecoregion_SpTraitsCompl <- Ecoregion_SpTraits[complete.cases(Ecoregion_SpTraits),]#Erase incomplete rows: none

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Ecoregion_SpTraitsCompl, file="Ecoregion_Traits_8-2021.csv")

rm(Ecoregion_SpTraits)

#Ecoregion_SpTraitsCompl <- fread("~/Documents/PhD projects/Traits Dominant Species/Ecoregion_Traits_8-2021.csv")
Ecoregion_SpTraitsLog <- Ecoregion_SpTraitsCompl %>% mutate_at(vars(RootCN:RootShootRatio), log) #First log traits to normalise outliers
Ecoregion_SpTraitsMean <- Ecoregion_SpTraitsLog %>% group_by(Ecoregion, plot_id, species_name) %>% slice(1) #%>% summarise_at(vars(-c(NrInd)), mean)  #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Ecoregion_TraitsNrInd <- Ecoregion_SpTraitsLog %>% group_by(Ecoregion, plot_id, species_name) %>% summarise(NrIndSp=sum(NrInd)) 
Ecoregion_TraitsMeanMerge <- as.data.frame(left_join(Ecoregion_SpTraitsMean, Ecoregion_TraitsNrInd, by=c("plot_id","species_name")))

Ecoregion_TraitsMeanMerge <- subset(Ecoregion_TraitsMeanMerge, select = -c(Ecoregion.y, plot_id.y, dbh.y, tph.y, year.y))
Ecoregion_TraitsScaled <- Ecoregion_TraitsMeanMerge %>% mutate_at(vars(RootCN:RootShootRatio), scale) #Standardise trait values by Ecoregion or globally group_by(Ecoregion) %>% 
Ecoregion_TraitsScaled <- as.data.frame(Ecoregion_TraitsScaled)

setnames(Ecoregion_TraitsScaled, old=c("Ecoregion.x"), new=c("Ecoregion"))
Ecoregion_TraitsScaled <- as.data.frame(Ecoregion_TraitsScaled)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Ecoregion_TraitsScaled, file="Ecoregion_TraitsScaledGlobally_8-2021.csv") #Scaled globally

rm(list=setdiff(ls(), "Ecoregion_TraitsScaled"))

###Calculate FDis
###Scale and mean trait values
setwd("~/Documents/PhD projects/Traits Dominant Species")
Ecoregion_TraitsScaled <- fread("~/Documents/PhD projects/Traits Dominant Species/Ecoregion_TraitsScaledGlobally_8-2021.csv")

Ecoregion_Traits <- subset(Ecoregion_TraitsScaled, select=c(Ecoregion, species_name, DominanceCategory, Height, WoodDensity, SLA, LeafNP, RootDepth, SeedMass))
Ecoregion_TraitsDR <- Ecoregion_Traits[which(Ecoregion_Traits$DominanceCategory == "rare" | Ecoregion_Traits$DominanceCategory == "dominant"),]

Ecoregion_TraitsDR$DominanceCategory <- ifelse(Ecoregion_TraitsDR$DominanceCategory == "dominant", "2", "1") #2=dominant, 1=rare
Ecoregion_TraitsDR$DominanceCategory <- as.numeric(Ecoregion_TraitsDR$DominanceCategory)
Ecoregion_TraitsDRMean <- Ecoregion_TraitsDR %>% group_by(DominanceCategory, Ecoregion, species_name) %>% summarise_all(mean) 
Ecoregion_TraitsDRMean <- as.data.frame(Ecoregion_TraitsDRMean)

###Trait diversity Ecoregion level
Ecoregion_TraitsDRMean$SpeciesEcoregion <- paste(Ecoregion_TraitsDRMean$Ecoregion,Ecoregion_TraitsDRMean$species_name,sep="_")
Ecoregion_TraitsDRMean$NrInd <- 1

#Dominant species
TraitsD_Ecoregion <- Ecoregion_TraitsDRMean[which(Ecoregion_TraitsDRMean$DominanceCategory == 2),]
DominantTraits_Ecoregion <- TraitsD_Ecoregion[,c("SpeciesEcoregion", "Height", "WoodDensity", "SLA", "LeafNP", "RootDepth", "SeedMass")]
DominantAbundance_Ecoregion <- TraitsD_Ecoregion[,c("Ecoregion", "SpeciesEcoregion", "NrInd")]
DominantAbundance_Ecoregion <- as.data.frame(DominantAbundance_Ecoregion)

#Rare species
TraitsR_Ecoregion <- Ecoregion_TraitsDRMean[which(Ecoregion_TraitsDRMean$DominanceCategory == 1),]
RareTraits_Ecoregion <- TraitsR_Ecoregion[,c("SpeciesEcoregion", "Height", "WoodDensity", "SLA", "LeafNP", "RootDepth", "SeedMass")]
RareAbundance_Ecoregion <- TraitsR_Ecoregion[,c("Ecoregion", "SpeciesEcoregion", "NrInd")]
RareAbundance_Ecoregion <- as.data.frame(RareAbundance_Ecoregion)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(RareAbundance_Ecoregion, file = "RareSpAbundanceEcoregion_27072021.csv")
fwrite(DominantAbundance_Ecoregion, file = "DominantSpAbundanceEcoregion_27072021.csv")
fwrite(RareTraits_Ecoregion, file = "RareSpTraitsEcoregion_27072021.csv")
fwrite(DominantTraits_Ecoregion, file = "DominantSpTraitsEcoregion_27072021.csv")

###Calculate FDis Dominant Sp
Abundance <- DominantAbundance_Ecoregion[order(DominantAbundance_Ecoregion$SpeciesEcoregion),]
Traits <- DominantTraits_Ecoregion[order(DominantTraits_Ecoregion$SpeciesEcoregion),]
AbundanceSpread <- spread(Abundance, SpeciesEcoregion, NrInd,  fill = 0)
AbundanceSpreads <- AbundanceSpread[, -c(1)] #Last row is plot_id? ###Adjust!
row.names(AbundanceSpreads) <- AbundanceSpread$Ecoregion

Trait <- as.data.frame(Traits[, -c(1)])
row.names(Trait) <- Traits$SpeciesEcoregion
AbundanceSpreadOrder <- setcolorder(AbundanceSpreads, as.character(Trait$SpeciesEcoregion))
AbundanceSpreadOrder <- as.matrix(AbundanceSpreadOrder)

Analyse <- as.data.frame(dbFD(Trait, AbundanceSpreadOrder, calc.FRic = TRUE, w.abun=FALSE, stand.x=FALSE, scale.RaoQ=TRUE))

Analyse <- as.data.frame(Analyse)
Analyse$Ecoregion <- AbundanceSpread$Ecoregion
Analyse$SpeciesCategory <- "dominant"
head(Analyse)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Analyse, file="FDiv_Dominant_Ecoregion_27-07-2021.csv") 

#Calculate FDis Rare sp
Abundance <- RareAbundance_Ecoregion[order(RareAbundance_Ecoregion$SpeciesEcoregion),]
Traits <- RareTraits_Ecoregion[order(RareTraits_Ecoregion$SpeciesEcoregion),]
AbundanceSpread <- spread(Abundance, SpeciesEcoregion, NrInd,  fill = 0)
AbundanceSpreads <- AbundanceSpread[, -c(1)] #Last row is plot_id? ###Adjust!
row.names(AbundanceSpreads) <- AbundanceSpread$Ecoregion

Trait <- as.data.frame(Traits[, -c(1)])
row.names(Trait) <- Traits$SpeciesEcoregion
AbundanceSpreadOrder <- setcolorder(AbundanceSpreads, as.character(Trait$SpeciesEcoregion))
AbundanceSpreadOrder <- as.matrix(AbundanceSpreadOrder)

Analyse <- as.data.frame(dbFD(Trait, AbundanceSpreadOrder, calc.FRic = TRUE, w.abun=FALSE, stand.x=FALSE, scale.RaoQ=TRUE))

Analyse <- as.data.frame(Analyse)
Analyse$Ecoregion <- AbundanceSpread$Ecoregion
Analyse$SpeciesCategory <- "rare"
head(Analyse)

setwd("~/Documents/PhD projects/Traits Dominant Species")
fwrite(Analyse, file="FDiv_Rare_Ecoregion_27-07-2021.csv") 

FDivDom_Ecoregion <- fread("~/Documents/PhD projects/Traits Dominant Species/FDiv_Dominant_Ecoregion_27-07-2021.csv")
FDivRare_Ecoregion <- fread("~/Documents/PhD projects/Traits Dominant Species/FDiv_Rare_Ecoregion_27-07-2021.csv")

FDivDom <- select(FDivDom_Ecoregion, Ecoregion, FDis)
FDivRare <- select(FDivRare_Ecoregion, Ecoregion, FDis)

DiffFDivDomRare <- FDivDom-FDivRare
DiffFDivDomRare$Ecoregion <- FDivRare$Ecoregion
DiffFDivDomRare$FDisDom <- FDivRare$FDis
DiffFDivDomRare$FDisRare <- FDivDom$FDis
DiffFDivDomRare <- as.data.frame(DiffFDivDomRare)

###Calculate Distance centroids
setwd("~/Documents/PhD projects/Traits Dominant Species")
Ecoregion_TraitsScaled <- fread("~/Documents/PhD projects/Traits Dominant Species/Ecoregion_TraitsScaledGlobally_8-2021.csv")

Ecoregion_Traits <- subset(Ecoregion_TraitsScaled, select=c(Ecoregion, species_name, DominanceCategory, Height, WoodDensity, SLA, LeafNP, RootDepth, SeedMass))

#Ecoregion_TraitsDR$DominanceCategory <- ifelse(Ecoregion_TraitsDR$DominanceCategory == "dominant", "2", "1") #2=dominant, 1=rare
#Ecoregion_TraitsDR$DominanceCategory <- as.numeric(Ecoregion_TraitsDR$DominanceCategory)
Ecoregion_TraitsMean <- Ecoregion_Traits %>% group_by(DominanceCategory, Ecoregion, species_name) %>% summarise_all(mean) 
Ecoregion_TraitsMean <- as.data.frame(Ecoregion_TraitsMean)

Ecoregion_TraitsMean$DominanceCategory[Ecoregion_TraitsMean$DominanceCategory == "dominant"] <- "1"
Ecoregion_TraitsMean$DominanceCategory[Ecoregion_TraitsMean$DominanceCategory == "rare"] <- "2"
Ecoregion_TraitsMean$DominanceCategory[Ecoregion_TraitsMean$DominanceCategory == "intermediate"] <- "3"
Ecoregion_TraitsMean$DominanceCategory <- as.numeric(Ecoregion_TraitsMean$DominanceCategory)

u_Ecoregions <- Ecoregion_TraitsMean %>% ungroup %>% dplyr::select(Ecoregion) %>% distinct() %>% unlist 
DistanceCentroids <- tibble()
for(i in 1:length(u_Ecoregions)){
  Data <- Ecoregion_TraitsMean %>% filter(Ecoregion == u_Ecoregions[i])
  df <- subset(Data, select=-c(DominanceCategory, Ecoregion, species_name))
  Ecoregion.pca <- prcomp(df, scale. = TRUE)
  df.Ecoregion.x <- as.data.frame(Ecoregion.pca$x)
  df.Ecoregion.x$groups <- Data$DominanceCategory
  pca.centroids <- aggregate(df.Ecoregion.x[,1:7], list(Type = df.Ecoregion.x$groups), mean)
  DistanceCentroids <- DistanceCentroids %>% rbind(tibble(Ecoregion = u_Ecoregions[i], distance = dist(rbind(pca.centroids[pca.centroids$Type == "1",1:6],pca.centroids[pca.centroids$Type == "2",1:6]), method = "euclidean")))
}

DistanceCentroids <- as.data.frame(DistanceCentroids)
head(DistanceCentroids)

###Graph Ecoregion level
DistanceFDiv <- merge(DistanceCentroids, DiffFDivDomRare, by="Ecoregion")
names(DistanceFDiv)
dim(DistanceFDiv)
unique(DistanceFDiv$Ecoregion)

#Add ecoregion names
Ecoregion_names <- read_excel("~/Documents/PhD projects/Traits Dominant Species/Ecoregions_NumbersAndNames.xlsx")

DistanceFDivNames <- merge(x = DistanceFDiv, y = Ecoregion_names, by.x = "Ecoregion", by.y="Number", all.x = TRUE)

graphEcoregion <- ggplot(data=DistanceFDivNames, aes(x=FDis, y=distance))+ geom_point(colour=DistanceFDiv$Ecoregion) + #geom_smooth(method="loess", span=0.9) +
  geom_text(aes(label=Description),hjust=0, vjust=0) +  theme(legend.position = "none") + xlab("Difference FDis Dom-Rare") + ylab("Distance centroids") + ggtitle("Ecoregions")

graphEcoregionDom <- ggplot(data=DistanceFDivNames, aes(x=FDisDom, y=distance))+ geom_point(colour=DistanceFDiv$Ecoregion) + #geom_smooth(method="loess", span=0.9) +
  geom_text(aes(label=Description),hjust=0, vjust=0) +  theme(legend.position = "none") + xlab("Difference FDis Dom-Rare") + ylab("Distance centroids") + ggtitle("Ecoregions")

graphEcoregionRare <- ggplot(data=DistanceFDivNames, aes(x=FDisRare, y=distance))+ geom_point(colour=DistanceFDiv$Ecoregion) + #geom_smooth(method="loess", span=0.9) +
  geom_text(aes(label=Description),hjust=0, vjust=0) +  theme(legend.position = "none") + xlab("Difference FDis Dom-Rare") + ylab("Distance centroids") + ggtitle("Ecoregions")

```
###Biome level Centroid/FDis/Feve/Fric graphs
```{r Biome Centroid/FDis/Feve/Fric graphs}
setwd("~/Documents/PhD projects/Traits Dominant species/")
Biome_level <- fread("~/Documents/PhD projects/Traits Dominant species/Biome_FDis.csv") 

Biome_level$Biome <- as.factor(Biome_level$Biome)
Biome_level$Biome_short <- c("Trop moist", "Trop dry ", "Trop   conifer", "Temperate", "Temp conifer", "Boreal", "Trop moist", "Trop dry ", "Trop   conifer", "Temperate", "Temp conifer", "Boreal")

# Graph_BiomeFDis <- ggplot(data=Biome_level, aes(y=factor(Biome), x=Fdis, fill=SpeciesCategory)) + geom_point(aes(colour=SpeciesCategory), size=4) +
#   scale_color_manual(breaks = c("dominant", "rare"), values=alpha(c("blue1", "deepskyblue"),.8)) +
#   theme_classic() + ggtitle("Trait Diversity") +  xlab("Trait Diversity (FDis)") + #xlim(-0.5,0.5) + #ylab("Altitude (m)") +
#   scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry ", "Tropical Moist")) +
#   theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
#         legend.position = "none",
#         axis.title.x = element_text(size = 14),
#         axis.text.x = element_text(size = 14),
#         axis.title.y = element_blank(),
#         axis.text.y = element_blank())
# 
# Graph_BiomeFric <- ggplot(data=Biome_level, aes(y=factor(Biome), x=Fric, fill=SpeciesCategory)) + geom_point(aes(colour=SpeciesCategory), size=4) +
#   scale_color_manual(breaks = c("dominant", "rare"), values=alpha(c("blue1", "deepskyblue"),.8)) +
#   theme_classic() + ggtitle("Trait Space") +  xlab("Trait Space (FRic)") + #xlim(-0.5,0.5) + #ylab("Altitude (m)") +
#   scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry ", "Tropical Moist")) +
#   theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
#         legend.position = "none",
#         axis.title.x = element_text(size = 14),
#         axis.text.x = element_text(size = 14),
#         axis.title.y = element_blank(),
#         axis.text.y = element_blank())
# 
# Graph_BiomeFeve <- ggplot(data=Biome_level, aes(y=factor(Biome), x=Feve, fill=SpeciesCategory)) + geom_point(aes(colour=SpeciesCategory), size=4) +
#   scale_color_manual(breaks = c("dominant", "rare"), values=alpha(c("blue1", "deepskyblue"),.8)) +
#   theme_classic() + ggtitle("Trait Evenness") +  xlab("Trait Evenness (FEve)") + #xlim(-0.5,0.5) + #ylab("Altitude (m)") +
#   scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry ", "Tropical Moist")) +
#   theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
#         legend.position = "none",
#         axis.title.x = element_text(size = 14),
#         axis.text.x = element_text(size = 14),
#         axis.title.y = element_blank(),
#         axis.text.y = element_blank()) #axis.text.y = element_text(size = 16)

Graph_CentroidFDis <- ggplot(data=Biome_level, aes(x=Fdis_dif, y=Centroids_dist)) + geom_point(colour="#047000", size=4) + geom_smooth(method="lm", se=FALSE, colour="grey") +
  annotate("text", label = "r = 0.78, p=0.06", x = 0.35, y = 3.8, size = 5, colour = "black") + geom_vline(xintercept = 0, linetype="dotted", color = "grey", size=1.5) +
  geom_text(aes(label=Biome_short),hjust=0.5, vjust=0, size=6) +  
  xlab("Difference Trait Diversity (FDis)") + ylab("Distance centroids") + ggtitle("Biomes") + ylim(1,3.8) + theme_classic() + #theme(legend.position = "none") + 
  theme(plot.title = element_blank(),
        legend.position = "none",
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 16))

Graph_Centroid <- ggplot(data=Biome_level, aes(y=factor(Biome), x=Centroids_dist)) + geom_point(size=4, colour="#047000") + 
  theme_classic() + ggtitle("Centroid Distance") +  xlab("Centroid distance") + 
  scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry", "Tropical Moist")) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 14))

Graph_BiomeFDisDif <- ggplot(data=Biome_level, aes(y=factor(Biome), x=Fdis_dif)) + geom_point(size=4, colour="#047000") +
  theme_classic() + ggtitle("Trait Diversity") +  xlab("Difference Trait Diversity (FDis)") + geom_vline(xintercept = 0, linetype="dotted", color = "grey", size=1.5) +
  scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry ", "Tropical Moist")) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())

Graph_BiomeFricDif <- ggplot(data=Biome_level, aes(y=factor(Biome), x=Fric_dif)) + geom_point(size=4, colour="#047000") +
  theme_classic() + ggtitle("Trait Space") +  xlab("Difference Trait Space (FRic)") + geom_vline(xintercept = 0, linetype="dotted", color = "grey", size=1.5) +
  scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry ", "Tropical Moist")) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())

library(ggthemes)

Graph_BiomeFeveDif <- ggplot(data=Biome_level, aes(y=factor(Biome), x=Feve_dif)) + geom_point(size=4, colour="#047000") +
  theme_minimal() + ggtitle("Trait Evenness") +  xlab("Difference Trait Evenness (FEve)") + geom_vline(xintercept = 0, linetype="dotted", color = "grey", size=1.5) +
  scale_y_discrete(labels=c("Boreal", "Temperate Conifer", "Temperate", "Tropical Conifer", "Tropical Dry ", "Tropical Moist")) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 14))

Layout = matrix(c(1,1,2,3,3,4))

Layout_matrix = rbind(c(1,1,1,1,2,2,2),
                      c(3,3,3,3,4,4,4))

Fig4A <- grid.arrange(Graph_Centroid, Graph_BiomeFDisDif, Graph_BiomeFricDif, Graph_BiomeFeveDif, layout_matrix=Layout_matrix)
Fig4B <- Graph_CentroidFDis
Fig4 <- grid.arrange(Fig4A, Fig4B, nrow=1, top=textGrob("Biome level differences in trait space", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

Layout = matrix(c(1,1,1,1,2,2,2,3,3,3,4,4,4))
Fig4 <- grid.arrange(Graph_Centroid, Graph_BiomeFDisDif, Graph_BiomeFricDif, Graph_BiomeFeveDif, layout_matrix=Layout_matrix, nrow=2,  top=textGrob("Biome level differences in trait space of dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

Layout = rbind(c(1,1,1,1,2,2,2,3,3,3))
Fig4 <- grid.arrange(Graph_Centroid, Graph_BiomeFricDif, Graph_BiomeFDisDif,  layout_matrix=Layout, nrow=1,  top=textGrob("Biome level differences in trait space of dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

Fig4SI <- grid.arrange(Graph_Centroid, Graph_BiomeFDisDif, Graph_BiomeFricDif, Graph_BiomeFeveDif, layout_matrix=Layout_matrix, nrow=2,  top=textGrob("Biome level differences in trait space of dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

```
###Scatterplots difference traits plot level with environmental variables
```{r Traits and environmental variables}

###Difference between CWM dominant and rare species traits
Plot_TraitsScaled <- fread("~/Documents/PhD projects/Traits Dominant Species/Plot_TraitsScaledGlobally_8-2021.csv")
 
Plot_TraitsScaled <- subset(Plot_TraitsScaled, select=c(Biome, plot_id, species_name, DominanceCategory, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))

Plot_TraitsD <- Plot_TraitsScaled[which(Plot_TraitsScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsScaled[which(Plot_TraitsScaled$DominanceCategory == "rare"),]

#Calculate CWM
TraitsD_CWM <- Plot_TraitsD %>% group_by(Biome, plot_id, DominanceCategory) %>% summarise_at(c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP","StemConduitDiameter", "RootDepth", "SeedMass"), mean)
TraitsR_CWM <- Plot_TraitsR %>% group_by(Biome, plot_id, DominanceCategory) %>% summarise_at(c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP","StemConduitDiameter", "RootDepth", "SeedMass"), mean)

#Calculate difference dominant-rare species CWM
JoinRare <- anti_join(TraitsR_CWM, TraitsD_CWM, by="plot_id")
JoinDom <- anti_join(TraitsD_CWM, TraitsR_CWM, by="plot_id")

CWMDomFilter <- anti_join(TraitsD_CWM, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(TraitsR_CWM, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- CWMRareOrder$Biome

#Pair up with environmental variables
#Import and add GEE information
setwd("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/Traits Dominant Species/Traits03-05-2021") %>% map_df(~fread(.)))
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature, CHELSA_BIO_Annual_Precipitation, CHELSA_BIO_Precipitation_Seasonality, CHELSA_BIO_Temperature_Seasonality, EarthEnvTopoMed_Elevation, GFAD_FractionOfRegrowthForest_downsampled50km, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/Traits Dominant Species/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/Traits Dominant Species/TraitsPET_07-2021") %>% map_df(~fread(.)))
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index, CGIAR_PET))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CHELSA_BIO_Annual_Precipitation", "CHELSA_BIO_Precipitation_Seasonality",  "CHELSA_BIO_Temperature_Seasonality", "EarthEnvTopoMed_Elevation", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "CGIAR_Aridity_Index", "CGIAR_PET"), new=c("Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "Forest_Age", "Aridity", "PET"))

DifCWM_Envars <- left_join(DiffDomRare_CWM, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

###Correlations CWM-Environmental vars
dataframe <- subset(DifCWM_Envars, select=-c(plot_id, Biome))
#dataframe <- dataframe[complete.cases(dataframe),]
res <- as.data.frame(cor(dataframe, method = "spearman"))
results <- res[1:10, 11:19]

###Models Difference in traits and environmental variables
boxplot(log(DifFDis_Envars$Aridity*0.0001))

DifCWM_Envars$TemperatureScaled <- scale(DifCWM_Envars$Temperature/10)
DifCWM_Envars$AridityScaled <- scale(log(DifCWM_Envars$Aridity*0.0001))
DifCWM_Envars$Forest_AgeScaled <- scale(DifCWM_Envars$Forest_Age)
Data_DifCWM <- DifCWM_Envars[complete.cases(DifCWM_Envars$Forest_AgeScaled), ]

Data_DifCWM$PrecipitationScaled <- scale(Data_DifCWM$Precipitation)

###Mean absolute difference between biomes
Data_DifCWMSelect <- Data_DifCWM %>% select(1:10, 12)
Data_DifCWMabs <- Data_DifCWMSelect %>% group_by(Biome) %>% mutate(Height=abs(Height), CrownDiameter=abs(CrownDiameter), BarkThickness=abs(BarkThickness), WoodDensity=abs(WoodDensity), SLA=abs(SLA), LeafN=abs(LeafN), LeafNP=abs(LeafNP), StemConduitDiameter=abs(StemConduitDiameter), RootDepth=abs(RootDepth), SeedMass=abs(SeedMass))
Data_DifCWMabsMean <- Data_DifCWMabs %>% group_by(Biome) %>% summarise_all(list(mean))
MeanperBiome <- rowMeans(Data_DifCWMabsMean)

Heightlm <- lm(abs(Height)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.06
#HeightPoly <- lm(abs(Height) ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.002, 3:0.007, 4:n.s.
Coef <- as.data.frame(Heightlm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "Height"
setnames(Coef, old="Heightlm$coefficients", new="Coefficients")
Coef_Height <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_Height <- Coef_Height %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

CrownDiameterlm <- lm(abs(CrownDiameter)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.02
#CrownDiameterPoly <- lm(CrownDiameter ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.02, 3:0.02, 4:0.02
Coef <- as.data.frame(CrownDiameterlm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "CrownDiameter"
setnames(Coef, old="CrownDiameterlm$coefficients", new="Coefficients")
Coef_CrownDiameter <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_CrownDiameter <- Coef_CrownDiameter %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

WoodDensitylm <- lm(abs(WoodDensity)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.01
#WoodDensityPoly <- lm(WoodDensity ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 2, raw=TRUE), data=Data_DifCWM) #2:0.039, 3:0.039 (n.s.), 4:0.045
Coef <- as.data.frame(WoodDensitylm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "WoodDensity"
setnames(Coef, old="WoodDensitylm$coefficients", new="Coefficients")
Coef_WoodDensity <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_WoodDensity <- Coef_WoodDensity %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

SLAlm <- lm(abs(SLA)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.09
#SLAPoly <- lm(SLA ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.013, 3:0.014, 4:0.017
Coef <- as.data.frame(SLAlm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "SLA"
setnames(Coef, old="SLAlm$coefficients", new="Coefficients")
Coef_SLA <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_SLA <- Coef_SLA %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

LeafNPlm <- lm(abs(LeafNP)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.05
#LeafNPPoly <- lm(LeafNP ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.021, 3:0.029, 4:0.032
Coef <- as.data.frame(LeafNPlm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "LeafNP"
setnames(Coef, old="LeafNPlm$coefficients", new="Coefficients")
Coef_LeafNP <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_LeafNP <- Coef_LeafNP %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

RootDepthlm <- lm(abs(RootDepth)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.13
#RootDepthPoly <- lm(RootDepth ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.029, 3:0.030, 4:0.032
Coef <- as.data.frame(RootDepthlm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "RootDepth"
setnames(Coef, old="RootDepthlm$coefficients", new="Coefficients")
Coef_RootDepth <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_RootDepth <- Coef_RootDepth %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

###SI
BarkThicknesslm <- lm(abs(BarkThickness)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.03
#BarkThicknessPoly <- lm(BarkThickness ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.029, 3:0.030, 4:0.032
Coef <- as.data.frame(BarkThicknesslm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "BarkThickness"
setnames(Coef, old="BarkThicknesslm$coefficients", new="Coefficients")
Coef_BarkThickness <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_BarkThickness <- Coef_BarkThickness %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

StemConduitDiameterlm <- lm(abs(StemConduitDiameter)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.10
#StemConduitDiameterPoly <- lm(StemConduitDiameter ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.029, 3:0.030, 4:0.032
Coef <- as.data.frame(StemConduitDiameterlm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "StemConduitDiameter"
setnames(Coef, old="StemConduitDiameterlm$coefficients", new="Coefficients")
Coef_StemConduitDiameter <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_StemConduitDiameter <- Coef_StemConduitDiameter %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

LeafNlm <- lm(abs(LeafN)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.03
#LeafNPoly <- lm(LeafN ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.029, 3:0.030, 4:0.032
Coef <- as.data.frame(LeafNlm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "LeafN"
setnames(Coef, old="LeafNlm$coefficients", new="Coefficients")
Coef_LeafN <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_LeafN <- Coef_LeafN %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

SeedMasslm <- lm(abs(SeedMass)  ~ TemperatureScaled * AridityScaled + Forest_AgeScaled, data=Data_DifCWM) #0.03
#SeedMassPoly <- lm(SeedMass ~ poly(TemperatureScaled * AridityScaled + Forest_AgeScaled, 4, raw=TRUE), data=Data_DifCWM) #2:0.029, 3:0.030, 4:0.032
Coef <- as.data.frame(SeedMasslm$coefficients)
Coef$Variables <- row.names(Coef)
Coef$Trait <- "SeedMass"
setnames(Coef, old="SeedMasslm$coefficients", new="Coefficients")
Coef_SeedMass <- Coef[ which(Coef$Variables=='TemperatureScaled' | Coef$Variables=='AridityScaled' | Coef$Variables=='TemperatureScaled:AridityScaled'), ]
Coef_SeedMass <- Coef_SeedMass %>% mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

###

#summary(RootDepthlm)
#plot(RootDepthlm)

Coef_total <- rbind(Coef_Height, Coef_CrownDiameter, Coef_WoodDensity, Coef_SLA, Coef_LeafNP, Coef_RootDepth)
Coef_total <- Coef_total %>% dplyr::group_by(Trait) %>% dplyr::mutate(Value = abs(Coefficients)/sum(abs(Coefficients))) %>% as.data.frame()

###Graph coeficients
Coef_Height$Variables <- factor(Coef_Height$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_Height$Coefficients <- round(Coef_Height$Coefficients, digits=2)
Coef_Height$Var <- c("T", "A", "I")
Coef_Height$VarCoef <- paste(Coef_Height$Var,Coef_Height$Coefficients, sep=" ")
Graph_Coef_Height <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_Height) + geom_bar(stat = 'identity') + geom_text(aes(label = VarCoef), position = position_stack(vjust = 0.5), colour = "white", fontface="bold", size=6) + scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_CrownDiameter$Variables <- factor(Coef_CrownDiameter$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_CrownDiameter$Coefficients <- round(Coef_CrownDiameter$Coefficients, digits=2)
Coef_CrownDiameter$Var <- c("T", "A", "I")
Coef_CrownDiameter$VarCoef <- paste(Coef_CrownDiameter$Var,Coef_CrownDiameter$Coefficients, sep=" ")
Graph_Coef_CrownDiameter <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_CrownDiameter) + geom_bar(stat = 'identity') + geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.5), colour = "white", fontface="bold", size=6) + scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_WoodDensity$Variables <- factor(Coef_WoodDensity$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_WoodDensity$Coefficients <- round(Coef_WoodDensity$Coefficients, digits=2)
Coef_WoodDensity$Var <- c("T", "A", "I")
Coef_WoodDensity$VarCoef <- paste(Coef_WoodDensity$Var,Coef_WoodDensity$Coefficients, sep=" ")
Graph_Coef_WoodDensity <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_WoodDensity) + geom_bar(stat = 'identity') + geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.5), colour = "white", fontface="bold", size=6) + scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_SLA$Variables <- factor(Coef_SLA$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_SLA$Coefficients <- round(Coef_SLA$Coefficients, digits=2)
Coef_SLA$Var <- c("T", "A", "I")
Coef_SLA$VarCoef <- paste(Coef_SLA$Var,Coef_SLA$Coefficients, sep=" ")
Graph_Coef_SLA <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_SLA) + geom_bar(stat = 'identity') + geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.5), colour = "white", fontface="bold", size=6) + scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_LeafNP$Variables <- factor(Coef_LeafNP$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_LeafNP$Coefficients <- round(Coef_LeafNP$Coefficients, digits=2)
Coef_LeafNP$Var <- c("T", "A", "I")
Coef_LeafNP$VarCoef <- paste(Coef_LeafNP$Var,Coef_LeafNP$Coefficients, sep=" ")
Graph_Coef_LeafNP <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_LeafNP) + geom_bar(stat = 'identity') + geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.5), colour = "white", fontface="bold", size=6) + scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_RootDepth$Variables <- factor(Coef_RootDepth$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_RootDepth$Coefficients <- round(Coef_RootDepth$Coefficients, digits=2)
Coef_RootDepth$Var <- c("T", "A", "I")
Coef_RootDepth$VarCoef <- paste(Coef_RootDepth$Var,Coef_RootDepth$Coefficients, sep=" ")
Graph_Coef_RootDepth <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_RootDepth) + geom_bar(stat = 'identity') + 
  #geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.7), colour = "white", fontface="bold", size=6) + 
  scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

###SI
Coef_BarkThickness$Variables <- factor(Coef_BarkThickness$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_BarkThickness$Coefficients <- round(Coef_BarkThickness$Coefficients, digits=2)
Coef_BarkThickness$Var <- c("T", "A", "I")
Coef_BarkThickness$VarCoef <- paste(Coef_BarkThickness$Var,Coef_BarkThickness$Coefficients, sep=" ")
Graph_Coef_BarkThickness <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_BarkThickness) + geom_bar(stat = 'identity') + 
  #geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.7), colour = "white", fontface="bold", size=6) + 
  scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_StemConduitDiameter$Variables <- factor(Coef_StemConduitDiameter$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_StemConduitDiameter$Coefficients <- round(Coef_StemConduitDiameter$Coefficients, digits=2)
Coef_StemConduitDiameter$Var <- c("T", "A", "I")
Coef_StemConduitDiameter$VarCoef <- paste(Coef_StemConduitDiameter$Var,Coef_StemConduitDiameter$Coefficients, sep=" ")
Graph_Coef_StemConduitDiameter <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_StemConduitDiameter) + geom_bar(stat = 'identity') + 
  geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.7), colour = "white", fontface="bold", size=6) + 
  scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_LeafN$Variables <- factor(Coef_LeafN$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_LeafN$Coefficients <- round(Coef_LeafN$Coefficients, digits=2)
Coef_LeafN$Var <- c("T", "A", "I")
Coef_LeafN$VarCoef <- paste(Coef_LeafN$Var,Coef_LeafN$Coefficients, sep=" ")
Graph_Coef_LeafN <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_LeafN) + geom_bar(stat = 'identity') + 
  geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.7), colour = "white", fontface="bold", size=6) + 
  scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

Coef_SeedMass$Variables <- factor(Coef_SeedMass$Variables, levels=c("TemperatureScaled:AridityScaled", "AridityScaled", "TemperatureScaled"))
Coef_SeedMass$Coefficients <- round(Coef_SeedMass$Coefficients, digits=2)
Coef_SeedMass$Var <- c("T", "A", "I")
Coef_SeedMass$VarCoef <- paste(Coef_SeedMass$Var,Coef_SeedMass$Coefficients, sep=" ")
Graph_Coef_SeedMass <- ggplot(aes(y=Value, x=Trait, fill = Variables), data = Coef_SeedMass) + geom_bar(stat = 'identity') + 
  geom_text(aes(label =  VarCoef), position = position_stack(vjust = 0.7), colour = "white", fontface="bold", size=6) + 
  scale_fill_manual('Variables', values = c('#787878', '#ffa200', '#6200ff')) + coord_flip() + theme_void() + theme(legend.position = "none")

###

Layout = matrix(c(1,1,1,
                  1,1,1,
                  1,1,1,
                  1,1,1,
                  1,1,1,
                  2,2,2))

Graph_Height <- grid.arrange(BoxplotHeight, Graph_Coef_Height, layout_matrix=Layout)
Graph_CrownDiameter <- grid.arrange(BoxplotCrownDiameter, Graph_Coef_CrownDiameter, layout_matrix=Layout)
Graph_WoodDensity <- grid.arrange(BoxplotWoodDensity, Graph_Coef_WoodDensity, layout_matrix=Layout)
Graph_SLA <- grid.arrange(BoxplotSLA, Graph_Coef_SLA, layout_matrix=Layout)
Graph_LeafNP <- grid.arrange(BoxplotLeafNP, Graph_Coef_LeafNP, layout_matrix=Layout)
Graph_RootDepth <- grid.arrange(BoxplotRootDepth, Graph_Coef_RootDepth, layout_matrix=Layout)

grid.arrange(Graph_Height, Graph_CrownDiameter, Graph_WoodDensity, Graph_SLA, Graph_LeafNP, Graph_RootDepth, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

###SI
Graph_BarkThickness <- grid.arrange(BoxplotBarkThickness, Graph_Coef_BarkThickness, layout_matrix=Layout)
Graph_StemConduitDiameter <- grid.arrange(BoxplotStemConduitD, Graph_Coef_StemConduitDiameter, layout_matrix=Layout)
Graph_LeafN <- grid.arrange(BoxplotLeafN, Graph_Coef_LeafN, layout_matrix=Layout)
Graph_SeedMass <- grid.arrange(BoxplotSeedMass, Graph_Coef_SeedMass, layout_matrix=Layout)

grid.arrange(Graph_BarkThickness, Graph_StemConduitDiameter, Graph_LeafN, Graph_SeedMass, nrow=2, top=textGrob("Traits dominant and rare species", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

###Scatterplots
#Graphs scatterplot Environmental variables
paletteForUse <- c('#d10000', '#ff6622', '#ffda21', '#33dd00', '#1133cc', '#220066', '#330044')
colors <-  colorRampPalette(paletteForUse)(256)

# DifCWM_Envars$dens <- col2rgb(densCols(DifCWM_Envars$Temperature, DifCWM_Envars$SLA))[1,] + 1L
# DifCWM_Envars$colors = colors[DifCWM_Envars$dens]
# SLA_Temp <- ggplot(DifCWM_Envars, aes(Temperature, SLA)) +
#   geom_point(color= DifCWM_Envars$colors)+
#   geom_smooth(se = FALSE, level=0.95, size= 2, colour="#0a0a0a", method="lm", span = 0.9) + #method="lm", 
#   #annotate("text", label = "r = -0.11", x = 4.5, y = 3, size = 6, colour = "black") +
#   theme_classic()+ #xlim(20,200) + #ggtitle("Difference Dominant - Rare sp")+
#   geom_hline(yintercept=0, linetype="dashed", color = "grey", size=1) +
#   xlab("Temperature (C)") + ylab("Difference SLA")+
#   theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
#         axis.title.x = element_text(size = 16, face = "bold"),
#         axis.text.x = element_text(size = 14),
#         axis.title.y = element_text(size = 16, face = "bold"),
#         axis.text.y = element_text(size = 14),
#         legend.title = element_blank(),
#         legend.text = element_blank()) +
#   guides(size=FALSE)

# DifCWM_Envars$dens <- col2rgb(densCols(log(DifCWM_Envars$Precipitation_Seasonality), DifCWM_Envars$SeedMass))[1,] + 1L
# DifCWM_Envars$colors = colors[DifCWM_Envars$dens]
# SeedMass_PrecSeas <- ggplot(DifCWM_Envars, aes(log(Precipitation_Seasonality), SeedMass)) +
#   geom_point(color= DifCWM_Envars$colors)+
#   geom_smooth(se = FALSE, level=0.95, size= 2, colour="#0a0a0a", method="lm", span = 0.9) + #method="lm", 
#   #annotate("text", label = "r = -0.11", x = 4.5, y = 3, size = 6, colour = "black") +
#   theme_classic()+ #xlim(20,200) + #ggtitle("Difference Dominant - Rare sp")+
#   geom_hline(yintercept=0, linetype="dashed", color = "grey", size=1) +
#   xlab("Precipitation seasonality (mm/yr)") + ylab("Difference Seed mass")+
#   theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
#         axis.title.x = element_text(size = 16, face = "bold"),
#         axis.text.x = element_text(size = 14),
#         axis.title.y = element_text(size = 16, face = "bold"),
#         axis.text.y = element_text(size = 14),
#         legend.title = element_blank(),
#         legend.text = element_blank()) +
#   guides(size=FALSE)

###Aridity in detail
DifCWM_Envars$AridityFinal <- DifCWM_Envars$Aridity*0.0001
DifCWM_Envars$Biome <- as.numeric(DifCWM_Envars$Biome)
ggplot(DifCWM_Envars, aes(x=as.factor(Biome), y=AridityFinal, group=Biome)) + geom_boxplot() #+ ylim(c(0, 4)) 

Data <- DifCWM_Envars[which(DifCWM_Envars$AridityFinal <= 4),] #Define range aridity data
one.way <- aov(AridityFinal ~ as.factor(Biome), data = Data)
summary(one.way)

tukey.one.way<- TukeyHSD(x=one.way, conf.level=0.95)
tukey.one.way

AridityBiomes <- DifCWM_Envars %>% group_by(Biome) %>% summarise(mean=mean(AridityFinal))

###PET in detail
DifCWM_Envars$Biome <- as.numeric(DifCWM_Envars$Biome)
ggplot(DifCWM_Envars, aes(x=as.factor(Biome), y=PET, group=Biome)) + geom_boxplot() 

one.way <- aov(PET ~ as.factor(Biome), data = DifCWM_Envars)
summary(one.way)

tukey.one.way<- TukeyHSD(x=one.way, conf.level=0.95)
tukey.one.way

PETBiomes <- DifCWM_Envars %>% group_by(Biome) %>% summarise(mean=mean(PET))

###Precipitation in detail
DifCWM_Envars$Biome <- as.numeric(DifCWM_Envars$Biome)
ggplot(DifCWM_Envars, aes(x=as.factor(Biome), y=Precipitation, group=Biome)) + geom_boxplot() 

Data <- DifCWM_Envars[which(DifCWM_Envars$Precipitation <= 4000),] #Define range aridity data
one.way <- aov(Precipitation ~ as.factor(Biome), data = Data)
summary(one.way)

tukey.one.way<- TukeyHSD(x=one.way, conf.level=0.95)
tukey.one.way

PrecipitationBiomes <- DifCWM_Envars %>% group_by(Biome) %>% summarise(mean=mean(Precipitation))

###Temperature in detail
DifCWM_Envars$Biome <- as.numeric(DifCWM_Envars$Biome)
ggplot(DifCWM_Envars, aes(x=as.factor(Biome), y=Temperature, group=Biome)) + geom_boxplot() 

one.way <- aov(Temperature ~ as.factor(Biome), data = DifCWM_Envars)
summary(one.way)

tukey.one.way<- TukeyHSD(x=one.way, conf.level=0.95)
tukey.one.way

TemperatureBiomes <- DifCWM_Envars %>% group_by(Biome) %>% summarise(mean=mean(Temperature))

###Aridity graphs
DifCWM_Envars <- as.data.frame(DifCWM_Envars)
DifCWM_Envars <- DifCWM_Envars[which(DifCWM_Envars$AridityFinal <= 4),]


#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$Height, method="spearman") #all corrletaion p<0.001
summary(lm(Height  ~ Aridity, data=DifCWM_SelectAridity))

Height_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, Height)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.03", x = 3.5, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + xlab("Aridity Index") + ylab("Difference Height")+ 
  annotate("text", label = "Humid", x = 3.85, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0,ymax = predict(lm(Height  ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3,fill = "blue")+
  geom_segment(aes(x = 3.5, y = 0, xend = 3.5, yend = -Inf), linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$CrownDiameter, method="pearson") #all corrletaion p<0.001
CrownDiameter_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, CrownDiameter)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.12", x = 3.5, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + xlab("Aridity Index") + ylab("Difference Crown Diam.")+
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(CrownDiameter ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.6, y = 0, xend = 1.6, yend = -Inf), linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)


#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$WoodDensity, method="spearman")
WoodDensity_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, WoodDensity)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.13", x = 3.5, y = 0.8, size = 6, colour = "black") + theme_classic()+ 
  geom_hline(yintercept=0, color = "grey", size=1) + xlab("Aridity Index") + ylab("Difference Wood Density")+
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(WoodDensity ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$BarkThickness, method="pearson") #all corrletaion p<0.001
BarkThickness_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, BarkThickness)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.02", x = 3.5, y =0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(BarkThickness ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 3.4, y = 0, xend = 3.4, yend = -Inf), linetype="dashed") +
  xlab("Aridity Index") + ylab("Difference Bark thickness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$StemConduitDiameter, method="spearman")
StemConduitDiameter_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, StemConduitDiameter)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.20", x = 3.5, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(StemConduitDiameter ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), linetype="dashed") +
  xlab("Aridity Index") + ylab("Difference Stem Conduit Diam.")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$SLA, method="spearman") #all corrletaion p<0.001
SLA_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, SLA)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.10", x = 3.5, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SLA ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.55, y = 0, xend = 1.55, yend = -Inf), linetype="dashed") +
  xlab("Aridity Index") + ylab("Difference SLA")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$LeafN, method="spearman")
LeafN_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, LeafN)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.18", x = 3.5, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafN ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), linetype="dashed") +
  xlab("Aridity Index") + ylab("Difference Leaf N")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$LeafNP, method="spearman")
LeafNP_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, LeafNP)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.22", x = 3.5, y = 0.8, size = 6, colour = "black") +theme_classic()+ 
  geom_hline(yintercept=0, color = "grey", size=1) +
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafNP ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), linetype="dashed") +
  xlab("Aridity Index") + ylab("Difference Leaf NP")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$RootDepth, method="spearman")
#summary(lm(RootDepth~Aridity, data=DifCWM_SelectAridity)) #r2=0.02
RootDepth_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, RootDepth)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + xlim(c(0, 4)) + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.17", x = 3.5, y = 0.8, size = 6, colour = "black") + 
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(RootDepth ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.6, y = 0, xend = 1.6, yend = -Inf), linetype="dashed") +
  xlab("Aridity Index") + ylab("Difference Root Depth")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_SelectAridity$Aridity, DifCWM_SelectAridity$SeedMass, method="pearson") #all corrletaion p<0.001
SeedMass_Aridity <- ggplot(DifCWM_SelectAridity, aes(AridityFinal, SeedMass)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + xlim(0,4) + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = 0.07", x = 3.5, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  annotate("text", label = "Humid", x = 3.8, y = -1, size = 5, colour = "darkgrey") +
  annotate("text", label = "Arid", x = 0.4, y = -1, size = 5, colour = "darkgrey") +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SeedMass ~ AridityFinal, data=DifCWM_SelectAridity))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), linetype="dashed") +
  xlab("Aridity Index") + ylab("Difference SeedMass")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

# grid.arrange(Height_Aridity, CrownDiameter_Aridity, WoodDensity_Aridity, BarkThickness_Aridity, StemConduitDiameter_Aridity, SLA_Aridity, LeafN_Aridity, LeafNP_Aridity, RootDepth_Aridity, SeedMass_Aridity, nrow=3, top=textGrob("Trait differences correlated with climatic variables", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

###Temperature graphs
DifCWM_Envars$Temperature <- DifCWM_Envars$Temperature/10

#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$Height, method="spearman") #all corrletaion p<0.001
#summary(lm(Height  ~ Temperature, data=DifCWM_Envars))
Height_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, Height)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.06", x = 23, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) + #linetype="dashed", 
  xlab("Temperature") + ylab("Difference Height")+ 
  geom_ribbon(aes(ymin = 0,ymax = predict(lm(Height  ~ Temperature, data=DifCWM_Envars))), alpha = 0.3,fill = "blue")+
  #geom_segment(aes(x = 3.5, y = 0, xend = 3.5, yend = -Inf), linetype="dashed") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$CrownDiameter, method="pearson") #all corrletaion p<0.001
CrownDiameter_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, CrownDiameter)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.09", x = 23, y = 0.8, size = 6, colour = "black") +
  theme_classic() + geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(CrownDiameter ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 0.5, y = 0, xend = 0.5, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference Crown Diam.")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$WoodDensity, method="spearman")
WoodDensity_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, WoodDensity)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.22", x = 25, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(WoodDensity ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 6.5, y = 0, xend = 6.5, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference Wood Density")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$BarkThickness, method="pearson") #all corrletaion p<0.001
BarkThickness_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, BarkThickness)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.06", x = 23, y =0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(BarkThickness ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  #geom_segment(aes(x = 3.4, y = 0, xend = 3.4, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference Bark thickness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$StemConduitDiameter, method="spearman")
StemConduitDiameter_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, StemConduitDiameter)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.14", x = 23, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(StemConduitDiameter ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  #geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference Stem Conduit Diam.")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)
  
#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$SLA, method="spearman") #all corrletaion p<0.001
SLA_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, SLA)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.13", x = 23, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SLA ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 6, y = 0, xend = 6, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference SLA")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$LeafN, method="spearman")
LeafN_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, LeafN)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.15", x = 23, y = 0.8, size = 6, colour = "black") +
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafN ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 0.5, y = 0, xend = 0.5, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference Leaf N")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$LeafNP, method="spearman")
LeafNP_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, LeafNP)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.12", x = 25, y = 0.8, size = 6, colour = "black") +theme_classic()+ 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(LeafNP ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  #geom_segment(aes(x = 1.65, y = 0, xend = 1.65, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference Leaf NP")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$RootDepth, method="spearman")
#summary(lm(RootDepth~Temperature, data=DifCWM_Envars)) #r2=0.02
RootDepth_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, RootDepth)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.18", x = 25, y = 0.8, size = 6, colour = "black") + 
  theme_classic()+ geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(RootDepth ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.6, y = 0, xend = 1.6, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference Root Depth")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

#cor.test(DifCWM_Envars$Temperature, DifCWM_Envars$SeedMass, method="pearson") #all corrletaion p<0.001
SeedMass_Temperature <- ggplot(DifCWM_Envars, aes(Temperature, SeedMass)) + 
  geom_smooth(size= 2, colour="#0a0a0a", method="lm") + coord_cartesian(ylim=c(-1, 1)) +
  annotate("text", label = "r = -0.09", x = 23, y = 0.8, size = 6, colour = "black") + theme_classic() + 
  geom_hline(yintercept=0, color = "grey", size=1) +
  geom_ribbon(aes(ymin = 0, ymax = predict(lm(SeedMass ~ Temperature, data=DifCWM_Envars))), alpha = 0.3, fill = "blue")+
  geom_segment(aes(x = 1.7, y = 0, xend = 1.7, yend = -Inf), linetype="dashed") +
  xlab("Temperature") + ylab("Difference SeedMass")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

# grid.arrange(Height_Temperature, CrownDiameter_Temperature, WoodDensity_Temperature, BarkThickness_Temperature, StemConduitDiameter_Temperature, SLA_Temperature, LeafN_Temperature, LeafNP_Temperature, RootDepth_Temperature, SeedMass_Temperature, nrow=3, top=textGrob("Trait differences correlated with climatic variables", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

Fig3 <- grid.arrange(Height_Aridity, CrownDiameter_Aridity, SLA_Aridity, WoodDensity_Temperature, LeafNP_Temperature, RootDepth_Temperature, nrow=2, top=textGrob("Trait differences correlated with climatic variables", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))
  
FigS2A <- grid.arrange(WoodDensity_Aridity, BarkThickness_Aridity, StemConduitDiameter_Aridity, LeafN_Aridity, LeafNP_Aridity, RootDepth_Aridity, SeedMass_Aridity, nrow=2, top=textGrob("Trait differences correlated with climatic variables", gp=gpar(col="black", fontsize=25, fontface="bold")), padding = unit(3,"line"))

FigS2B <- grid.arrange(Height_Temperature, CrownDiameter_Temperature, BarkThickness_Temperature, StemConduitDiameter_Temperature, SLA_Temperature,  LeafN_Temperature,  SeedMass_Temperature, nrow=2)


```





###Sensitivity analysis: D/R % + forest age
```{r D/R % + forest age}
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity")
GFBI_SpeciesCheck <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_SpeciesCheck_7-2021.csv") #plots: 1184025

GFBI_SumS <- as.data.frame(GFBI_SpeciesCheck %>% group_by(plot_id) %>% mutate(SumS=as.numeric(n_distinct(species_name)))) #Sum of species per plot
GFBI_atleast2Sp <- GFBI_SumS[which(GFBI_SumS$SumS >= 6),] #Erase monocultures

###Select plots with distinct dominant and rare species 
GFBI_atleast2Sp$NrInd <- 1 #Add Nr of individuals
GFBI_Plot <- GFBI_atleast2Sp %>% group_by(Biome, plot_id) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                        PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>%
  slice(1) %>% as.data.frame()

rm(GFBI_SpeciesCheck, GFBI_SumS, GFBI_atleast2Sp, GFBI_Plot)

###Nr plots filtered out
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, plot_id) %>% filter(any(PercPerSpecies <= 10)) %>% ungroup()
length(unique(GFBI_MeanInd[,"plot_id"])) #548040
length(unique(GFBI_MeanIndFilter[,"plot_id"]))
NrPlots <- GFBI_MeanIndFilter %>% dplyr::select("plot_id") %>% n_distinct()

#5% Nr plots: 93018 this is 17% of plots
#10% Nr plots: 144256 this is 26% of plots
#15% Nr plots: 148047 this is 27% of plots

#Plots per biome
NrPlots <- GFBI_MeanIndFilter %>% group_by(Biome, plot_id) %>% slice(1) #5% Biome 4 filter, #15% Biome 4 filter (also for 10% only Biome 4)

#########################################################################D/R 5%
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, plot_id) %>% filter(any(PercPerSpecies <= 5)) #Filter out plots without rare species (all species contribute more than 10%) 

GFBI_MeanIndSum <- GFBI_MeanIndFilter %>% group_by(Biome, plot_id) %>% arrange(PercPerSpecies) %>% mutate(PercSpecies_cumsum = cumsum(PercPerSpecies)) %>% as.data.frame()

GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum <= 5, "rare", "intermediate")
GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum >= 95, "dominant", GFBI_MeanIndSum$DominanceCategory)                                                           
GFBI_DominanceCategory <- GFBI_MeanIndSum %>% group_by(Biome, plot_id) %>% filter(any(DominanceCategory == "dominant"))  

#Check <- GFBI_MeanIndSum %>% filter(plot_id == "p1184805")

###Select subset biomes 4
Select_Plots <- GFBI_DominanceCategory[which(GFBI_DominanceCategory$Biome== 4),]
Select_Plots_filter <- Select_Plots %>% group_by(Biome) %>% slice_sample(n=10000)
  
Select_Plots_all <- GFBI_DominanceCategory[which(GFBI_DominanceCategory$Biome < 4 | GFBI_DominanceCategory$Biome > 4),]
Select_PlotsFinal <- rbind(Select_Plots_all, Select_Plots_filter)
Select_PlotsFinal <- as.data.frame(Select_PlotsFinal)

fwrite(Select_PlotsFinal, file="SensAnalysDominantRare_5perc.csv")

###Match species with trait data
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))
rm(Traits)

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/SensAnalysDominantRare_5perc.csv")

DominantRare_Plot$genus <- word(DominantRare_Plot$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(DominantRare_Plot$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

DominantRare_Plot$GymnoAngiosperm <- family$sperms

Plot_SpTraits <- left_join(DominantRare_Plot, Traits_Select, by="obs_id")
rm(DominantRare_Plot, Traits_Select)

###Log transform and scale traits 
Plot_SpTraitsCompl <- Plot_SpTraits[complete.cases(Plot_SpTraits),] #Only PercPerSpecies has NA values

Plot_SpTraitsLog <- Plot_SpTraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% dplyr::summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))

Plot_TraitsScaled <- Plot_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values by Biome or globally group_by(Biome) %>% 

rm(Plot_SpTraits, Plot_SpTraitsCompl, Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

#########Add Temperature and Aridity
#Import and add GEE information
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CGIAR_Aridity_Index"), new=c("Temperature", "Humidity"))

Plot_TraitsEnv <- left_join(Plot_TraitsScaled, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

###Scaling of variables
Plot_TraitsEnv <- as.data.frame(Plot_TraitsEnv)
Plot_TraitsEnv$Temperature <- Plot_TraitsEnv$Temperature/10
Plot_TraitsEnv$Humidity <- Plot_TraitsEnv$Humidity*0.0001
Plot_TraitsEnv <- Plot_TraitsEnv[which(Plot_TraitsEnv$Humidity <= 4),] #69 plots removed
Plot_TraitsEnv <- Plot_TraitsEnv %>% dplyr::rename(Gymnosperm=GymnoAngiosperm)
Plot_TraitsEnv$Gymnosperm <- ifelse(Plot_TraitsEnv$Gymnosperm == "gymnosperm", 1, 0)
Plot_TraitsEnv <- Plot_TraitsEnv[complete.cases(Plot_TraitsEnv$Gymnosperm),]    

#########Create PCA
names(Plot_TraitsEnv)
Plot_TraitsDomRare <- Plot_TraitsEnv[which(Plot_TraitsEnv$DominanceCategory=="dominant" | Plot_TraitsEnv$DominanceCategory=="rare"),]
Plot_Traits_PCA <- Plot_TraitsDomRare %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Temperature, Humidity, Gymnosperm) 

setnames(Plot_Traits_PCA, old = c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass"), 
         new = c("Height", "Crown diameter", "Bark thickness", "Wood density", "SLA", "Leaf N", "Leaf NP", "Stem conduit diameter", "Root depth", "Seed mass"))

pca_Traits <- prcomp(Plot_Traits_PCA, scale. = TRUE)

barplot(pca_Traits$rotation[,1], main="PC 1 Loadings Plot", las=2) #PCA statistics
barplot(pca_Traits$rotation[,2], main="PC 2 Loadings Plot", las=2)

pca.df_Traits <- data.frame(pca1 = pca_Traits$x[,1], pca2 = pca_Traits$x[,2], DominanceCategory = Plot_TraitsDomRare$DominanceCategory, Biome=Plot_TraitsDomRare$Biome)
pca.df_Traits2 <- data.frame(pca1 = pca_Traits$rotation[,1], pca2 = pca_Traits$rotation[,2],  labels = row.names(pca_Traits$rotation)) #, sig = pca_Traits$sig, 

###Extract first and second axis PCA
Plot_TraitsDomRare$pca1 <- pca.df_Traits$pca1+4.231172 #min(pca.df_Traits$pca1)
Plot_TraitsDomRare$pca2 <- pca.df_Traits$pca2+4.927375 #min(pca.df_Traits$pca2)

Plot_TraitsDomRare5Perc <- Plot_TraitsDomRare
fwrite(Plot_TraitsDomRare5Perc, file="Data_TraitsDomRare5Perc.csv")

#########################################################################D/R 15%
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, plot_id) %>% filter(any(PercPerSpecies <= 15)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_MeanIndSum <- GFBI_MeanIndFilter %>% group_by(Biome, plot_id) %>% arrange(PercPerSpecies) %>% mutate(PercSpecies_cumsum = cumsum(PercPerSpecies)) %>% as.data.frame()

GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum <= 15, "rare", "intermediate")
GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum >= 85, "dominant", GFBI_MeanIndSum$DominanceCategory)                                                           
GFBI_DominanceCategory <- GFBI_MeanIndSum %>% group_by(Biome, plot_id) %>% filter(any(DominanceCategory == "dominant"))  

###Select subset biomes 4
Select_Plots <- GFBI_DominanceCategory[which(GFBI_DominanceCategory$Biome== 4),]
Select_Plots_filter <- Select_Plots %>% group_by(Biome) %>% slice_sample(n=10000)
  
Select_Plots_all <- GFBI_DominanceCategory[which(GFBI_DominanceCategory$Biome < 4 | GFBI_DominanceCategory$Biome > 4),]
Select_PlotsFinal <- rbind(Select_Plots_all, Select_Plots_filter)
Select_PlotsFinal <- as.data.frame(Select_PlotsFinal)

fwrite(Select_PlotsFinal, file="Select_PlotsFinal15Perc.csv")

###Match species with trait data
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))
rm(Traits)

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Select_PlotsFinal15Perc.csv")

DominantRare_Plot$genus <- word(DominantRare_Plot$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(DominantRare_Plot$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

DominantRare_Plot$GymnoAngiosperm <- family$sperms

Plot_SpTraits <- left_join(DominantRare_Plot, Traits_Select, by="obs_id")
rm(DominantRare_Plot, Traits_Select)

###Log transform and scale traits 
Plot_SpTraitsCompl <- Plot_SpTraits[complete.cases(Plot_SpTraits),] #Only PercPerSpecies has NA values

Plot_SpTraitsLog <- Plot_SpTraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% dplyr::summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))

Plot_TraitsScaled <- Plot_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values by Biome or globally group_by(Biome) %>% 

rm(Plot_SpTraits, Plot_SpTraitsCompl, Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

#########Add Temperature and Aridity
#Import and add GEE information
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CGIAR_Aridity_Index"), new=c("Temperature", "Humidity"))

Plot_TraitsEnv <- left_join(Plot_TraitsScaled, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

###Scaling of variables
Plot_TraitsEnv <- as.data.frame(Plot_TraitsEnv)
Plot_TraitsEnv$Temperature <- Plot_TraitsEnv$Temperature/10
Plot_TraitsEnv$Humidity <- Plot_TraitsEnv$Humidity*0.0001
Plot_TraitsEnv <- Plot_TraitsEnv[which(Plot_TraitsEnv$Humidity <= 4),] #69 plots removed
Plot_TraitsEnv <- Plot_TraitsEnv %>% dplyr::rename(Gymnosperm=GymnoAngiosperm)
Plot_TraitsEnv$Gymnosperm <- ifelse(Plot_TraitsEnv$Gymnosperm == "gymnosperm", 1, 0)
Plot_TraitsEnv <- Plot_TraitsEnv[complete.cases(Plot_TraitsEnv$Gymnosperm),]    

#########Create PCA
names(Plot_TraitsEnv)
Plot_TraitsDomRare <- Plot_TraitsEnv[which(Plot_TraitsEnv$DominanceCategory=="dominant" | Plot_TraitsEnv$DominanceCategory=="rare"),]
Plot_Traits_PCA <- Plot_TraitsDomRare %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Temperature, Humidity, Gymnosperm) 

setnames(Plot_Traits_PCA, old = c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass"), 
         new = c("Height", "Crown diameter", "Bark thickness", "Wood density", "SLA", "Leaf N", "Leaf NP", "Stem conduit diameter", "Root depth", "Seed mass"))

pca_Traits <- prcomp(Plot_Traits_PCA, scale. = TRUE)

barplot(pca_Traits$rotation[,1], main="PC 1 Loadings Plot", las=2) #PCA statistics
barplot(pca_Traits$rotation[,2], main="PC 2 Loadings Plot", las=2)

pca.df_Traits <- data.frame(pca1 = pca_Traits$x[,1], pca2 = pca_Traits$x[,2], DominanceCategory = Plot_TraitsDomRare$DominanceCategory, Biome=Plot_TraitsDomRare$Biome)
pca.df_Traits2 <- data.frame(pca1 = pca_Traits$rotation[,1], pca2 = pca_Traits$rotation[,2],  labels = row.names(pca_Traits$rotation)) #, sig = pca_Traits$sig, 

###Extract first and second axis PCA
Plot_TraitsDomRare$pca1 <- pca.df_Traits$pca1+4.280525 #min(pca.df_Traits$pca1)
Plot_TraitsDomRare$pca2 <- pca.df_Traits$pca2+4.801594 #min(pca.df_Traits$pca2)

Plot_TraitsDomRare15Perc <- Plot_TraitsDomRare
fwrite(Plot_TraitsDomRare15Perc, file="Data_TraitsDomRare15Perc.csv")

#########################################################################Filter forest age
###Match species with trait data
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))
rm(Traits)

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")

DominantRare_Plot$genus <- word(DominantRare_Plot$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(DominantRare_Plot$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

DominantRare_Plot$GymnoAngiosperm <- family$sperms

Plot_SpTraits <- left_join(DominantRare_Plot, Traits_Select, by="obs_id")
rm(DominantRare_Plot, Traits_Select)

###Log transform and scale traits 
Plot_SpTraitsCompl <- Plot_SpTraits[complete.cases(Plot_SpTraits),] #Only PercPerSpecies has NA values

Plot_SpTraitsLog <- Plot_SpTraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% dplyr::summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))

Plot_TraitsScaled <- Plot_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values by Biome or globally group_by(Biome) %>% 

rm(Plot_SpTraits, Plot_SpTraitsCompl, Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

#########Add Temperature and Aridity
#Import and add GEE information
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CGIAR_Aridity_Index", "GFAD_regrowthForestAge_Mean_downsampled50km"), new=c("Temperature", "Humidity", "ForestAge"))

Plot_TraitsEnv <- left_join(Plot_TraitsScaled, Env_vars, by="plot_id")
rm(GEE, PET, GEE_Select, PET_Select)

###Scaling of variables
Plot_TraitsEnv <- as.data.frame(Plot_TraitsEnv)
Plot_TraitsEnv$Temperature <- Plot_TraitsEnv$Temperature/10
Plot_TraitsEnv$Humidity <- Plot_TraitsEnv$Humidity*0.0001
Plot_TraitsEnv <- Plot_TraitsEnv[which(Plot_TraitsEnv$Humidity <= 4),] #69 plots removed
Plot_TraitsEnv <- Plot_TraitsEnv %>% dplyr::rename(Gymnosperm=GymnoAngiosperm)
Plot_TraitsEnv$Gymnosperm <- ifelse(Plot_TraitsEnv$Gymnosperm == "gymnosperm", 1, 0)
Plot_TraitsEnv <- Plot_TraitsEnv[complete.cases(Plot_TraitsEnv$Gymnosperm),]    

####################################################################### forest age > 30 years 
NrPlots <- Plot_TraitsEnv %>% dplyr::select("plot_id") %>% n_distinct() #23744

Plot_TraitsEnv30 <- Plot_TraitsEnv[which(Plot_TraitsEnv$ForestAge >= 30),] #forest age > 30 years = 83%
NrPlots <- Plot_TraitsEnv30 %>% dplyr::select("plot_id") %>% n_distinct()
19719/23744

#########Create PCA
names(Plot_TraitsEnv30)
Plot_TraitsDomRare <- Plot_TraitsEnv30[which(Plot_TraitsEnv30$DominanceCategory=="dominant" | Plot_TraitsEnv30$DominanceCategory=="rare"),]
Plot_Traits_PCA <- Plot_TraitsDomRare %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Temperature, Humidity, Gymnosperm) 

setnames(Plot_Traits_PCA, old = c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass"), 
         new = c("Height", "Crown diameter", "Bark thickness", "Wood density", "SLA", "Leaf N", "Leaf NP", "Stem conduit diameter", "Root depth", "Seed mass"))

pca_Traits <- prcomp(Plot_Traits_PCA, scale. = TRUE)

barplot(pca_Traits$rotation[,1], main="PC 1 Loadings Plot", las=2) #PCA statistics
barplot(pca_Traits$rotation[,2], main="PC 2 Loadings Plot", las=2)

pca.df_Traits <- data.frame(pca1 = pca_Traits$x[,1], pca2 = pca_Traits$x[,2], DominanceCategory = Plot_TraitsDomRare$DominanceCategory, Biome=Plot_TraitsDomRare$Biome)
pca.df_Traits2 <- data.frame(pca1 = pca_Traits$rotation[,1], pca2 = pca_Traits$rotation[,2],  labels = row.names(pca_Traits$rotation)) #, sig = pca_Traits$sig, 

###Extract first and second axis PCA
Plot_TraitsDomRare$pca1 <- pca.df_Traits$pca1+4.763878 #min(pca.df_Traits$pca1)
Plot_TraitsDomRare$pca2 <- pca.df_Traits$pca2+4.661499 #min(pca.df_Traits$pca2)

fwrite(Plot_TraitsDomRare, file="Data_TraitsDomRareForestAge30.csv")

####################################################################### forest age > 35 years
Plot_TraitsEnv35 <- Plot_TraitsEnv[which(Plot_TraitsEnv$ForestAge >= 35),] #forest age > 35 years 64%
NrPlots <- Plot_TraitsEnv35 %>% dplyr::select("plot_id") %>% n_distinct()
15243/23744

#########Create PCA
names(Plot_TraitsEnv35)
Plot_TraitsDomRare <- Plot_TraitsEnv35[which(Plot_TraitsEnv35$DominanceCategory=="dominant" | Plot_TraitsEnv35$DominanceCategory=="rare"),]
Plot_Traits_PCA <- Plot_TraitsDomRare %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Temperature, Humidity, Gymnosperm) 

setnames(Plot_Traits_PCA, old = c("Height", "CrownDiameter", "BarkThickness", "WoodDensity", "SLA", "LeafN", "LeafNP", "StemConduitDiameter", "RootDepth", "SeedMass"), 
         new = c("Height", "Crown diameter", "Bark thickness", "Wood density", "SLA", "Leaf N", "Leaf NP", "Stem conduit diameter", "Root depth", "Seed mass"))

pca_Traits <- prcomp(Plot_Traits_PCA, scale. = TRUE)

barplot(pca_Traits$rotation[,1], main="PC 1 Loadings Plot", las=2) #PCA statistics
barplot(pca_Traits$rotation[,2], main="PC 2 Loadings Plot", las=2)

pca.df_Traits <- data.frame(pca1 = pca_Traits$x[,1], pca2 = pca_Traits$x[,2], DominanceCategory = Plot_TraitsDomRare$DominanceCategory, Biome=Plot_TraitsDomRare$Biome)
pca.df_Traits2 <- data.frame(pca1 = pca_Traits$rotation[,1], pca2 = pca_Traits$rotation[,2],  labels = row.names(pca_Traits$rotation)) #, sig = pca_Traits$sig, 

###Extract first and second axis PCA
Plot_TraitsDomRare$pca1 <- pca.df_Traits$pca1+ abs(min(pca.df_Traits$pca1))
Plot_TraitsDomRare$pca2 <- pca.df_Traits$pca2+ abs(min(pca.df_Traits$pca2))

fwrite(Plot_TraitsDomRare, file="Data_TraitsDomRareForestAge35.csv")

##############################################################################################################################################FILTERING table
######################################################################D/R 5%
DomRare5Perc <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRare5Perc.csv") 
Plot_TraitsDomRare <- DomRare5Perc
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)
DiffDomRare_CWM_5perc <- DiffDomRare_CWM
DiffDomRare_CWM_5perc$Category <- "5 _perc"

TraitsDiffMean5perc <- as.data.frame(DiffDomRare_CWM %>% dplyr::group_by(Biome) %>% dplyr::summarise(n = n(), MeanHeight=mean(Height), SDHeight=sd(Height), MeanCrownDiameter=mean(CrownDiameter), SDCrownDiameter=sd(CrownDiameter), MeanBarkThickness=mean(BarkThickness), SDBarkThickness=sd(BarkThickness), MeanWoodDensity=mean(WoodDensity), SDWoodDensity=sd(WoodDensity), MeanSLA=mean(SLA), SDSLA=sd(SLA), MeanLeafN=mean(LeafN), SDLeafN=sd(LeafN), MeanLeafNP=mean(LeafNP), SDLeafNP=sd(LeafNP), MeanStemConduitD=mean(StemConduitDiameter), SDStemConduitD=sd(StemConduitDiameter), MeanRootDepth=mean(RootDepth), SDRootDepth=sd(RootDepth), MeanSeedMass=mean(SeedMass), SDSeedMass=sd(SeedMass), Meanpca1=mean(pca1), SDpca1=sd(pca1), Meanpca2=mean(pca2), SDpca2=sd(pca2)))

######################################################################D/R 15%
DomRare15Perc <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRare15Perc.csv") 
Plot_TraitsDomRare <- DomRare15Perc
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

DiffDomRare_CWM_15perc <- DiffDomRare_CWM
DiffDomRare_CWM_15perc$Category <- "15_perc"

TraitsDiffMean15perc <- as.data.frame(DiffDomRare_CWM %>% dplyr::group_by(Biome) %>% dplyr::summarise(n = n(), MeanHeight=mean(Height), SDHeight=sd(Height), MeanCrownDiameter=mean(CrownDiameter), SDCrownDiameter=sd(CrownDiameter), MeanBarkThickness=mean(BarkThickness), SDBarkThickness=sd(BarkThickness), MeanWoodDensity=mean(WoodDensity), SDWoodDensity=sd(WoodDensity), MeanSLA=mean(SLA), SDSLA=sd(SLA), MeanLeafN=mean(LeafN), SDLeafN=sd(LeafN), MeanLeafNP=mean(LeafNP), SDLeafNP=sd(LeafNP), MeanStemConduitD=mean(StemConduitDiameter), SDStemConduitD=sd(StemConduitDiameter), MeanRootDepth=mean(RootDepth), SDRootDepth=sd(RootDepth), MeanSeedMass=mean(SeedMass), SDSeedMass=sd(SeedMass), Meanpca1=mean(pca1), SDpca1=sd(pca1), Meanpca2=mean(pca2), SDpca2=sd(pca2)))

###Graph
DiffDomRare_CWM_10perc <- DiffDomRare_CWM
DiffDomRare_CWM_10perc$Category <- "10_perc"

Data_PercGraph <- rbind(DiffDomRare_CWM_5perc, DiffDomRare_CWM_10perc, DiffDomRare_CWM_15perc)

Height_PercGraph <- ggplot(Data_PercGraph, aes(x = Height, color = Category)) + geom_density() + ylab("Frequency") + xlab("Height D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
CrownDiameter_PercGraph <- ggplot(Data_PercGraph, aes(x = CrownDiameter, color = Category)) + geom_density() + ylab("Frequency") + xlab("Crown diameter D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
BarkThickness_PercGraph <- ggplot(Data_PercGraph, aes(x = BarkThickness, color = Category)) + geom_density() + ylab("Frequency") + xlab("Bark thickness D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
WoodDensity_PercGraph <- ggplot(Data_PercGraph, aes(x = WoodDensity, color = Category)) + geom_density() + ylab("Frequency") + xlab("Wood density D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
SLA_PercGraph <- ggplot(Data_PercGraph, aes(x = SLA, color = Category)) + geom_density() + ylab("Frequency") + xlab("SLA D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
LeafN_PercGraph <- ggplot(Data_PercGraph, aes(x = LeafN, color = Category)) + geom_density() + ylab("Frequency") + xlab("Leaf N D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
LeafNP_PercGraph <- ggplot(Data_PercGraph, aes(x = LeafNP, color = Category)) + geom_density() + ylab("Frequency") + xlab("Leaf NP D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
StemConduitDiameter_PercGraph <- ggplot(Data_PercGraph, aes(x = StemConduitDiameter, color = Category)) + geom_density() + ylab("Frequency") + xlab("Stem conduit diameter D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
RootDepth_PercGraph <- ggplot(Data_PercGraph, aes(x = RootDepth, color = Category)) + geom_density() + ylab("Frequency") + xlab("Root depth D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
SeedMass_PercGraph <- ggplot(Data_PercGraph, aes(x = SeedMass, color = Category)) + geom_density() + ylab("Frequency") + xlab("Seed mass D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="bottom")

grid.arrange(Height_PercGraph, WoodDensity_PercGraph, LeafN_PercGraph, SeedMass_PercGraph, RootDepth_PercGraph, CrownDiameter_PercGraph, BarkThickness_PercGraph, StemConduitDiameter_PercGraph, SLA_PercGraph, LeafNP_PercGraph, nrow=5)

######################################################################Forest Age 30 year
DomRareAge30 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRareForestAge30.csv") 
Plot_TraitsDomRare <- DomRareAge30
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

DiffDomRare_CWM_FA30 <- DiffDomRare_CWM
DiffDomRare_CWM_FA30$Category <- "FA_30"

TraitsDiffMeanAge30 <- as.data.frame(DiffDomRare_CWM %>% dplyr::group_by(Biome) %>% dplyr::summarise(n = n(), MeanHeight=mean(Height), SDHeight=sd(Height), MeanCrownDiameter=mean(CrownDiameter), SDCrownDiameter=sd(CrownDiameter), MeanBarkThickness=mean(BarkThickness), SDBarkThickness=sd(BarkThickness), MeanWoodDensity=mean(WoodDensity), SDWoodDensity=sd(WoodDensity), MeanSLA=mean(SLA), SDSLA=sd(SLA), MeanLeafN=mean(LeafN), SDLeafN=sd(LeafN), MeanLeafNP=mean(LeafNP), SDLeafNP=sd(LeafNP), MeanStemConduitD=mean(StemConduitDiameter), SDStemConduitD=sd(StemConduitDiameter), MeanRootDepth=mean(RootDepth), SDRootDepth=sd(RootDepth), MeanSeedMass=mean(SeedMass), SDSeedMass=sd(SeedMass), Meanpca1=mean(pca1), SDpca1=sd(pca1), Meanpca2=mean(pca2), SDpca2=sd(pca2)))

######################################################################Forest Age 35 year
DomRareAge35 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRareForestAge35.csv") 
Plot_TraitsDomRare <- DomRareAge35
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

DiffDomRare_CWM_FA35 <- DiffDomRare_CWM
DiffDomRare_CWM_FA35$Category <- "FA_35"

TraitsDiffMeanAge35 <- as.data.frame(DiffDomRare_CWM %>% dplyr::group_by(Biome) %>% dplyr::summarise(n = n(), MeanHeight=mean(Height), SDHeight=sd(Height), MeanCrownDiameter=mean(CrownDiameter), SDCrownDiameter=sd(CrownDiameter), MeanBarkThickness=mean(BarkThickness), SDBarkThickness=sd(BarkThickness), MeanWoodDensity=mean(WoodDensity), SDWoodDensity=sd(WoodDensity), MeanSLA=mean(SLA), SDSLA=sd(SLA), MeanLeafN=mean(LeafN), SDLeafN=sd(LeafN), MeanLeafNP=mean(LeafNP), SDLeafNP=sd(LeafNP), MeanStemConduitD=mean(StemConduitDiameter), SDStemConduitD=sd(StemConduitDiameter), MeanRootDepth=mean(RootDepth), SDRootDepth=sd(RootDepth), MeanSeedMass=mean(SeedMass), SDSeedMass=sd(SeedMass), Meanpca1=mean(pca1), SDpca1=sd(pca1), Meanpca2=mean(pca2), SDpca2=sd(pca2)))

TraitsDiffMean5perc$Category <- "DomRare5perc"
TraitsDiffMean15perc$Category <- "DomRare15perc"
TraitsDiffMeanAge30$Category <- "DomRare30ForestAge"
TraitsDiffMeanAge35$Category <- "DomRare35ForestAge"

TableSIFiltering <- rbind(TraitsDiffMean5perc, TraitsDiffMean15perc, TraitsDiffMeanAge30, TraitsDiffMeanAge35)
write.xlsx(TableSIFiltering, file = "SensitivityAnalysis_TableSI.xlsx")

###Graph
DiffDomRare_CWM_FA30 <- DiffDomRare_CWM_FA30 %>% dplyr::select(-pca1)

DiffDomRare_CWM_FA25 <- DiffDomRare_CWM_10perc
DiffDomRare_CWM_FA25$Category <- "FA25"

DiffDomRare_CWM_FA25 <- DiffDomRare_CWM_FA25 %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Biome, Category)
DiffDomRare_CWM_FA30<- DiffDomRare_CWM_FA30 %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Biome, Category)
DiffDomRare_CWM_FA35 <- DiffDomRare_CWM_FA35 %>% dplyr::select(Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass, Biome, Category)

Data_PercGraph <- rbind(DiffDomRare_CWM_FA25, DiffDomRare_CWM_FA30, DiffDomRare_CWM_FA35)

Height_PercGraph <- ggplot(Data_PercGraph, aes(x = Height, color = Category)) + geom_density() + ylab("Frequency") + xlab("Height D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
CrownDiameter_PercGraph <- ggplot(Data_PercGraph, aes(x = CrownDiameter, color = Category)) + geom_density() + ylab("Frequency") + xlab("Crown diameter D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
BarkThickness_PercGraph <- ggplot(Data_PercGraph, aes(x = BarkThickness, color = Category)) + geom_density() + ylab("Frequency") + xlab("Bark thickness D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
WoodDensity_PercGraph <- ggplot(Data_PercGraph, aes(x = WoodDensity, color = Category)) + geom_density() + ylab("Frequency") + xlab("Wood density D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
SLA_PercGraph <- ggplot(Data_PercGraph, aes(x = SLA, color = Category)) + geom_density() + ylab("Frequency") + xlab("SLA D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
LeafN_PercGraph <- ggplot(Data_PercGraph, aes(x = LeafN, color = Category)) + geom_density() + ylab("Frequency") + xlab("Leaf N D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
LeafNP_PercGraph <- ggplot(Data_PercGraph, aes(x = LeafNP, color = Category)) + geom_density() + ylab("Frequency") + xlab("Leaf NP D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
StemConduitDiameter_PercGraph <- ggplot(Data_PercGraph, aes(x = StemConduitDiameter, color = Category)) + geom_density() + ylab("Frequency") + xlab("Stem conduit diameter D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
RootDepth_PercGraph <- ggplot(Data_PercGraph, aes(x = RootDepth, color = Category)) + geom_density() + ylab("Frequency") + xlab("Root depth D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")
SeedMass_PercGraph <- ggplot(Data_PercGraph, aes(x = SeedMass, color = Category)) + geom_density() + ylab("Frequency") + xlab("Seed mass D-R") + theme_classic() + geom_vline(xintercept = 0) + theme(legend.position="none")

grid.arrange(Height_PercGraph, WoodDensity_PercGraph, LeafN_PercGraph, SeedMass_PercGraph, RootDepth_PercGraph, CrownDiameter_PercGraph, BarkThickness_PercGraph, StemConduitDiameter_PercGraph, SLA_PercGraph, LeafNP_PercGraph, nrow=5)

##############################################################################################################################################FILTERING models
######################################################################################################5perc
DomRare5Perc <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRare5Perc.csv") 
Plot_TraitsDomRare <- DomRare5Perc
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature, CHELSA_BIO_Annual_Precipitation, CHELSA_BIO_Precipitation_Seasonality, CHELSA_BIO_Temperature_Seasonality, EarthEnvTopoMed_Elevation, GFAD_FractionOfRegrowthForest_downsampled50km, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index, CGIAR_PET))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CHELSA_BIO_Annual_Precipitation", "CHELSA_BIO_Precipitation_Seasonality",  "CHELSA_BIO_Temperature_Seasonality", "EarthEnvTopoMed_Elevation", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "CGIAR_Aridity_Index", "CGIAR_PET"), new=c("Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "ForestAge", "Humidity", "PET"))

DifCWM_Envars <- left_join(DiffDomRare_CWM, Env_vars, by="plot_id")
DifCWM_Envars <- DifCWM_Envars %>% dplyr::select(-Temperature.x, -Humidity.x)
DifCWM_Envars <- DifCWM_Envars %>% dplyr::rename(Temperature = Temperature.y, Humidity = Humidity.y)
rm(GEE, PET, GEE_Select, PET_Select)

DifCWM_Envars$Temperature <- DifCWM_Envars$Temperature/10
DifCWM_Envars$Humidity <- DifCWM_Envars$Humidity*0.0001
DifCWM_Envars <- DifCWM_Envars[which(DifCWM_Envars$Humidity <= 4),] 

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRare5Perc.csv") 
Plotsize <- DominantRare_Plot %>% dplyr::select(Biome, plot_id, Plotsize)
DifCWM_Envars <- left_join(DifCWM_Envars, Plotsize, by=c("Biome", "plot_id")) #Add Plotsize

model_Height <- lm(Height ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_Height)
VarImp_Height <- calc.relimp(model_Height, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
VarImp_Height <- as.data.frame(VarImp_Height@lmg)
VarImp_Height_Final <- VarImp_Height %>% rename(VarImp=`VarImp_Height@lmg`)
VarImp_Height_Final <- cbind(VarImp_Height_Final, summary(model_Height)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_Height_Final$Variable <- "Height"

# model_CrownDiameter <- lm(CrownDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_CrownDiameter)
# VarImp_CrownDiameter <- calc.relimp(model_CrownDiameter, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
# VarImp_CrownDiameter <- as.data.frame(VarImp_CrownDiameter@lmg)
# VarImp_CrownDiameter_Final <- VarImp_CrownDiameter %>% rename(VarImp=`VarImp_CrownDiameter@lmg`)
# VarImp_CrownDiameter_Final <- cbind(VarImp_CrownDiameter_Final, summary(model_CrownDiameter)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_CrownDiameter_Final$Variable <- "CrownDiameter"
# 
# model_BarkThickness <- lm(BarkThickness ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_BarkThickness)
# VarImp_BarkThickness <- calc.relimp(model_BarkThickness, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
# VarImp_BarkThickness <- as.data.frame(VarImp_BarkThickness@lmg)
# VarImp_BarkThickness_Final <- VarImp_BarkThickness %>% rename(VarImp=`VarImp_BarkThickness@lmg`)
# VarImp_BarkThickness_Final <- cbind(VarImp_BarkThickness_Final, summary(model_BarkThickness)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_BarkThickness_Final$Variable <- "BarkThickness"

model_WoodDensity <- lm(WoodDensity ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_WoodDensity)
VarImp_WoodDensity <- calc.relimp(model_WoodDensity, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
VarImp_WoodDensity <- as.data.frame(VarImp_WoodDensity@lmg)
VarImp_WoodDensity_Final <- VarImp_WoodDensity %>% rename(VarImp=`VarImp_WoodDensity@lmg`)
VarImp_WoodDensity_Final <- cbind(VarImp_WoodDensity_Final, summary(model_WoodDensity)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_WoodDensity_Final$Variable <- "WoodDensity"

# model_SLA <- lm(SLA ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_SLA)
# VarImp_SLA <- calc.relimp(model_SLA, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity: contributing >5%
# VarImp_SLA <- as.data.frame(VarImp_SLA@lmg)
# VarImp_SLA_Final <- VarImp_SLA %>% rename(VarImp=`VarImp_SLA@lmg`)
# VarImp_SLA_Final <- cbind(VarImp_SLA_Final, summary(model_SLA)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_SLA_Final$Variable <- "SLA"

model_LeafN <- lm(LeafN ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_LeafN)
VarImp_LeafN <- calc.relimp(model_LeafN, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_LeafN <- as.data.frame(VarImp_LeafN@lmg)
VarImp_LeafN_Final <- VarImp_LeafN %>% rename(VarImp=`VarImp_LeafN@lmg`)
VarImp_LeafN_Final <- cbind(VarImp_LeafN_Final, summary(model_LeafN)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_LeafN_Final$Variable <- "LeafN"

# model_LeafNP <- lm(LeafNP ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_LeafNP)
# VarImp_LeafNP <- calc.relimp(model_LeafNP, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_LeafNP <- as.data.frame(VarImp_LeafNP@lmg)
# VarImp_LeafNP_Final <- VarImp_LeafNP %>% rename(VarImp=`VarImp_LeafNP@lmg`)
# VarImp_LeafNP_Final <- cbind(VarImp_LeafNP_Final, summary(model_LeafNP)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_LeafNP_Final$Variable <- "LeafNP"
# 
# model_StemConduitDiam <- lm(StemConduitDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_StemConduitDiam)
# VarImp_StemConduitDiam <- calc.relimp(model_StemConduitDiam, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_StemConduitDiam <- as.data.frame(VarImp_StemConduitDiam@lmg)
# VarImp_StemConduitDiam_Final <- VarImp_StemConduitDiam %>% rename(VarImp=`VarImp_StemConduitDiam@lmg`)
# VarImp_StemConduitDiam_Final <- cbind(VarImp_StemConduitDiam_Final, summary(model_StemConduitDiam)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_StemConduitDiam_Final$Variable <- "StemConduitDiam"

model_RootDepth <- lm(RootDepth ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_RootDepth)
VarImp_RootDepth <- calc.relimp(model_RootDepth, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_RootDepth <- as.data.frame(VarImp_RootDepth@lmg)
VarImp_RootDepth_Final <- VarImp_RootDepth %>% rename(VarImp=`VarImp_RootDepth@lmg`)
VarImp_RootDepth_Final <- cbind(VarImp_RootDepth_Final, summary(model_RootDepth)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_RootDepth_Final$Variable <- "RootDepth"

model_SeedMass <- lm(SeedMass ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_SeedMass)
VarImp_SeedMass <- calc.relimp(model_SeedMass, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_SeedMass <- as.data.frame(VarImp_SeedMass@lmg)
VarImp_SeedMass_Final <- VarImp_SeedMass %>% rename(VarImp=`VarImp_SeedMass@lmg`)
VarImp_SeedMass_Final <- cbind(VarImp_SeedMass_Final, summary(model_SeedMass)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_SeedMass_Final$Variable <- "SeedMass"

model_pca1 <- lm(pca1 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_pca1)
VarImp_pca1 <- calc.relimp(model_pca1, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_pca1 <- as.data.frame(VarImp_pca1@lmg)
VarImp_pca1_Final <- VarImp_pca1 %>% rename(VarImp=`VarImp_pca1@lmg`)
VarImp_pca1_Final <- cbind(VarImp_pca1_Final, summary(model_pca1)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_pca1_Final$Variable <- "pca1"

# model_pca2 <- lm(pca2 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_pca2)
# VarImp_pca2 <- calc.relimp(model_pca2, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_pca2 <- as.data.frame(VarImp_pca2@lmg)
# VarImp_pca2_Final <- VarImp_pca2 %>% rename(VarImp=`VarImp_pca2@lmg`)
# VarImp_pca2_Final <- cbind(VarImp_pca2_Final, summary(model_pca2)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_pca2_Final$Variable <- "pca2"

Final_modelsPerc5 <- rbind(VarImp_Height_Final, VarImp_WoodDensity_Final, VarImp_LeafN_Final, VarImp_RootDepth_Final, VarImp_SeedMass_Final, VarImp_pca1_Final) #VarImp_CrownDiameter_Final, VarImp_BarkThickness_Final, VarImp_SLA_Final, VarImp_LeafNP_Final, VarImp_StemConduitDiam_Final, VarImp_Gymnosperm_Final, VarImp_pca2_Final

Final_modelsPerc5 <- tibble::rownames_to_column(Final_modelsPerc5, "Term")
Final_modelsPerc5$Category <- "Perc5"

######################################################################################################15perc
DomRare15Perc <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRare15Perc.csv") 
Plot_TraitsDomRare <- DomRare15Perc
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature, CHELSA_BIO_Annual_Precipitation, CHELSA_BIO_Precipitation_Seasonality, CHELSA_BIO_Temperature_Seasonality, EarthEnvTopoMed_Elevation, GFAD_FractionOfRegrowthForest_downsampled50km, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index, CGIAR_PET))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CHELSA_BIO_Annual_Precipitation", "CHELSA_BIO_Precipitation_Seasonality",  "CHELSA_BIO_Temperature_Seasonality", "EarthEnvTopoMed_Elevation", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "CGIAR_Aridity_Index", "CGIAR_PET"), new=c("Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "ForestAge", "Humidity", "PET"))

DifCWM_Envars <- left_join(DiffDomRare_CWM, Env_vars, by="plot_id")
DifCWM_Envars <- DifCWM_Envars %>% dplyr::select(-Temperature.x, -Humidity.x)
DifCWM_Envars <- DifCWM_Envars %>% dplyr::rename(Temperature = Temperature.y, Humidity = Humidity.y)
rm(GEE, PET, GEE_Select, PET_Select)

DifCWM_Envars$Temperature <- DifCWM_Envars$Temperature/10
DifCWM_Envars$Humidity <- DifCWM_Envars$Humidity*0.0001
DifCWM_Envars <- DifCWM_Envars[which(DifCWM_Envars$Humidity <= 4),] 

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRare15Perc.csv") 
Plotsize <- DominantRare_Plot %>% dplyr::select(Biome, plot_id, Plotsize)
DifCWM_Envars <- left_join(DifCWM_Envars, Plotsize, by=c("Biome", "plot_id")) #Add Plotsize

model_Height <- lm(Height ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_Height)
VarImp_Height <- calc.relimp(model_Height, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
VarImp_Height <- as.data.frame(VarImp_Height@lmg)
VarImp_Height_Final <- VarImp_Height %>% rename(VarImp=`VarImp_Height@lmg`)
VarImp_Height_Final <- cbind(VarImp_Height_Final, summary(model_Height)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_Height_Final$Variable <- "Height"

# model_CrownDiameter <- lm(CrownDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_CrownDiameter)
# VarImp_CrownDiameter <- calc.relimp(model_CrownDiameter, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
# VarImp_CrownDiameter <- as.data.frame(VarImp_CrownDiameter@lmg)
# VarImp_CrownDiameter_Final <- VarImp_CrownDiameter %>% rename(VarImp=`VarImp_CrownDiameter@lmg`)
# VarImp_CrownDiameter_Final <- cbind(VarImp_CrownDiameter_Final, summary(model_CrownDiameter)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_CrownDiameter_Final$Variable <- "CrownDiameter"
# 
# model_BarkThickness <- lm(BarkThickness ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_BarkThickness)
# VarImp_BarkThickness <- calc.relimp(model_BarkThickness, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
# VarImp_BarkThickness <- as.data.frame(VarImp_BarkThickness@lmg)
# VarImp_BarkThickness_Final <- VarImp_BarkThickness %>% rename(VarImp=`VarImp_BarkThickness@lmg`)
# VarImp_BarkThickness_Final <- cbind(VarImp_BarkThickness_Final, summary(model_BarkThickness)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_BarkThickness_Final$Variable <- "BarkThickness"

model_WoodDensity <- lm(WoodDensity ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_WoodDensity)
VarImp_WoodDensity <- calc.relimp(model_WoodDensity, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
VarImp_WoodDensity <- as.data.frame(VarImp_WoodDensity@lmg)
VarImp_WoodDensity_Final <- VarImp_WoodDensity %>% rename(VarImp=`VarImp_WoodDensity@lmg`)
VarImp_WoodDensity_Final <- cbind(VarImp_WoodDensity_Final, summary(model_WoodDensity)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_WoodDensity_Final$Variable <- "WoodDensity"

# model_SLA <- lm(SLA ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_SLA)
# VarImp_SLA <- calc.relimp(model_SLA, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity: contributing >5%
# VarImp_SLA <- as.data.frame(VarImp_SLA@lmg)
# VarImp_SLA_Final <- VarImp_SLA %>% rename(VarImp=`VarImp_SLA@lmg`)
# VarImp_SLA_Final <- cbind(VarImp_SLA_Final, summary(model_SLA)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_SLA_Final$Variable <- "SLA"

model_LeafN <- lm(LeafN ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_LeafN)
VarImp_LeafN <- calc.relimp(model_LeafN, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_LeafN <- as.data.frame(VarImp_LeafN@lmg)
VarImp_LeafN_Final <- VarImp_LeafN %>% rename(VarImp=`VarImp_LeafN@lmg`)
VarImp_LeafN_Final <- cbind(VarImp_LeafN_Final, summary(model_LeafN)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_LeafN_Final$Variable <- "LeafN"

# model_LeafNP <- lm(LeafNP ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_LeafNP)
# VarImp_LeafNP <- calc.relimp(model_LeafNP, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_LeafNP <- as.data.frame(VarImp_LeafNP@lmg)
# VarImp_LeafNP_Final <- VarImp_LeafNP %>% rename(VarImp=`VarImp_LeafNP@lmg`)
# VarImp_LeafNP_Final <- cbind(VarImp_LeafNP_Final, summary(model_LeafNP)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_LeafNP_Final$Variable <- "LeafNP"
# 
# model_StemConduitDiam <- lm(StemConduitDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_StemConduitDiam)
# VarImp_StemConduitDiam <- calc.relimp(model_StemConduitDiam, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_StemConduitDiam <- as.data.frame(VarImp_StemConduitDiam@lmg)
# VarImp_StemConduitDiam_Final <- VarImp_StemConduitDiam %>% rename(VarImp=`VarImp_StemConduitDiam@lmg`)
# VarImp_StemConduitDiam_Final <- cbind(VarImp_StemConduitDiam_Final, summary(model_StemConduitDiam)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_StemConduitDiam_Final$Variable <- "StemConduitDiam"

model_RootDepth <- lm(RootDepth ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_RootDepth)
VarImp_RootDepth <- calc.relimp(model_RootDepth, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_RootDepth <- as.data.frame(VarImp_RootDepth@lmg)
VarImp_RootDepth_Final <- VarImp_RootDepth %>% rename(VarImp=`VarImp_RootDepth@lmg`)
VarImp_RootDepth_Final <- cbind(VarImp_RootDepth_Final, summary(model_RootDepth)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_RootDepth_Final$Variable <- "RootDepth"

model_SeedMass <- lm(SeedMass ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_SeedMass)
VarImp_SeedMass <- calc.relimp(model_SeedMass, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_SeedMass <- as.data.frame(VarImp_SeedMass@lmg)
VarImp_SeedMass_Final <- VarImp_SeedMass %>% rename(VarImp=`VarImp_SeedMass@lmg`)
VarImp_SeedMass_Final <- cbind(VarImp_SeedMass_Final, summary(model_SeedMass)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_SeedMass_Final$Variable <- "SeedMass"

model_pca1 <- lm(pca1 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_pca1)
VarImp_pca1 <- calc.relimp(model_pca1, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_pca1 <- as.data.frame(VarImp_pca1@lmg)
VarImp_pca1_Final <- VarImp_pca1 %>% rename(VarImp=`VarImp_pca1@lmg`)
VarImp_pca1_Final <- cbind(VarImp_pca1_Final, summary(model_pca1)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_pca1_Final$Variable <- "pca1"

# model_pca2 <- lm(pca2 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_pca2)
# VarImp_pca2 <- calc.relimp(model_pca2, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_pca2 <- as.data.frame(VarImp_pca2@lmg)
# VarImp_pca2_Final <- VarImp_pca2 %>% rename(VarImp=`VarImp_pca2@lmg`)
# VarImp_pca2_Final <- cbind(VarImp_pca2_Final, summary(model_pca2)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_pca2_Final$Variable <- "pca2"

Final_modelsPerc15 <- rbind(VarImp_Height_Final, VarImp_WoodDensity_Final, VarImp_LeafN_Final, VarImp_RootDepth_Final, VarImp_SeedMass_Final, VarImp_pca1_Final) #VarImp_CrownDiameter_Final, VarImp_BarkThickness_Final, VarImp_SLA_Final, VarImp_LeafNP_Final, VarImp_StemConduitDiam_Final, VarImp_Gymnosperm_Final, VarImp_pca2_Final

Final_modelsPerc15 <- tibble::rownames_to_column(Final_modelsPerc15, "Term")
Final_modelsPerc15$Category <- "Perc15"

######################################################################################################ForestAge 30
DomRareAge30 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRareForestAge30.csv") 
Plot_TraitsDomRare <- DomRareAge30
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature, CHELSA_BIO_Annual_Precipitation, CHELSA_BIO_Precipitation_Seasonality, CHELSA_BIO_Temperature_Seasonality, EarthEnvTopoMed_Elevation, GFAD_FractionOfRegrowthForest_downsampled50km, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index, CGIAR_PET))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CHELSA_BIO_Annual_Precipitation", "CHELSA_BIO_Precipitation_Seasonality",  "CHELSA_BIO_Temperature_Seasonality", "EarthEnvTopoMed_Elevation", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "CGIAR_Aridity_Index", "CGIAR_PET"), new=c("Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "ForestAge", "Humidity", "PET"))

DifCWM_Envars <- left_join(DiffDomRare_CWM, Env_vars, by="plot_id")
DifCWM_Envars <- DifCWM_Envars %>% dplyr::select(-Temperature.x, -Humidity.x)
DifCWM_Envars <- DifCWM_Envars %>% dplyr::rename(Temperature = Temperature.y, Humidity = Humidity.y)
rm(GEE, PET, GEE_Select, PET_Select)

DifCWM_Envars$Temperature <- DifCWM_Envars$Temperature/10
DifCWM_Envars$Humidity <- DifCWM_Envars$Humidity*0.0001
DifCWM_Envars <- DifCWM_Envars[which(DifCWM_Envars$Humidity <= 4),] 

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRareForestAge30.csv") 
Plotsize <- DominantRare_Plot %>% dplyr::select(Biome, plot_id, Plotsize)
DifCWM_Envars <- left_join(DifCWM_Envars, Plotsize, by=c("Biome", "plot_id")) #Add Plotsize
DifCWM_Envars$ForestAge <- DifCWM_Envars$ForestAge.y

model_Height <- lm(Height ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_Height)
VarImp_Height <- calc.relimp(model_Height, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
VarImp_Height <- as.data.frame(VarImp_Height@lmg)
VarImp_Height_Final <- VarImp_Height %>% rename(VarImp=`VarImp_Height@lmg`)
VarImp_Height_Final <- cbind(VarImp_Height_Final, summary(model_Height)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_Height_Final$Variable <- "Height"

# model_CrownDiameter <- lm(CrownDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_CrownDiameter)
# VarImp_CrownDiameter <- calc.relimp(model_CrownDiameter, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
# VarImp_CrownDiameter <- as.data.frame(VarImp_CrownDiameter@lmg)
# VarImp_CrownDiameter_Final <- VarImp_CrownDiameter %>% rename(VarImp=`VarImp_CrownDiameter@lmg`)
# VarImp_CrownDiameter_Final <- cbind(VarImp_CrownDiameter_Final, summary(model_CrownDiameter)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_CrownDiameter_Final$Variable <- "CrownDiameter"
# 
# model_BarkThickness <- lm(BarkThickness ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_BarkThickness)
# VarImp_BarkThickness <- calc.relimp(model_BarkThickness, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
# VarImp_BarkThickness <- as.data.frame(VarImp_BarkThickness@lmg)
# VarImp_BarkThickness_Final <- VarImp_BarkThickness %>% rename(VarImp=`VarImp_BarkThickness@lmg`)
# VarImp_BarkThickness_Final <- cbind(VarImp_BarkThickness_Final, summary(model_BarkThickness)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_BarkThickness_Final$Variable <- "BarkThickness"

model_WoodDensity <- lm(WoodDensity ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_WoodDensity)
VarImp_WoodDensity <- calc.relimp(model_WoodDensity, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
VarImp_WoodDensity <- as.data.frame(VarImp_WoodDensity@lmg)
VarImp_WoodDensity_Final <- VarImp_WoodDensity %>% rename(VarImp=`VarImp_WoodDensity@lmg`)
VarImp_WoodDensity_Final <- cbind(VarImp_WoodDensity_Final, summary(model_WoodDensity)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_WoodDensity_Final$Variable <- "WoodDensity"

# model_SLA <- lm(SLA ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_SLA)
# VarImp_SLA <- calc.relimp(model_SLA, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity: contributing >5%
# VarImp_SLA <- as.data.frame(VarImp_SLA@lmg)
# VarImp_SLA_Final <- VarImp_SLA %>% rename(VarImp=`VarImp_SLA@lmg`)
# VarImp_SLA_Final <- cbind(VarImp_SLA_Final, summary(model_SLA)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_SLA_Final$Variable <- "SLA"

model_LeafN <- lm(LeafN ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_LeafN)
VarImp_LeafN <- calc.relimp(model_LeafN, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_LeafN <- as.data.frame(VarImp_LeafN@lmg)
VarImp_LeafN_Final <- VarImp_LeafN %>% rename(VarImp=`VarImp_LeafN@lmg`)
VarImp_LeafN_Final <- cbind(VarImp_LeafN_Final, summary(model_LeafN)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_LeafN_Final$Variable <- "LeafN"

# model_LeafNP <- lm(LeafNP ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_LeafNP)
# VarImp_LeafNP <- calc.relimp(model_LeafNP, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_LeafNP <- as.data.frame(VarImp_LeafNP@lmg)
# VarImp_LeafNP_Final <- VarImp_LeafNP %>% rename(VarImp=`VarImp_LeafNP@lmg`)
# VarImp_LeafNP_Final <- cbind(VarImp_LeafNP_Final, summary(model_LeafNP)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_LeafNP_Final$Variable <- "LeafNP"
# 
# model_StemConduitDiam <- lm(StemConduitDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_StemConduitDiam)
# VarImp_StemConduitDiam <- calc.relimp(model_StemConduitDiam, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_StemConduitDiam <- as.data.frame(VarImp_StemConduitDiam@lmg)
# VarImp_StemConduitDiam_Final <- VarImp_StemConduitDiam %>% rename(VarImp=`VarImp_StemConduitDiam@lmg`)
# VarImp_StemConduitDiam_Final <- cbind(VarImp_StemConduitDiam_Final, summary(model_StemConduitDiam)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_StemConduitDiam_Final$Variable <- "StemConduitDiam"

model_RootDepth <- lm(RootDepth ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_RootDepth)
VarImp_RootDepth <- calc.relimp(model_RootDepth, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_RootDepth <- as.data.frame(VarImp_RootDepth@lmg)
VarImp_RootDepth_Final <- VarImp_RootDepth %>% rename(VarImp=`VarImp_RootDepth@lmg`)
VarImp_RootDepth_Final <- cbind(VarImp_RootDepth_Final, summary(model_RootDepth)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_RootDepth_Final$Variable <- "RootDepth"

model_SeedMass <- lm(SeedMass ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_SeedMass)
VarImp_SeedMass <- calc.relimp(model_SeedMass, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_SeedMass <- as.data.frame(VarImp_SeedMass@lmg)
VarImp_SeedMass_Final <- VarImp_SeedMass %>% rename(VarImp=`VarImp_SeedMass@lmg`)
VarImp_SeedMass_Final <- cbind(VarImp_SeedMass_Final, summary(model_SeedMass)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_SeedMass_Final$Variable <- "SeedMass"

model_pca1 <- lm(pca1 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_pca1)
VarImp_pca1 <- calc.relimp(model_pca1, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_pca1 <- as.data.frame(VarImp_pca1@lmg)
VarImp_pca1_Final <- VarImp_pca1 %>% rename(VarImp=`VarImp_pca1@lmg`)
VarImp_pca1_Final <- cbind(VarImp_pca1_Final, summary(model_pca1)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_pca1_Final$Variable <- "pca1"

# model_pca2 <- lm(pca2 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_pca2)
# VarImp_pca2 <- calc.relimp(model_pca2, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_pca2 <- as.data.frame(VarImp_pca2@lmg)
# VarImp_pca2_Final <- VarImp_pca2 %>% rename(VarImp=`VarImp_pca2@lmg`)
# VarImp_pca2_Final <- cbind(VarImp_pca2_Final, summary(model_pca2)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_pca2_Final$Variable <- "pca2"

Final_modelsForestAge30 <- rbind(VarImp_Height_Final, VarImp_WoodDensity_Final, VarImp_LeafN_Final, VarImp_RootDepth_Final, VarImp_SeedMass_Final, VarImp_pca1_Final) #VarImp_CrownDiameter_Final, VarImp_BarkThickness_Final, VarImp_SLA_Final, VarImp_LeafNP_Final, VarImp_StemConduitDiam_Final, VarImp_Gymnosperm_Final, VarImp_pca2_Final

Final_modelsForestAge30 <- tibble::rownames_to_column(Final_modelsForestAge30, "Term")
Final_modelsForestAge30$Category <- "ForestAge30"

######################################################################################################ForestAge 35
DomRareAge35 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRareForestAge35.csv") 
Plot_TraitsDomRare <- DomRareAge35
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:pca2), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021")
GEE <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/Traits03-05-2021") %>% map_df(~fread(.))) #run at once with previous line
GEE_Select <- subset(GEE, select=c(plot_id, CHELSA_BIO_Annual_Mean_Temperature, CHELSA_BIO_Annual_Precipitation, CHELSA_BIO_Precipitation_Seasonality, CHELSA_BIO_Temperature_Seasonality, EarthEnvTopoMed_Elevation, GFAD_FractionOfRegrowthForest_downsampled50km, GFAD_regrowthForestAge_Mean_downsampled50km))

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021")
PET <- as.data.frame(list.files("~/Documents/PhD projects/2nd Chapter - Trait diversity/TraitsPET_07-2021") %>% map_df(~fread(.))) #run at once with previous line
PET_Select <- subset(PET, select=c(plot_id, CGIAR_Aridity_Index, CGIAR_PET))

Env_vars <- merge(GEE_Select, PET_Select, by="plot_id")
setnames(Env_vars, old=c("CHELSA_BIO_Annual_Mean_Temperature", "CHELSA_BIO_Annual_Precipitation", "CHELSA_BIO_Precipitation_Seasonality",  "CHELSA_BIO_Temperature_Seasonality", "EarthEnvTopoMed_Elevation", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "CGIAR_Aridity_Index", "CGIAR_PET"), new=c("Temperature", "Precipitation", "Precipitation_Seasonality", "Temperature_Seasonality", "Elevation", "Secondary_Forest", "ForestAge", "Humidity", "PET"))

DifCWM_Envars <- left_join(DiffDomRare_CWM, Env_vars, by="plot_id")
DifCWM_Envars <- DifCWM_Envars %>% dplyr::select(-Temperature.x, -Humidity.x)
DifCWM_Envars <- DifCWM_Envars %>% dplyr::rename(Temperature = Temperature.y, Humidity = Humidity.y)
rm(GEE, PET, GEE_Select, PET_Select)

DifCWM_Envars$Temperature <- DifCWM_Envars$Temperature/10
DifCWM_Envars$Humidity <- DifCWM_Envars$Humidity*0.0001
DifCWM_Envars <- DifCWM_Envars[which(DifCWM_Envars$Humidity <= 4),] 

DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/Data_TraitsDomRareForestAge35.csv") 
Plotsize <- DominantRare_Plot %>% dplyr::select(Biome, plot_id, Plotsize)
DifCWM_Envars <- left_join(DifCWM_Envars, Plotsize, by=c("Biome", "plot_id")) #Add Plotsize
DifCWM_Envars$ForestAge <- DifCWM_Envars$ForestAge.y

model_Height <- lm(Height ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_Height)
VarImp_Height <- calc.relimp(model_Height, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
VarImp_Height <- as.data.frame(VarImp_Height@lmg)
VarImp_Height_Final <- VarImp_Height %>% rename(VarImp=`VarImp_Height@lmg`)
VarImp_Height_Final <- cbind(VarImp_Height_Final, summary(model_Height)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_Height_Final$Variable <- "Height"

# model_CrownDiameter <- lm(CrownDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_CrownDiameter)
# VarImp_CrownDiameter <- calc.relimp(model_CrownDiameter, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
# VarImp_CrownDiameter <- as.data.frame(VarImp_CrownDiameter@lmg)
# VarImp_CrownDiameter_Final <- VarImp_CrownDiameter %>% rename(VarImp=`VarImp_CrownDiameter@lmg`)
# VarImp_CrownDiameter_Final <- cbind(VarImp_CrownDiameter_Final, summary(model_CrownDiameter)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_CrownDiameter_Final$Variable <- "CrownDiameter"
# 
# model_BarkThickness <- lm(BarkThickness ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_BarkThickness)
# VarImp_BarkThickness <- calc.relimp(model_BarkThickness, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*: contributing >5%
# VarImp_BarkThickness <- as.data.frame(VarImp_BarkThickness@lmg)
# VarImp_BarkThickness_Final <- VarImp_BarkThickness %>% rename(VarImp=`VarImp_BarkThickness@lmg`)
# VarImp_BarkThickness_Final <- cbind(VarImp_BarkThickness_Final, summary(model_BarkThickness)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_BarkThickness_Final$Variable <- "BarkThickness"

model_WoodDensity <- lm(WoodDensity ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_WoodDensity)
VarImp_WoodDensity <- calc.relimp(model_WoodDensity, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity*: contributing >5%
VarImp_WoodDensity <- as.data.frame(VarImp_WoodDensity@lmg)
VarImp_WoodDensity_Final <- VarImp_WoodDensity %>% rename(VarImp=`VarImp_WoodDensity@lmg`)
VarImp_WoodDensity_Final <- cbind(VarImp_WoodDensity_Final, summary(model_WoodDensity)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_WoodDensity_Final$Variable <- "WoodDensity"

# model_SLA <- lm(SLA ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_SLA)
# VarImp_SLA <- calc.relimp(model_SLA, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity: contributing >5%
# VarImp_SLA <- as.data.frame(VarImp_SLA@lmg)
# VarImp_SLA_Final <- VarImp_SLA %>% rename(VarImp=`VarImp_SLA@lmg`)
# VarImp_SLA_Final <- cbind(VarImp_SLA_Final, summary(model_SLA)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_SLA_Final$Variable <- "SLA"

model_LeafN <- lm(LeafN ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_LeafN)
VarImp_LeafN <- calc.relimp(model_LeafN, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_LeafN <- as.data.frame(VarImp_LeafN@lmg)
VarImp_LeafN_Final <- VarImp_LeafN %>% rename(VarImp=`VarImp_LeafN@lmg`)
VarImp_LeafN_Final <- cbind(VarImp_LeafN_Final, summary(model_LeafN)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_LeafN_Final$Variable <- "LeafN"

# model_LeafNP <- lm(LeafNP ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_LeafNP)
# VarImp_LeafNP <- calc.relimp(model_LeafNP, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_LeafNP <- as.data.frame(VarImp_LeafNP@lmg)
# VarImp_LeafNP_Final <- VarImp_LeafNP %>% rename(VarImp=`VarImp_LeafNP@lmg`)
# VarImp_LeafNP_Final <- cbind(VarImp_LeafNP_Final, summary(model_LeafNP)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_LeafNP_Final$Variable <- "LeafNP"
# 
# model_StemConduitDiam <- lm(StemConduitDiameter ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_StemConduitDiam)
# VarImp_StemConduitDiam <- calc.relimp(model_StemConduitDiam, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_StemConduitDiam <- as.data.frame(VarImp_StemConduitDiam@lmg)
# VarImp_StemConduitDiam_Final <- VarImp_StemConduitDiam %>% rename(VarImp=`VarImp_StemConduitDiam@lmg`)
# VarImp_StemConduitDiam_Final <- cbind(VarImp_StemConduitDiam_Final, summary(model_StemConduitDiam)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_StemConduitDiam_Final$Variable <- "StemConduitDiam"

model_RootDepth <- lm(RootDepth ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_RootDepth)
VarImp_RootDepth <- calc.relimp(model_RootDepth, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_RootDepth <- as.data.frame(VarImp_RootDepth@lmg)
VarImp_RootDepth_Final <- VarImp_RootDepth %>% rename(VarImp=`VarImp_RootDepth@lmg`)
VarImp_RootDepth_Final <- cbind(VarImp_RootDepth_Final, summary(model_RootDepth)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_RootDepth_Final$Variable <- "RootDepth"

model_SeedMass <- lm(SeedMass ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_SeedMass)
VarImp_SeedMass <- calc.relimp(model_SeedMass, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_SeedMass <- as.data.frame(VarImp_SeedMass@lmg)
VarImp_SeedMass_Final <- VarImp_SeedMass %>% rename(VarImp=`VarImp_SeedMass@lmg`)
VarImp_SeedMass_Final <- cbind(VarImp_SeedMass_Final, summary(model_SeedMass)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_SeedMass_Final$Variable <- "SeedMass"

model_pca1 <- lm(pca1 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
summary(model_pca1)
VarImp_pca1 <- calc.relimp(model_pca1, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
VarImp_pca1 <- as.data.frame(VarImp_pca1@lmg)
VarImp_pca1_Final <- VarImp_pca1 %>% rename(VarImp=`VarImp_pca1@lmg`)
VarImp_pca1_Final <- cbind(VarImp_pca1_Final, summary(model_pca1)$coefficients[c(-1,-9,-10,-11,-12),])
VarImp_pca1_Final$Variable <- "pca1"

# model_pca2 <- lm(pca2 ~ scale(Temperature) + I(scale(Temperature)^2) + scale(Humidity) + I(scale(Humidity)^2) + scale(Temperature)*scale(Humidity) + scale(Temperature)*I(scale(Humidity)^2) + I(scale(Temperature)^2)*scale(Humidity) + I(scale(Temperature)^2)*I(scale(Humidity)^2) + scale(Elevation) + scale(ForestAge) + factor(Biome) + scale(Plotsize), data=DifCWM_Envars)
# summary(model_pca2)
# VarImp_pca2 <- calc.relimp(model_pca2, type = "lmg", rela = TRUE) #calculate relative importance scaled to 100 #Temp*-Temp2*-Humidity-Humidity2*: contributing >5%
# VarImp_pca2 <- as.data.frame(VarImp_pca2@lmg)
# VarImp_pca2_Final <- VarImp_pca2 %>% rename(VarImp=`VarImp_pca2@lmg`)
# VarImp_pca2_Final <- cbind(VarImp_pca2_Final, summary(model_pca2)$coefficients[c(-1,-9,-10,-11,-12),])
# VarImp_pca2_Final$Variable <- "pca2"

Final_modelsForestAge35 <- rbind(VarImp_Height_Final, VarImp_WoodDensity_Final, VarImp_LeafN_Final, VarImp_RootDepth_Final, VarImp_SeedMass_Final, VarImp_pca1_Final) #VarImp_CrownDiameter_Final, VarImp_BarkThickness_Final, VarImp_SLA_Final, VarImp_LeafNP_Final, VarImp_StemConduitDiam_Final, VarImp_Gymnosperm_Final, VarImp_pca2_Final

Final_modelsForestAge35 <- tibble::rownames_to_column(Final_modelsForestAge35, "Term")
Final_modelsForestAge35$Category <- "ForestAge35"

Final_models <- rbind(Final_modelsPerc5, Final_modelsPerc15, Final_modelsForestAge30, Final_modelsForestAge35)
write.xlsx(Final_models, file = "SensitivityAnalysis_Final_models.xlsx")

```
###Sensitivity analysis: Bootstrapping temperate biome 
```{r Bootstrapping temperate biome}

setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity")
GFBI_SpeciesCheck <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_SpeciesCheck_7-2021.csv") #plots: 1184025

GFBI_SumS <- as.data.frame(GFBI_SpeciesCheck %>% group_by(plot_id) %>% mutate(SumS=as.numeric(n_distinct(species_name)))) #Sum of species per plot
GFBI_atleast2Sp <- GFBI_SumS[which(GFBI_SumS$SumS >= 6),] #Erase monocultures

###Select plots with distinct dominant and rare species 
GFBI_atleast2Sp$NrInd <- 1 #Add Nr of individuals
GFBI_Plot <- GFBI_atleast2Sp %>% group_by(Biome, plot_id) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd), PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>%
  slice(1) %>% as.data.frame()

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_MeanIndSum <- GFBI_MeanIndFilter %>% group_by(Biome, plot_id) %>% arrange(PercPerSpecies) %>% mutate(PercSpecies_cumsum = cumsum(PercPerSpecies)) %>% as.data.frame()

GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum <= 10, "rare", "intermediate")
GFBI_MeanIndSum$DominanceCategory <- ifelse(GFBI_MeanIndSum$PercSpecies_cumsum >= 90, "dominant", GFBI_MeanIndSum$DominanceCategory)                                                

rm(GFBI_SpeciesCheck, GFBI_SumS, GFBI_atleast2Sp, GFBI_Plot, GFBI_MeanInd, GFBI_MeanIndFilter)

###Only keep dominant and rare species
GFBI_DomRare <- GFBI_MeanIndSum[which(GFBI_MeanIndSum$DominanceCategory == "dominant" | GFBI_MeanIndSum$DominanceCategory == "rare"),]

###Select biomes 4
GFBI_DomRare_Biome <- GFBI_DomRare[which(GFBI_DomRare$Biome== 4),] 

###Join with trait data
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, CrownDiameter, BarkThickness, WoodDensity, SLA, LeafN, LeafNP, StemConduitDiameter, RootDepth, SeedMass))
rm(Traits)

GFBI_DomRare_Biome$genus <- word(GFBI_DomRare_Biome$species_name, 1) #Define gymnosperms/angiosperms
family <- getTaxonomy(GFBI_DomRare_Biome$genus) ###Add family name 
family$sperms <- ifelse(family$family == "Araucariaceae" |family$family == "Boweniaceae" |family$family == "Cephalotaxaceae" |family$family == "Cupressaceae" |family$family == "Cycadaceae" |family$family == "Ephedraceae" |family$family == "Ginkgoaceae" |family$family == "Gnetaceae" |family$family == "Pinaceae" |family$family == "Podocarpaceae" |family$family == "Taxaceae" |family$family == "Taxodiaceae" |family$family == "Welwitschiaceae" |family$family == "Zamiaceae", "gymnosperm", "angiosperm")

GFBI_DomRare_Biome$GymnoAngiosperm <- family$sperms

GFBI_DomRare_Traits <- left_join(GFBI_DomRare_Biome, Traits_Select, by="obs_id")
rm(GFBI_DomRare_Biome, Traits_Select)

###Log transform and scale traits 
Plot_SpTraitsLog <- GFBI_DomRare_Traits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
Plot_SpTraitsMean <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% slice(1) #Take mean trait per species/plot (there is no intra-specific variation within the plot anyhow)
Plot_TraitsNrInd <- Plot_SpTraitsLog %>% group_by(plot_id, species_name) %>% dplyr::summarise(NrIndSp=sum(NrInd)) 
Plot_TraitsMeanMerge <- as.data.frame(left_join(Plot_SpTraitsMean, Plot_TraitsNrInd, by=c("plot_id","species_name")))

Plot_TraitsScaled <- Plot_TraitsMeanMerge %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values by Biome or globally group_by(Biome) %>% 

rm(Plot_SpTraitsLog, Plot_SpTraitsMean, Plot_TraitsNrInd, Plot_TraitsMeanMerge)

###Calculate difference D-R traits
Plot_TraitsDomRare <- Plot_TraitsScaled
  
Plot_TraitsDRScaled <- Plot_TraitsDomRare %>% group_by(Biome, plot_id, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), median, na.rm = TRUE) %>% as.data.frame() ###Difference between CWM dominant and rare species traits

Plot_TraitsD <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "dominant"),]
Plot_TraitsR <- Plot_TraitsDRScaled[which(Plot_TraitsDRScaled$DominanceCategory == "rare"),]

#Calculate difference dominant-rare species median trait values
JoinRare <- anti_join(Plot_TraitsR, Plot_TraitsD, by="plot_id")
JoinDom <- anti_join(Plot_TraitsD, Plot_TraitsR, by="plot_id")

CWMDomFilter <- anti_join(Plot_TraitsD, JoinDom, by="plot_id")
CWMDomOrder <- CWMDomFilter[order(CWMDomFilter$plot_id),]
CWMDomSubset <- as.data.frame(subset(CWMDomOrder, select=-c(plot_id, DominanceCategory, Biome)))

CWMRareFilter <- anti_join(Plot_TraitsR, JoinRare, by="plot_id")
CWMRareOrder <- CWMRareFilter[order(CWMRareFilter$plot_id),]
CWMRareSubset <- as.data.frame(subset(CWMRareOrder, select=-c(plot_id, DominanceCategory, Biome)))

DiffDomRare_CWM <- CWMDomSubset - CWMRareSubset
DiffDomRare_CWM$plot_id <- CWMRareOrder$plot_id
DiffDomRare_CWM$Biome <- as.numeric(CWMRareOrder$Biome)

rm(Plot_TraitsDomRare, Plot_TraitsDRScaled, Plot_TraitsD, Plot_TraitsR)

###Bootstrapping
NrPlots <- GFBI_DomRare_Traits %>% group_by(Biome) %>% dplyr::summarise(Nr = n_distinct(plot_id)) #Biome 4 264660 4%, Biome 5  43124 23%, Biome 6 12674 79%

###Biome 4
Biome4 <- DiffDomRare_CWM[which(DiffDomRare_CWM$Biome == 4),]

Biome4_BS_Height <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(Height, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = Height))
Biome4_BS_Height$Trait <- "Height"
#Biome4_BS_Height$Value <- Biome4_BS_Height$Height

Biome4_BS_CrownDiameter <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(CrownDiameter, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = CrownDiameter))
Biome4_BS_CrownDiameter$Trait <- "CrownDiameter"
#Biome4_BS_CrownDiameter$Value <- Biome4_BS_CrownDiameter$CrownDiameter

Biome4_BS_BarkThickness <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(BarkThickness, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = BarkThickness))
Biome4_BS_BarkThickness$Trait <- "BarkThickness"
#Biome4_BS_BarkThickness$Value <- Biome4_BS_BarkThickness$BarkThickness

Biome4_BS_WoodDensity <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(WoodDensity, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = WoodDensity))
Biome4_BS_WoodDensity$Trait <- "WoodDensity"
#Biome4_BS_WoodDensity$Value <- Biome4_BS_WoodDensity$WoodDensity

Biome4_BS_SLA <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(SLA, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = SLA))
Biome4_BS_SLA$Trait <- "SLA"
#Biome4_BS_SLA$Value <- Biome4_BS_SLA$SLA

Biome4_BS_LeafN <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(LeafN, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = LeafN))
Biome4_BS_LeafN$Trait <- "LeafN"
#Biome4_BS_LeafN$Value <- Biome4_BS_LeafN$LeafN

Biome4_BS_LeafNP <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(LeafNP, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = LeafNP))
Biome4_BS_LeafNP$Trait <- "LeafNP"
#Biome4_BS_LeafNP$Value <- Biome4_BS_LeafNP$LeafNP

Biome4_BS_StemConduitDiameter <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(StemConduitDiameter, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = StemConduitDiameter))
Biome4_BS_StemConduitDiameter$Trait <- "StemConduitDiameter"
#Biome4_BS_StemConduitDiameter$Value <- Biome4_BS_StemConduitDiameter$StemConduitDiameter

Biome4_BS_RootDepth <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(RootDepth, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = RootDepth))
Biome4_BS_RootDepth$Trait <- "RootDepth"
#Biome4_BS_RootDepth$Value <- Biome4_BS_RootDepth$RootDepth

Biome4_BS_SeedMass <- Biome4 %>% tidyr::expand(bs = 1:100, nesting(SeedMass, plot_id)) %>% group_by(bs) %>% sample_n(size = 10000) %>% summarize(Mean = mean(x = SeedMass))
Biome4_BS_SeedMass$Trait <- "SeedMass"
#Biome4_BS_SeedMass$Value <- Biome4_BS_SeedMass$SeedMass

Biome4_BS <- rbind(Biome4_BS_Height, Biome4_BS_WoodDensity, Biome4_BS_LeafN, Biome4_BS_SeedMass, Biome4_BS_RootDepth, Biome4_BS_CrownDiameter, Biome4_BS_BarkThickness, Biome4_BS_StemConduitDiameter, Biome4_BS_SLA, Biome4_BS_LeafNP)
Biome4_BS$Biome <- 4

write.xlsx(Biome4_BS, file = "SensitivityAnalysis_BS_Biome4.xlsx")

names(Biome4_BS)
Biome4_BS_analysis <- Biome4_BS %>% group_by(Trait) %>% summarize(mean_traits=mean(Mean), sd_trait=sd(Mean))

Height_plot <- ggplot(Biome4_BS_Height, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Height D-R") + theme_classic() + geom_vline(xintercept = 0.16)
CrownDiameter_plot <- ggplot(Biome4_BS_CrownDiameter, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Crown diameter D-R") + theme_classic() + geom_vline(xintercept = -0.14)
BarkThickness_plot <- ggplot(Biome4_BS_BarkThickness, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Bark thickness D-R") + theme_classic() + geom_vline(xintercept = 0.11)
WoodDensity_plot <- ggplot(Biome4_BS_WoodDensity, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Wood density D-R") + theme_classic() + geom_vline(xintercept = -0.03)
SLA_plot <- ggplot(Biome4_BS_SLA, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("SLA D-R") + theme_classic() + geom_vline(xintercept = -0.03)
LeafN_plot <- ggplot(Biome4_BS_LeafN, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Leaf N D-R") + theme_classic() + geom_vline(xintercept = -0.18)
LeafNP_plot <- ggplot(Biome4_BS_LeafNP, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Leaf NP D-R") + theme_classic() + geom_vline(xintercept = -0.08)
StemConduitDiameter_plot <- ggplot(Biome4_BS_StemConduitDiameter, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Stem conduit diameter D-R") + theme_classic() + geom_vline(xintercept = -0.21)
RootDepth_plot <- ggplot(Biome4_BS_RootDepth, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Root depth D-R") + theme_classic() + geom_vline(xintercept = -0.07)
SeedMass_plot <- ggplot(Biome4_BS_SeedMass, aes(x = Value)) + geom_histogram() + ylab("Frequency") + xlab("Seed mass D-R") + theme_classic() + geom_vline(xintercept = -0.06)

Pplot_SI <- grid.arrange(Height_plot, WoodDensity_plot, LeafN_plot, SeedMass_plot, RootDepth_plot, CrownDiameter_plot, BarkThickness_plot, StemConduitDiameter_plot, SLA_plot,  LeafNP_plot, nrow=2)

```
###Sensitivity analysis: Null model traits 
```{r Null model traits }
rm()
setwd("~/Documents/PhD projects/2nd Chapter - Trait diversity")

GFBI_SpeciesCheck <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_SpeciesCheck_7-2021.csv") #plots: 1184025
GFBI_SumS <- as.data.frame(GFBI_SpeciesCheck %>% group_by(plot_id) %>% mutate(SumS=as.numeric(n_distinct(species_name)))) #Sum of species per plot
GFBI_atleast2Sp <- GFBI_SumS[which(GFBI_SumS$SumS >= 6),] #Erase monocultures
GFBI_atleast2Sp$NrInd <- 1 #Add Nr of individuals
GFBI_NrInd <- GFBI_atleast2Sp %>% group_by(Biome, plot_id, species_name) %>% summarise(NrIndSum=sum(NrInd)) %>% as.data.frame() #Calculate nr of individuals per species

###Select subset biomes 4, 5 and 6 
Select_Plots_Biome4to6 <- GFBI_NrInd[which(GFBI_NrInd$Biome >= 4),]
Select_PlotsBiome4to6Subset <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/SubsetPlotsBiome4to6.csv")
Biome4to6Subset_plots <- Select_PlotsBiome4to6Subset %>% group_by(Biome, plot_id) %>% slice(1) %>% dplyr::select(Biome, plot_id) %>% as.data.frame()
Final_Plots_Biome4to6 <- left_join(Biome4to6Subset_plots, Select_Plots_Biome4to6)  

Select_Plots_all <- GFBI_NrInd[which(GFBI_NrInd$Biome < 4),]
Select_PlotsFinal <- rbind(Select_Plots_all, Final_Plots_Biome4to6)

###Biome 1
Biome1 <- GFBI_NrInd[which(GFBI_NrInd$Biome == 1),] #Select only biome 1
Biome1 <- Biome1 %>% dplyr:: select(-Biome) %>% as.data.frame() #nr plots 1826 #nr species 5142

GFBI_Wider <- Biome1 %>% mutate(row = plot_id) %>% tidyr::pivot_wider(names_from = species_name, values_from = NrIndSum) %>% dplyr::select(-row) %>% as.data.frame()
GFBI_Wider[is.na(GFBI_Wider)] <- 0 #Dim 1826 5143=9.4 million
GFBI_Wider_sp <- GFBI_Wider %>% dplyr::select(-plot_id)

rm(Biome1, GFBI_atleast2Sp, GFBI_NrInd, GFBI_SpeciesCheck, GFBI_SumS)

# fwrite(GFBI_Wider, file = "DataRandomizationBiome1.csv") 
# 
# Randomization1_1 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_1 <- Randomization1_1$perm 
# fwrite(RandomizationBiome1_1, file = "RandomizationBiome1_1.csv") 
# 
# Randomization1_2 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_2 <- Randomization1_2$perm 
# fwrite(RandomizationBiome1_2, file = "RandomizationBiome1_2.csv") 
# 
# Randomization1_3 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_3 <- Randomization1_3$perm 
# fwrite(RandomizationBiome1_3, file = "RandomizationBiome1_3.csv") 
# 
# Randomization1_4 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_4 <- Randomization1_4$perm 
# fwrite(RandomizationBiome1_4, file = "RandomizationBiome1_4.csv") 
# 
# Randomization1_5 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_5 <- Randomization1_5$perm 
# fwrite(RandomizationBiome1_5, file = "RandomizationBiome1_5.csv") 
# 
# Randomization1_6 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_6 <- Randomization1_6$perm 
# fwrite(RandomizationBiome1_6, file = "RandomizationBiome1_6.csv") 
# 
# Randomization1_7 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_7 <- Randomization1_7$perm 
# fwrite(RandomizationBiome1_7, file = "RandomizationBiome1_7.csv")
# 
# Randomization1_8 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_8 <- Randomization1_8$perm 
# fwrite(RandomizationBiome1_8, file = "RandomizationBiome1_8.csv") 
# 
# Randomization1_9 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_9 <- Randomization1_9$perm 
# fwrite(RandomizationBiome1_9, file = "RandomizationBiome1_9.csv")
# 
# Randomization1_10 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_10 <- Randomization1_10$perm 
# fwrite(RandomizationBiome1_10, file = "RandomizationBiome1_10.csv")

# Randomization1_11 <- permatswap(GFBI_Wider, "quasiswap", times=5)
# RandomizationBiome1_11 <- Randomization1_11$perm
# fwrite(RandomizationBiome1_11, file = "RandomizationBiome1_11.csv")

# RandomizationBiome1_1 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_1.csv")
# colnames(RandomizationBiome1_1) <- c(paste0("Random", 1:5)) #Rename columns
# 
# RandomizationBiome1_2 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_2.csv")
# colnames(RandomizationBiome1_2) <- c(paste0("Random",6:10)) #Rename columns
# 
# RandomizationBiome1_3 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_3.csv")
# colnames(RandomizationBiome1_3) <- c(paste0("Random", 11:15)) #Rename columns
# 
# RandomizationBiome1_4 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_4.csv")
# colnames(RandomizationBiome1_4) <- c(paste0("Random", 16:20)) #Rename columns
# 
# RandomizationBiome1_5 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_5.csv")
# colnames(RandomizationBiome1_5) <- c(paste0("Random", 21:25)) #Rename columns
# 
# RandomizationBiome1_6 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_6.csv")
# colnames(RandomizationBiome1_6) <- c(paste0("Random", 26:30)) #Rename columns
# 
# RandomizationBiome1_7 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_7.csv")
# colnames(RandomizationBiome1_7) <- c(paste0("Random", 31:35)) #Rename columns
# 
# RandomizationBiome1_8 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_8.csv")
# colnames(RandomizationBiome1_8) <- c(paste0("Random", 36:40)) #Rename columns
# 
# RandomizationBiome1_9 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_9.csv")
# colnames(RandomizationBiome1_9) <- c(paste0("Random", 41:45)) #Rename columns
# 
# RandomizationBiome1_10 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_10.csv")
# colnames(RandomizationBiome1_10) <- c(paste0("Random", 46:50)) #Rename columns
# 
# RandomizationBiome1 <- cbind(RandomizationBiome1_1, RandomizationBiome1_2, RandomizationBiome1_3, RandomizationBiome1_4, RandomizationBiome1_5, RandomizationBiome1_6, RandomizationBiome1_7, RandomizationBiome1_8, RandomizationBiome1_9, RandomizationBiome1_10)
# 
# RandBiome1 <- mutate_all(RandomizationBiome1, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
# Sp_names <- colnames(GFBI_Wider_sp)
# RandBiome1_Sp <- RandBiome1 %>% mutate(species_name = paste(rep(Sp_names, times = 1826))) #Add species names
# 
# Plot_id <- GFBI_Wider$plot_id
# RandBiome1_Plot <- RandBiome1_Sp %>% mutate(plot_id = paste(rep(Plot_id, each = 5142))) #Add plot nr
# 
# RandBiome1_Plot_longer <- RandBiome1_Plot %>% tidyr::pivot_longer(!species_name & !plot_id, names_to = "randomization", values_to = "NrIndSum") %>% as.data.frame() #Longer dataframe
# RandBiome1_Plot_longer$Biome <- "Biome1"
# 
# fwrite(RandBiome1_Plot_longer, file = "RandBiome1_Plot_longer.csv")
# RandBiome1_Plot_longer <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandBiome1_Plot_longer.csv")

# RandomizationBiome1 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome1_Final100.csv")
# 
# RandBiome1 <- mutate_all(RandomizationBiome1, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
# rm(RandomizationBiome1)
# 
# Sp_names <- colnames(GFBI_Wider_sp)
# RandBiome1_Sp <- RandBiome1 %>% mutate(species_name = paste(rep(Sp_names, times = 1826))) #Add species names
# rm(RandBiome1)
# 
# Plot_id <- GFBI_Wider$plot_id
# RandBiome1_Plot <- RandBiome1_Sp %>% mutate(plot_id = paste(rep(Plot_id, each = 5142))) #Add plot nr
# rm(Sp_names, Plot_id, GFBI_Wider, GFBI_Wider_sp, RandBiome1_Sp)
# 
# RandBiome1_Select <- RandBiome1_Plot %>%filter(rowSums(across(where(is.numeric)))!=0)
# rm(RandBiome1_Plot)
# 
# RandBiome1_Plot_longer <- RandBiome1_Select %>% tidyr::pivot_longer(!species_name & !plot_id, names_to = "randomization", values_to = "NrIndSum") %>% as.data.frame() #Longer dataframe
# RandBiome1_Plot_longer$Biome <- "Biome1"
# 
# fwrite(RandBiome1_Plot_longer, file = "RandBiome1_Plot_longerFinal.csv")
RandBiome1_Plot_longer <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandBiome1_Plot_longerFinal.csv")

######Calculate dominant & rare species
RandBiome1_Plot_compl <- RandBiome1_Plot_longer[which(RandBiome1_Plot_longer$NrIndSum > 0),] #remove species with zero observations
RandBiome1_Plot_compl$NrInd <- RandBiome1_Plot_compl$NrIndSum

GFBI_Plot <- RandBiome1_Plot_compl %>% group_by(Biome, plot_id, randomization) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                        PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, randomization, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>% as.data.frame()
rm(RandBiome1_Plot_longer, RandBiome1_Plot_compl)

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, randomization, plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_Div20 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 20),] #700 plots, 0.11%
GFBI_Div6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS < 20 & GFBI_MeanIndFilter$SumS >= 6),] #144592 plots, 45%

GFBI_Div20Dom <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
GFBI_Div20Dom$DominanceCategory <- "dominant"
GFBI_Div20Rare <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
GFBI_Div20Rare$DominanceCategory <- "rare"

GFBI_Div6Dom <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(n = 2) #takes top 2 species
GFBI_Div6Dom$DominanceCategory <- "dominant"
GFBI_Div6Rare <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(n = 2) #takes bottom 2 species
GFBI_Div6Rare$DominanceCategory <- "rare"

GFBI_DivDR <- rbind(GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6Dom, GFBI_Div6Rare)
GFBI_DivDR <- subset(GFBI_DivDR, select = c("plot_id", "species_name", "DominanceCategory", "PercPerSpecies")) %>% as.data.frame()

GFBI_PlotMore6 <- GFBI_Plot[which(GFBI_Plot$SumS >= 6),]
PlotDominantRare <- merge(x = GFBI_PlotMore6, y = GFBI_DivDR, by = c("plot_id", "species_name"), all.x = TRUE)
PlotDominantRare$DominanceCategory <- replace(PlotDominantRare$DominanceCategory, is.na(PlotDominantRare$DominanceCategory), "intermediate")
PlotDominantRare <- as.data.frame(PlotDominantRare)

GFBI_Biome1DomRare <- PlotDominantRare[which(PlotDominantRare$DominanceCategory == "rare" | PlotDominantRare$DominanceCategory == "dominant"),]  
DominantRare_Plot <- GFBI_Biome1DomRare %>% dplyr::select(randomization, plot_id, species_name, DominanceCategory)
rm(GFBI_Div20, GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6, GFBI_Div6Dom, GFBI_Div6Rare, GFBI_DivDR, GFBI_MeanInd, GFBI_MeanIndFilter, GFBI_PlotMore6) #keep "DominantRare_Plot", "GFBI_Biome1DomRare"
rm(GFBI_Plot, PlotDominantRare)

#######Match species with trait data, average trait value by biome
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, WoodDensity, LeafN, RootDepth, SeedMass))
DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")
rm(Traits)

GFBI_traits <- left_join(DominantRare_Plot, Traits_Select) 
GFBI_traits_biome <- GFBI_traits %>% group_by(Biome, species_name) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
GFBI_traits_Biome1 <- GFBI_traits_biome[which(GFBI_traits_biome$Biome==1),]
rm(Traits_Select, GFBI_traits, GFBI_traits_biome, DominantRare_Plot)

GFBI_Biome1DRtraits <- left_join(GFBI_Biome1DomRare, GFBI_traits_Biome1, by="species_name") 

#####Calculate dominant and rare traits in different ways
GFBI_Biome1DRtraits <- GFBI_Biome1DRtraits %>% group_by(plot_id, randomization) %>% filter(n_distinct(DominanceCategory)==2)
Plot_SpTraitsLog <- GFBI_Biome1DRtraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
#Plot_TraitsScaled <- Plot_SpTraitsLog %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values

Plot_TraitsDRMedian <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), median, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMedian$Category <- "Median"
Plot_TraitsDRMean <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMean$Category <- "Mean"
Plot_TraitsDRInter <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), IQR, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRInter$Category <- "Inter"

PlotBiome1 <- rbind(Plot_TraitsDRMedian, Plot_TraitsDRMean, Plot_TraitsDRInter)
PlotBiome1$Categories <- paste(PlotBiome1$Category,PlotBiome1$DominanceCategory)
Height_plot_Biome1 <- ggplot(PlotBiome1, aes(x = Height, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Height") + theme_classic() + theme(legend.position = "none")
WoodDensity_plot_Biome1 <- ggplot(PlotBiome1, aes(x = WoodDensity, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Wood density") + theme_classic() + theme(legend.position = "none")
LeafN_plot_Biome1 <- ggplot(PlotBiome1, aes(x = LeafN, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Leaf N") + theme_classic() + theme(legend.position = "none")
RootDepth_plot_Biome1 <- ggplot(PlotBiome1, aes(x = RootDepth, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Root depth") + theme_classic() + theme(legend.position = "none")
SeedMass_plot_Biome1 <- ggplot(PlotBiome1, aes(x = SeedMass, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Seed mass") + theme_classic() + theme(legend.position = "none")

grid.arrange(Height_plot_Biome1, WoodDensity_plot_Biome1, LeafN_plot_Biome1, RootDepth_plot_Biome1, SeedMass_plot_Biome1, top = textGrob("Traits Biome 1",gp=gpar(fontsize=14)))


###Biome 2
Biome2 <- GFBI_NrInd[which(GFBI_NrInd$Biome == 2),] #Select only biome 2
Biome2 <- Biome2 %>% dplyr:: select(-Biome) %>% as.data.frame()

GFBI_Wider <- Biome2 %>% mutate(row = plot_id) %>% tidyr::pivot_wider(names_from = species_name, values_from = NrIndSum) %>% dplyr::select(-row) %>% as.data.frame()
GFBI_Wider[is.na(GFBI_Wider)] <- 0 #Dim 1174  365=428.000
GFBI_Wider_sp <- GFBI_Wider %>% dplyr::select(-plot_id) #nr plots 1174 #nr species 364

# Randomization2 <- permatswap(GFBI_Wider_sp, "quasiswap", times=100)
# RandomizationBiome2 <- Randomization2$perm 
# fwrite(RandomizationBiome2, file = "RandomizationBiome2.csv") 

RandomizationBiome2 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome2.csv")
RandBiome2 <- mutate_all(RandomizationBiome2, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
colnames(RandBiome2) <- c(paste0("Random", 1:100)) #Rename columns

Sp_names <- colnames(GFBI_Wider_sp)
RandBiome2_Sp <- RandBiome2 %>% mutate(species_name = paste(rep(Sp_names, times = 1174))) #Add species names

Plot_id <- GFBI_Wider$plot_id
RandBiome2_Plot <- RandBiome2_Sp %>% mutate(plot_id = paste(rep(Plot_id, each = 364))) #Add plot nr

RandBiome2_Plot_longer <- RandBiome2_Plot %>% tidyr::pivot_longer(!species_name & !plot_id, names_to = "randomization", values_to = "NrIndSum") %>% as.data.frame() #Longer dataframe
RandBiome2_Plot_longer$Biome <- "Biome2"

######Calculate dominant & rare species
RandBiome2_Plot_compl <- RandBiome2_Plot_longer[which(RandBiome2_Plot_longer$NrIndSum > 0),] #remove species with zero observations
RandBiome2_Plot_compl$NrInd <- RandBiome2_Plot_compl$NrIndSum

GFBI_Plot <- RandBiome2_Plot_compl %>% group_by(Biome, plot_id, randomization) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                        PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, randomization, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>%
  slice(1) %>% as.data.frame()

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, randomization, plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_Div20 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 20),] #700 plots, 0.11%
GFBI_Div6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS < 20 & GFBI_MeanIndFilter$SumS >= 6),] #144592 plots, 45%

GFBI_Div20Dom <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
GFBI_Div20Dom$DominanceCategory <- "dominant"
GFBI_Div20Rare <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
GFBI_Div20Rare$DominanceCategory <- "rare"

GFBI_Div6Dom <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(n = 2) #takes top 2 species
GFBI_Div6Dom$DominanceCategory <- "dominant"
GFBI_Div6Rare <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(n = 2) #takes bottom 2 species
GFBI_Div6Rare$DominanceCategory <- "rare"

GFBI_DivDR <- rbind(GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6Dom, GFBI_Div6Rare)
GFBI_DivDR <- subset(GFBI_DivDR, select = c("plot_id", "species_name", "DominanceCategory", "PercPerSpecies")) %>% as.data.frame()

GFBI_PlotMore6 <- GFBI_Plot[which(GFBI_Plot$SumS >= 6),]
PlotDominantRare <- merge(x = GFBI_PlotMore6, y = GFBI_DivDR, by = c("plot_id", "species_name"), all.x = TRUE)
PlotDominantRare$DominanceCategory <- replace(PlotDominantRare$DominanceCategory, is.na(PlotDominantRare$DominanceCategory), "intermediate")
PlotDominantRare <- as.data.frame(PlotDominantRare)

GFBI_Biome2DomRare <- PlotDominantRare[which(PlotDominantRare$DominanceCategory == "rare" | PlotDominantRare$DominanceCategory == "dominant"),]  
DominantRare_Plot <- GFBI_Biome2DomRare %>% dplyr::select(randomization, plot_id, species_name, DominanceCategory)

#######Match species with trait data, average trait value by biome
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, WoodDensity, LeafN, RootDepth, SeedMass))
DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")
rm(Traits)

GFBI_traits <- left_join(DominantRare_Plot, Traits_Select) 
GFBI_traits_biome <- GFBI_traits %>% group_by(Biome, species_name) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
GFBI_traits_Biome2 <- GFBI_traits_biome[which(GFBI_traits_biome$Biome==2),]

GFBI_Biome2DRtraits <- left_join(GFBI_Biome2DomRare, GFBI_traits_Biome2, by="species_name") 

#####Calculate dominant and rare traits in different ways
GFBI_Biome2DRtraits <- GFBI_Biome2DRtraits %>% group_by(plot_id, randomization) %>% filter(n_distinct(DominanceCategory)==2)
Plot_SpTraitsLog <- GFBI_Biome2DRtraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
#Plot_TraitsScaled <- Plot_SpTraitsLog %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values

Plot_TraitsDRMedian <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), median, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMedian$Category <- "Median"
Plot_TraitsDRMean <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMean$Category <- "Mean"
Plot_TraitsDRInter <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), IQR, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRInter$Category <- "Inter"

PlotBiome2 <- rbind(Plot_TraitsDRMedian, Plot_TraitsDRMean, Plot_TraitsDRInter)
PlotBiome2$Categories <- paste(PlotBiome2$Category,PlotBiome2$DominanceCategory)
Height_plot_Biome2 <- ggplot(PlotBiome2, aes(x = Height, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Height") + theme_classic() + theme(legend.position = "none")
WoodDensity_plot_Biome2 <- ggplot(PlotBiome2, aes(x = WoodDensity, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Wood density") + theme_classic() + theme(legend.position = "none")
LeafN_plot_Biome2 <- ggplot(PlotBiome2, aes(x = LeafN, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Leaf N") + theme_classic() + theme(legend.position = "none")
RootDepth_plot_Biome2 <- ggplot(PlotBiome2, aes(x = RootDepth, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Root depth") + theme_classic() + theme(legend.position = "none")
SeedMass_plot_Biome2 <- ggplot(PlotBiome2, aes(x = SeedMass, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Seed mass") + theme_classic() + theme(legend.position = "none")

grid.arrange(Height_plot_Biome2, WoodDensity_plot_Biome2, LeafN_plot_Biome2, RootDepth_plot_Biome2, SeedMass_plot_Biome2, top = textGrob("Traits Biome 2",gp=gpar(fontsize=14)))


# ###Biome 3
# Biome3 <- GFBI_NrInd[which(GFBI_NrInd$Biome == 3),] #Select only biome 3
# Biome3 <- Biome3 %>% dplyr:: select(-Biome) %>% as.data.frame()
# 
# GFBI_Wider <- Biome3 %>% mutate(row = plot_id) %>% tidyr::pivot_wider(names_from = species_name, values_from = NrIndSum) %>% dplyr::select(-row) %>% as.data.frame()
# GFBI_Wider[is.na(GFBI_Wider)] <- 0 #Dim 20 24
# GFBI_Wider_sp <- GFBI_Wider %>% dplyr::select(-plot_id) 
# 
# # Randomization3 <- permatswap(GFBI_Wider_sp, "quasiswap", times=100)
# # RandomizationBiome3 <- Randomization3$perm 
# # fwrite(RandomizationBiome3, file = "RandomizationBiome3.csv") 
# 
# RandomizationBiome3 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome3.csv")
# RandBiome3 <- mutate_all(RandomizationBiome3, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
# colnames(RandBiome3) <- c(paste0("Random", 1:100)) #Rename columns
# 
# Sp_names <- colnames(GFBI_Wider_sp)
# RandBiome3_Sp <- RandBiome3 %>% mutate(species_name = paste(rep(Sp_names, times = 1733))) #Add species names
# 
# Plot_id <- GFBI_Wider$plot_id
# RandBiome3_Plot <- RandBiome3_Sp %>% mutate(plot_id = paste(rep(Plot_id, each = 48))) #Add plot nr
# 
# RandBiome3_Plot_longer <- RandBiome3_Plot %>% tidyr::pivot_longer(!species_name & !plot_id, names_to = "randomization", values_to = "NrIndSum") %>% as.data.frame() #Longer dataframe
# RandBiome3_Plot_longer$Biome <- "Biome3"

###Biome 4
Biome4 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/PlotsBiome4Subset.csv")
GFBI_SumS <- as.data.frame(Biome4 %>% group_by(plot_id) %>% mutate(SumS=as.numeric(n_distinct(species_name)))) #Sum of species per plot
GFBI_atleast2Sp <- GFBI_SumS[which(GFBI_SumS$SumS >= 6),] #Erase monocultures
GFBI_atleast2Sp$NrInd <- 1 #Add Nr of individuals
GFBI_NrInd <- GFBI_atleast2Sp %>% group_by(Biome, plot_id, species_name) %>% summarise(NrIndSum=sum(NrInd)) %>% as.data.frame() #Calculate nr of individuals per species

GFBI_Wider <- GFBI_NrInd %>% mutate(row = plot_id) %>% tidyr::pivot_wider(names_from = species_name, values_from = NrIndSum) %>% dplyr::select(-row) %>% as.data.frame()
GFBI_Wider[is.na(GFBI_Wider)] <- 0 #Dim 10000 420=4.2 million
GFBI_Wider_sp <- GFBI_Wider %>% dplyr::select(-plot_id) #nr plots 10000 #nr species 419
# 
# # Randomization4_1 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20)
# # RandomizationBiome4_1 <- Randomization4_1$perm 
# # fwrite(RandomizationBiome4_1, file = "RandomizationBiome4_1.csv") 
# # 
# # Randomization4_2 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20)
# # RandomizationBiome4_2 <- Randomization4_2$perm 
# # fwrite(RandomizationBiome4_2, file = "RandomizationBiome4_2.csv") 
# # 
# # Randomization4_3 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20)
# # RandomizationBiome4_3 <- Randomization4_3$perm 
# # fwrite(RandomizationBiome4_3, file = "RandomizationBiome4_3.csv") 
# # 
# # Randomization4_4 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20)
# # RandomizationBiome4_4 <- Randomization4_4$perm 
# # fwrite(RandomizationBiome4_4, file = "RandomizationBiome4_4.csv") 
# # 
# # Randomization4_5 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20)
# # RandomizationBiome4_5 <- Randomization4_5$perm 
# # fwrite(RandomizationBiome4_5, file = "RandomizationBiome4_5.csv") 
# 
# RandomizationBiome4_1 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome4_1.csv")
# colnames(RandomizationBiome4_1) <- c(paste0("Random", 1:20)) #Rename columns
# 
# RandomizationBiome4_2 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome4_2.csv")
# colnames(RandomizationBiome4_2) <- c(paste0("Random", 21:40)) #Rename columns
# 
# RandomizationBiome4_3 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome4_3.csv")
# colnames(RandomizationBiome4_3) <- c(paste0("Random", 41:60)) #Rename columns
# 
# RandomizationBiome4_4 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome4_4.csv")
# colnames(RandomizationBiome4_4) <- c(paste0("Random", 61:80)) #Rename columns
# 
# RandomizationBiome4_5 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome4_5.csv")
# colnames(RandomizationBiome4_5) <- c(paste0("Random", 81:100)) #Rename columns
# 
# RandomizationBiome4 <- cbind(RandomizationBiome4_1, RandomizationBiome4_2, RandomizationBiome4_3, RandomizationBiome4_4, RandomizationBiome4_5)
# 
# RandBiome4 <- mutate_all(RandomizationBiome4, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
# Sp_names <- colnames(GFBI_Wider_sp)
# RandBiome4_Sp <- RandBiome4 %>% mutate(species_name = paste(rep(Sp_names, times = 10000))) #Add species names
# 
# Plot_id <- GFBI_Wider$plot_id
# RandBiome4_Plot <- RandBiome4_Sp %>% mutate(plot_id = paste(rep(Plot_id, each = 419))) #Add plot nr
# 
# RandBiome4_Plot_longer <- RandBiome4_Plot %>% tidyr::pivot_longer(!species_name & !plot_id, names_to = "randomization", values_to = "NrIndSum") %>% as.data.frame() #Longer dataframe
# RandBiome4_Plot_longer$Biome <- "Biome4"
# 
# fwrite(RandBiome4_Plot_longer, file = "RandBiome4_Plot_longer.csv") 
RandBiome4_Plot_longer <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandBiome4_Plot_longer.csv")

######Calculate dominant & rare species
RandBiome4_Plot_compl <- RandBiome4_Plot_longer[which(RandBiome4_Plot_longer$NrIndSum > 0),] #remove species with zero observations
rm(RandBiome4_Plot_longer)

RandBiome4_Plot_compl$NrInd <- RandBiome4_Plot_compl$NrIndSum

GFBI_Plot <- RandBiome4_Plot_compl %>% group_by(Biome, plot_id, randomization) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                        PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, randomization, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>% as.data.frame()
rm(RandBiome4_Plot_compl, GFBI_Plot)

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, randomization, plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_Div20 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 20),] #700 plots, 0.11%
GFBI_Div6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS < 20 & GFBI_MeanIndFilter$SumS >= 6),] #144592 plots, 45%

GFBI_Div20Dom <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
GFBI_Div20Dom$DominanceCategory <- "dominant"
GFBI_Div20Rare <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
GFBI_Div20Rare$DominanceCategory <- "rare"

GFBI_Div6Dom <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(n = 2) #takes top 2 species
GFBI_Div6Dom$DominanceCategory <- "dominant"
GFBI_Div6Rare <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(n = 2) #takes bottom 2 species
GFBI_Div6Rare$DominanceCategory <- "rare"

GFBI_DivDR <- rbind(GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6Dom, GFBI_Div6Rare)
GFBI_DivDR <- subset(GFBI_DivDR, select = c("plot_id", "species_name", "DominanceCategory", "PercPerSpecies")) %>% as.data.frame()

GFBI_PlotMore6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 6),]
PlotDominantRare <- merge(x = GFBI_PlotMore6, y = GFBI_DivDR, by = c("plot_id", "species_name"), all.x = TRUE)
PlotDominantRare$DominanceCategory <- replace(PlotDominantRare$DominanceCategory, is.na(PlotDominantRare$DominanceCategory), "intermediate")
PlotDominantRare <- as.data.frame(PlotDominantRare)

GFBI_Biome4DomRare <- PlotDominantRare[which(PlotDominantRare$DominanceCategory == "rare" | PlotDominantRare$DominanceCategory == "dominant"),]  
DominantRare_Plot <- GFBI_Biome4DomRare %>% dplyr::select(randomization, plot_id, species_name, DominanceCategory)
rm(GFBI_Div20, GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6, GFBI_Div6Dom, GFBI_Div6Rare, GFBI_DivDR, GFBI_MeanInd, GFBI_MeanIndFilter, GFBI_PlotMore6) #keep "DominantRare_Plot", "GFBI_Biome4DomRare"

#######Match species with trait data, average trait value by biome
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, WoodDensity, LeafN, RootDepth, SeedMass))
DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")
rm(Traits)

GFBI_traits <- left_join(DominantRare_Plot, Traits_Select) 
GFBI_traits_biome <- GFBI_traits %>% group_by(Biome, species_name) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
GFBI_traits_Biome4 <- GFBI_traits_biome[which(GFBI_traits_biome$Biome==4),]

GFBI_Biome4DRtraits <- left_join(GFBI_Biome4DomRare, GFBI_traits_Biome4, by="species_name") 

#####Calculate dominant and rare traits in different ways
GFBI_Biome4DRtraits <- GFBI_Biome4DRtraits %>% group_by(plot_id, randomization) %>% filter(n_distinct(DominanceCategory)==2)
Plot_SpTraitsLog <- GFBI_Biome4DRtraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
#Plot_TraitsScaled <- Plot_SpTraitsLog %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values

Plot_TraitsDRMedian <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), median, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMedian$Category <- "Median"
Plot_TraitsDRMean <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMean$Category <- "Mean"
Plot_TraitsDRInter <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), IQR, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRInter$Category <- "Inter"

PlotBiome4 <- rbind(Plot_TraitsDRMedian, Plot_TraitsDRMean, Plot_TraitsDRInter)
PlotBiome4$Categories <- paste(PlotBiome4$Category,PlotBiome4$DominanceCategory)
Height_plot_Biome4 <- ggplot(PlotBiome4, aes(x = Height, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Height") + theme_classic() + theme(legend.position = "none")
WoodDensity_plot_Biome4 <- ggplot(PlotBiome4, aes(x = WoodDensity, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Wood density") + theme_classic() + theme(legend.position = "none")
LeafN_plot_Biome4 <- ggplot(PlotBiome4, aes(x = LeafN, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Leaf N") + theme_classic() + theme(legend.position = "none")
RootDepth_plot_Biome4 <- ggplot(PlotBiome4, aes(x = RootDepth, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Root depth") + theme_classic() + theme(legend.position = "none")
SeedMass_plot_Biome4 <- ggplot(PlotBiome4, aes(x = SeedMass, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Seed mass") + theme_classic() + theme(legend.position = "none")

grid.arrange(Height_plot_Biome4, WoodDensity_plot_Biome4, LeafN_plot_Biome4, RootDepth_plot_Biome4, SeedMass_plot_Biome4, top = textGrob("Traits Biome 4",gp=gpar(fontsize=14)))

###Biome 5
Biome5 <- GFBI_NrInd[which(GFBI_NrInd$Biome == 5),] #Select only biome 5
Biome5 <- Biome5 %>% dplyr:: select(-Biome) %>% as.data.frame()

GFBI_Wider <- Biome5 %>% mutate(row = plot_id) %>% tidyr::pivot_wider(names_from = species_name, values_from = NrIndSum) %>% dplyr::select(-row) %>% as.data.frame()
GFBI_Wider[is.na(GFBI_Wider)] <- 0 #Dim 9060-312=2.8 million
GFBI_Wider_sp <- GFBI_Wider %>% dplyr::select(-plot_id) #nr plots 9060 #nr species 311
# 
# # Randomization5_1 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20) #1
# # RandomizationBiome5 <- Randomization5_1$perm 
# # fwrite(RandomizationBiome5, file = "RandomizationBiome5.csv") 
# # 
# # Randomization5_2 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20) #2
# # RandomizationBiome5_2 <- Randomization5_2$perm 
# # fwrite(RandomizationBiome5_2, file = "RandomizationBiome5_2.csv") #Not yet performed
# # 
# # Randomization5_3 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20) #3
# # RandomizationBiome5_3 <- Randomization5_3$perm 
# # fwrite(RandomizationBiome5_3, file = "RandomizationBiome5_3.csv") #Not yet performed
# # 
# # Randomization5_4 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20) #4
# # RandomizationBiome5_4 <- Randomization5_4$perm 
# # fwrite(RandomizationBiome5_4, file = "RandomizationBiome5_4.csv") #Not yet performed
# # 
# # Randomization5_5 <- permatswap(GFBI_Wider_sp, "quasiswap", times=20) #5
# # RandomizationBiome5_5 <- Randomization5_5$perm 
# # fwrite(RandomizationBiome5_5, file = "RandomizationBiome5_5.csv") #Not yet performed
# 
# RandomizationBiome5_1 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome5.csv")
# colnames(RandomizationBiome5_1) <- c(paste0("Random", 1:20)) #Rename columns
# 
# RandomizationBiome5_2 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome5_2.csv")
# colnames(RandomizationBiome5_2) <- c(paste0("Random", 21:40)) #Rename columns
# 
# RandomizationBiome5_3 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome5_3.csv")
# colnames(RandomizationBiome5_3) <- c(paste0("Random", 41:60)) #Rename columns
# 
# RandomizationBiome5_4 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome5_4.csv")
# colnames(RandomizationBiome5_4) <- c(paste0("Random", 61:80)) #Rename columns
# 
# RandomizationBiome5_5 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome5_5.csv")
# colnames(RandomizationBiome5_5) <- c(paste0("Random", 81:100)) #Rename columns
# 
# RandomizationBiome5 <- cbind(RandomizationBiome5_1, RandomizationBiome5_2, RandomizationBiome5_3, RandomizationBiome5_4, RandomizationBiome5_5)
# 
# RandBiome5 <- mutate_all(RandomizationBiome5, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
# Sp_names <- colnames(GFBI_Wider_sp)
# RandBiome5_Sp <- RandBiome5 %>% mutate(species_name = paste(rep(Sp_names, times = 9060))) #Add species names
# 
# Plot_id <- GFBI_Wider$plot_id
# RandBiome5_Plot <- RandBiome5_Sp %>% mutate(plot_id = paste(rep(Plot_id, each = 311))) #Add plot nr
# 
# RandBiome5_Plot_longer <- RandBiome5_Plot %>% tidyr::pivot_longer(!species_name & !plot_id, names_to = "randomization", values_to = "NrIndSum") %>% as.data.frame() #Longer dataframe
# RandBiome5_Plot_longer$Biome <- "Biome5"
# fwrite(RandBiome5_Plot_longer, file = "RandBiome5_Plot_longer.csv") 

RandBiome5_Plot_longer <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandBiome5_Plot_longer.csv")

######Calculate dominant & rare species
RandBiome5_Plot_compl <- RandBiome5_Plot_longer[which(RandBiome5_Plot_longer$NrIndSum > 0),] #remove species with zero observations
RandBiome5_Plot_compl$NrInd <- RandBiome5_Plot_compl$NrIndSum

GFBI_Plot <- RandBiome5_Plot_compl %>% group_by(Biome, plot_id, randomization) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                        PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, randomization, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>% as.data.frame()
rm(RandBiome5_Plot_longer, RandBiome5_Plot_compl)

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, randomization, plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_Div20 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 20),] #700 plots, 0.11%
GFBI_Div6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS < 20 & GFBI_MeanIndFilter$SumS >= 6),] #144592 plots, 45%

GFBI_Div20Dom <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
GFBI_Div20Dom$DominanceCategory <- "dominant"
GFBI_Div20Rare <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
GFBI_Div20Rare$DominanceCategory <- "rare"

GFBI_Div6Dom <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(n = 2) #takes top 2 species
GFBI_Div6Dom$DominanceCategory <- "dominant"
GFBI_Div6Rare <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(n = 2) #takes bottom 2 species
GFBI_Div6Rare$DominanceCategory <- "rare"

GFBI_DivDR <- rbind(GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6Dom, GFBI_Div6Rare)
GFBI_DivDR <- subset(GFBI_DivDR, select = c("plot_id", "species_name", "DominanceCategory", "PercPerSpecies")) %>% as.data.frame()

GFBI_PlotMore6 <- GFBI_Plot[which(GFBI_Plot$SumS >= 6),]
PlotDominantRare <- merge(x = GFBI_PlotMore6, y = GFBI_DivDR, by = c("plot_id", "species_name"), all.x = TRUE)
PlotDominantRare$DominanceCategory <- replace(PlotDominantRare$DominanceCategory, is.na(PlotDominantRare$DominanceCategory), "intermediate")
PlotDominantRare <- as.data.frame(PlotDominantRare)

GFBI_Biome5DomRare <- PlotDominantRare[which(PlotDominantRare$DominanceCategory == "rare" | PlotDominantRare$DominanceCategory == "dominant"),]  
DominantRare_Plot <- GFBI_Biome5DomRare %>% dplyr::select(randomization, plot_id, species_name, DominanceCategory)
rm(GFBI_Div20, GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6, GFBI_Div6Dom, GFBI_Div6Rare, GFBI_DivDR, GFBI_MeanInd, GFBI_MeanIndFilter, GFBI_PlotMore6) #keep "DominantRare_Plot", "GFBI_Biome5DomRare"
rm(Biome5, GFBI_atleast2Sp, GFBI_NrInd, GFBI_Plot, GFBI_SpeciesCheck, GFBI_SumS, GFBI_Wider, GFBI_Wider_sp, PlotDominantRare)

#######Match species with trait data, average trait value by biome
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, WoodDensity, LeafN, RootDepth, SeedMass))
DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")
rm(Traits)

GFBI_traits <- left_join(DominantRare_Plot, Traits_Select) 
GFBI_traits_biome <- GFBI_traits %>% group_by(Biome, species_name) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
GFBI_traits_Biome5 <- GFBI_traits_biome[which(GFBI_traits_biome$Biome==5),]

GFBI_Biome5DRtraits <- left_join(GFBI_Biome5DomRare, GFBI_traits_Biome5, by="species_name") 

#####Calculate dominant and rare traits in different ways
GFBI_Biome5DRtraits <- GFBI_Biome5DRtraits %>% group_by(plot_id, randomization) %>% filter(n_distinct(DominanceCategory)==2)
Plot_SpTraitsLog <- GFBI_Biome5DRtraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
#Plot_TraitsScaled <- Plot_SpTraitsLog %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values

Plot_TraitsDRMedian <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), median, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMedian$Category <- "Median"
Plot_TraitsDRMean <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMean$Category <- "Mean"
Plot_TraitsDRInter <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), IQR, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRInter$Category <- "Inter"

PlotBiome5 <- rbind(Plot_TraitsDRMedian, Plot_TraitsDRMean, Plot_TraitsDRInter)
PlotBiome5$Categories <- paste(PlotBiome5$Category,PlotBiome5$DominanceCategory)
Height_plot_Biome5 <- ggplot(PlotBiome5, aes(x = Height, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Height") + theme_classic() + theme(legend.position = "none")
WoodDensity_plot_Biome5 <- ggplot(PlotBiome5, aes(x = WoodDensity, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Wood density") + theme_classic() + theme(legend.position = "none")
LeafN_plot_Biome5 <- ggplot(PlotBiome5, aes(x = LeafN, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Leaf N") + theme_classic() + theme(legend.position = "none")
RootDepth_plot_Biome5 <- ggplot(PlotBiome5, aes(x = RootDepth, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Root depth") + theme_classic() + theme(legend.position = "none")
SeedMass_plot_Biome5 <- ggplot(PlotBiome5, aes(x = SeedMass, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Seed mass") + theme_classic() + theme(legend.position = "none")

grid.arrange(Height_plot_Biome5, WoodDensity_plot_Biome5, LeafN_plot_Biome5, RootDepth_plot_Biome5, SeedMass_plot_Biome5, top = textGrob("Traits Biome 5",gp=gpar(fontsize=14)))

###Biome 6
Biome6 <- GFBI_NrInd[which(GFBI_NrInd$Biome == 6),] #Select only biome 6
Biome6 <- Biome6 %>% dplyr:: select(-Biome) %>% as.data.frame()

GFBI_Wider <- Biome6 %>% mutate(row = plot_id) %>% tidyr::pivot_wider(names_from = species_name, values_from = NrIndSum) %>% dplyr::select(-row) %>% as.data.frame()
GFBI_Wider[is.na(GFBI_Wider)] <- 0 #Dim: 1733-48 = 83184
GFBI_Wider_sp <- GFBI_Wider %>% dplyr::select(-plot_id)

# RandomizationBiome6 <- permatswap(GFBI_Wider, "quasiswap", times=100)
# RandomizationBiome6 <- RandomizationBiome6$perm 
# fwrite(RandomizationBiome6, file = "RandomizationBiome6.csv")

RandomizationBiome6 <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/RandomizationBiome6.csv")
RandBiome6 <- mutate_all(RandomizationBiome6, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
colnames(RandBiome6) <- c(paste0("Random", 1:100)) #Rename columns

Sp_names <- colnames(GFBI_Wider_sp)
RandBiome6_Sp <- RandBiome6 %>% mutate(species_name = paste(rep(Sp_names, times = 1733))) #Add species names

Plot_id <- GFBI_Wider$plot_id
RandBiome6_Plot <- RandBiome6_Sp %>% mutate(plot_id = paste(rep(Plot_id, each = 48))) #Add plot nr

RandBiome6_Plot_longer <- RandBiome6_Plot %>% tidyr::pivot_longer(!species_name & !plot_id, names_to = "randomization", values_to = "NrIndSum") %>% as.data.frame() #Longer dataframe
RandBiome6_Plot_longer$Biome <- "Biome6"

######Calculate dominant & rare species
RandBiome6_Plot_compl <- RandBiome6_Plot_longer[which(RandBiome6_Plot_longer$NrIndSum > 0),] #remove species with zero observations
RandBiome6_Plot_compl$NrInd <- RandBiome6_Plot_compl$NrIndSum

GFBI_Plot <- RandBiome6_Plot_compl %>% group_by(Biome, plot_id, randomization) %>% mutate(SumS=n_distinct(species_name), SumIndPlot=sum(NrInd),
                        PercInd=(NrInd/SumIndPlot)*100, SumPercInd=sum(PercInd)) %>% as.data.frame() #Nr of Species, Nr Ind perc and sum per plot

GFBI_MeanInd <- GFBI_Plot %>% group_by(Biome, plot_id, randomization, species_name) %>% mutate(PercPerSpecies=sum(PercInd), SumS=mean(SumS)) %>%
  slice(1) %>% as.data.frame()

###Select plots, with only 10% or less rare species
GFBI_MeanIndFilter <- GFBI_MeanInd %>% group_by(Biome, randomization, plot_id) %>% filter(any(PercPerSpecies <= 10)) #Filter out plots without rare species (all species contribute more than 10%)

GFBI_Div20 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS >= 20),] #700 plots, 0.11%
GFBI_Div6 <- GFBI_MeanIndFilter[which(GFBI_MeanIndFilter$SumS < 20 & GFBI_MeanIndFilter$SumS >= 6),] #144592 plots, 45%

GFBI_Div20Dom <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(prop=0.1) #Sorts from large to small and takes top 10%
GFBI_Div20Dom$DominanceCategory <- "dominant"
GFBI_Div20Rare <- GFBI_Div20 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(prop=0.1) #Sorts from large to small and takes bottom 10%
GFBI_Div20Rare$DominanceCategory <- "rare"

GFBI_Div6Dom <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_head(n = 2) #takes top 2 species
GFBI_Div6Dom$DominanceCategory <- "dominant"
GFBI_Div6Rare <- GFBI_Div6 %>% group_by(plot_id) %>% arrange(desc(PercPerSpecies)) %>% slice_tail(n = 2) #takes bottom 2 species
GFBI_Div6Rare$DominanceCategory <- "rare"

GFBI_DivDR <- rbind(GFBI_Div20Dom, GFBI_Div20Rare, GFBI_Div6Dom, GFBI_Div6Rare)
GFBI_DivDR <- subset(GFBI_DivDR, select = c("plot_id", "species_name", "DominanceCategory", "PercPerSpecies")) %>% as.data.frame()

GFBI_PlotMore6 <- GFBI_Plot[which(GFBI_Plot$SumS >= 6),]
PlotDominantRare <- merge(x = GFBI_PlotMore6, y = GFBI_DivDR, by = c("plot_id", "species_name"), all.x = TRUE)
PlotDominantRare$DominanceCategory <- replace(PlotDominantRare$DominanceCategory, is.na(PlotDominantRare$DominanceCategory), "intermediate")
PlotDominantRare <- as.data.frame(PlotDominantRare)

GFBI_Biome6DomRare <- PlotDominantRare[which(PlotDominantRare$DominanceCategory == "rare" | PlotDominantRare$DominanceCategory == "dominant"),]  
DominantRare_Plot <- GFBI_Biome6DomRare %>% dplyr::select(randomization, plot_id, species_name, DominanceCategory)

#######Match species with trait data, average trait value by biome
Traits <- read_feather("~/Documents/PhD projects/2nd Chapter - Trait diversity/GFBI_fixed_plots_ALL_TRAITS_7_21.feather") 

setnames(Traits, old = c("trait1055","trait1229","trait14","trait144", "trait145", "trait146", "trait15", "trait185", "trait21", "trait24", "trait26",  
                         "trait270", "trait281", "trait3106", "trait3110", "trait3117", "trait3120", "trait324", "trait4", "trait413", "trait44",                                     "trait45","trait46", "trait48", "trait54", "trait56", "trait6", "trait773", "trait80", "trait9"), 
         new = c("RootCN", "WoodN", "LeafN", "LeafLength", "LeafWidth", "LeafCN", "LeafP", "VcmaxDryMass", "StemDiameter", "BarkThickness", "SeedMass", 
                 "JmaxDryMass", "StemConduitDiameter", "Height", "LeafArea", "SLA", "LeafWaterMass", "CrownDiameter", "WoodDensity", "LeafChlorophyll",                      "LeafK", "StomatalConductance", "LeafThickness", "LeafDensity", "LeafRespRate", "LeafNP", "RootDepth", "CrownHeight", "RootN",                              "RootShootRatio"))

Traits_Select <- subset(Traits, select=c(obs_id, Height, WoodDensity, LeafN, RootDepth, SeedMass))
DominantRare_Plot <- fread("~/Documents/PhD projects/2nd Chapter - Trait diversity/DominantRare_Plot_8-2021.csv")
rm(Traits)

GFBI_traits <- left_join(DominantRare_Plot, Traits_Select) 
GFBI_traits_biome <- GFBI_traits %>% group_by(Biome, species_name) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
GFBI_traits_biome6 <- GFBI_traits_biome[which(GFBI_traits_biome$Biome==6),]

GFBI_Biome6DRtraits <- left_join(GFBI_Biome6DomRare, GFBI_traits_biome6, by="species_name") 

#####Calculate dominant and rare traits in different ways
GFBI_Biome6DRtraits <- GFBI_Biome6DRtraits %>% group_by(plot_id, randomization) %>% filter(n_distinct(DominanceCategory)==2)
Plot_SpTraitsLog <- GFBI_Biome6DRtraits %>% mutate_at(vars(Height:SeedMass), log) #First log traits to normalise outliers
#Plot_TraitsScaled <- Plot_SpTraitsLog %>% mutate_at(vars(Height:SeedMass), scale) %>% as.data.frame() #Standardise trait values

Plot_TraitsDRMedian <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), median, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMedian$Category <- "Median"
Plot_TraitsDRMean <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), mean, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRMean$Category <- "Mean"
Plot_TraitsDRInter <- Plot_SpTraitsLog %>% group_by(plot_id, randomization, DominanceCategory) %>% dplyr::summarise_at(vars(Height:SeedMass), IQR, na.rm = TRUE) %>% as.data.frame()
Plot_TraitsDRInter$Category <- "Inter"

PlotBiome6 <- rbind(Plot_TraitsDRMedian, Plot_TraitsDRMean, Plot_TraitsDRInter)
PlotBiome6$Categories <- paste(PlotBiome6$Category,PlotBiome6$DominanceCategory)
Height_plot_Biome6 <- ggplot(PlotBiome6, aes(x = Height, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Height") + theme_classic() + theme(legend.position = "none")
WoodDensity_plot_Biome6 <- ggplot(PlotBiome6, aes(x = WoodDensity, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Wood density") + theme_classic() + theme(legend.position = "none")
LeafN_plot_Biome6 <- ggplot(PlotBiome6, aes(x = LeafN, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Leaf N") + theme_classic() + theme(legend.position = "none")
RootDepth_plot_Biome6 <- ggplot(PlotBiome6, aes(x = RootDepth, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Root depth") + theme_classic() + theme(legend.position = "none")
SeedMass_plot_Biome6 <- ggplot(PlotBiome6, aes(x = SeedMass, color=Categories, fill=Categories)) + geom_density(alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#f4acfc", "#017003", "#7cf4fc")) + ylab("Density") +xlab("Seed mass") + theme_classic() + theme(legend.position = "none")

grid.arrange(Height_plot_Biome6, WoodDensity_plot_Biome6, LeafN_plot_Biome6, RootDepth_plot_Biome6, SeedMass_plot_Biome6, top = textGrob("Traits Biome 6",gp=gpar(fontsize=14)))

# PlotBiome6_rare <- PlotBiome6[which(PlotBiome6$DominanceCategory == "rare"),]
# Height_plot_rare <- ggplot(PlotBiome6_rare, aes(x = Height, color=Categories, fill=Categories)) + geom_histogram(bins=100, alpha=0.2, position = "identity") + scale_fill_manual(values=c("#f7c602", "#755e02", "#0a0275", "#6e64fa", "#029ba6", "#7cf4fc")) + scale_color_manual(values=c("#f7c602", "#755e02", "#0a0275", "#6e64fa", "#029ba6", "#7cf4fc")) + ylab("Frequency") +xlab("Height") + theme_classic() + theme(legend.position = "none")
# 
# PlotBiome6_dom <- PlotBiome6[which(PlotBiome6$DominanceCategory == "dominant"),]
# Height_plot_dom <- ggplot(PlotBiome6_dom, aes(x = Height, fill=Category)) + geom_histogram(bins=100) + ylab("Frequency") + xlab("Height") + theme_classic() + theme(legend.position = "none")

```